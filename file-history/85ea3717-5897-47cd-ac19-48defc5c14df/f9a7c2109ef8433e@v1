# Wazuh Rules as Code (RaC)

This repository manages custom Wazuh detection rules and decoders using a local-first deployment approach with **AI-powered rule development and automated testing**.

## Quick Start

### Automated Rule Development with AI

```bash
# Create and test rules for a threat using AI
claude-code --task "Create and test Wazuh detection rules for DeerStealer malware"
```

The AI agent will:
1. Research threat intelligence
2. Create detection rules
3. Generate synthetic test logs
4. Validate rules work correctly
5. Prepare for deployment

See [`docs/QUICK_START.md`](./docs/QUICK_START.md) for detailed instructions.

## What's New

### Synthetic Log Generator MCP Server
- **Generates** synthetic logs based on threat intelligence
- **Tests** Wazuh rules against synthetic logs
- **Validates** rule matching logic
- **Enables** automated rule development by AI agents

See [`docs/SYNTHETIC_LOG_GENERATOR.md`](./docs/SYNTHETIC_LOG_GENERATOR.md) for API documentation.

## Workflow

### Automated (Recommended)
1. Spawn AI agent with rule development task
2. Agent researches threats
3. Agent creates and tests rules
4. Agent reports results
5. Review and deploy

### Manual
1. Develop rules locally in `rules/` and `decoders/`
2. Generate test logs with MCP server
3. Validate using `./scripts/validate.sh`
4. Deploy using `./scripts/deploy.sh`
5. Push to GitHub after successful deployment

## Directory Structure
- `mcp_servers/` - MCP servers (synthetic-log-generator, etc)
- `rules/` - Custom detection rules (100000-120000 ID range)
- `decoders/` - Custom decoders
- `scripts/` - Deployment and validation scripts
- `docs/` - Comprehensive documentation

## Documentation

| Document | Purpose |
|----------|---------|
| [`docs/QUICK_START.md`](./docs/QUICK_START.md) | 5-minute setup and common tasks |
| [`docs/ARCHITECTURE.md`](./docs/ARCHITECTURE.md) | System design and data flow |
| [`docs/SYNTHETIC_LOG_GENERATOR.md`](./docs/SYNTHETIC_LOG_GENERATOR.md) | MCP server API reference |
| [`docs/MCP_SETUP.md`](./docs/MCP_SETUP.md) | Installation and troubleshooting |
| [`docs/IMPLEMENTATION_SUMMARY.md`](./docs/IMPLEMENTATION_SUMMARY.md) | What was built and how to use it |

## Setup

```bash
# Install dependencies
pip install mcp

# Configure MCP server
mkdir -p .claude
cat > .claude/claude.json << 'EOF'
{
  "mcpServers": {
    "synthetic-log-generator": {
      "command": "python3",
      "args": ["/home/stanner/wazuh-rac/mcp_servers/synthetic_log_generator.py"]
    }
  }
}
EOF
```

See [`docs/MCP_SETUP.md`](./docs/MCP_SETUP.md) for detailed setup instructions.

## Examples

### Example 1: Create Rules for DeerStealer Malware
```bash
claude-code --task "Create Wazuh detection rules for DeerStealer. Research the malware, create rules for each MITRE technique, generate synthetic logs, and validate rules work correctly."
```

### Example 2: Validate Existing Rules
```bash
claude-code --task "Validate all rules in /home/stanner/wazuh-rac/rules/. For each rule, generate synthetic logs and validate the rule triggers correctly. Report any failing rules."
```

### Example 3: Test SSH Brute Force Rules
```bash
claude-code --task "Create and test Wazuh rules for SSH brute force attacks. Create rules for failed attempts, multiple failures, and successful login after failures."
```

## How It Works

The synthetic-log-generator MCP server:
1. **Parses** Wazuh XML rules
2. **Extracts** matching conditions
3. **Generates** synthetic logs that match those conditions
4. **Validates** whether generated logs trigger the rule
5. **Reports** pass/fail status with detailed results

This enables AI agents to develop, test, and validate rules **automatically**.

## Integration

The system integrates with:
- **threat-intel-researcher**: Fetches threat intelligence
- **Detection Engineer Agent**: AI that creates and tests rules
- **Wazuh**: Deployment target for validated rules

## Performance

- Log generation: <100ms per log
- Validation: <1s per rule
- Startup: <500ms
- Memory: <50MB typical

## Contributing

Follow the standard workflow:
1. Develop rules locally
2. Test with synthetic logs
3. Validate rules pass tests
4. Deploy to Wazuh
5. Push changes to git

## License

[Your License Here]

## Support

- Quick questions? See [`docs/QUICK_START.md`](./docs/QUICK_START.md)
- API questions? See [`docs/SYNTHETIC_LOG_GENERATOR.md`](./docs/SYNTHETIC_LOG_GENERATOR.md)
- Setup issues? See [`docs/MCP_SETUP.md`](./docs/MCP_SETUP.md)
- Design details? See [`docs/ARCHITECTURE.md`](./docs/ARCHITECTURE.md)
