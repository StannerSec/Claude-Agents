# CDSA Blue Team Agent - Complete Solution

A comprehensive AI-powered blue team agent with MCP (Model Context Protocol) integration for Windows incident response, digital forensics, and CDSA exam preparation.

## What This Is

A production-ready blue team agent that combines:
- **Claude AI**: Intelligent analysis and guidance
- **MCP Integration**: Direct access to forensic tools
- **ERIC Tools**: Windows artifact analysis (RECmd, EvtxECmd, MFTECmd, PECmd, JLECmd, LECmd, SBECmd)
- **Malware Analysis**: Yara scanning and Chainsaw threat hunting
- **Interactive CLI**: Conversational investigation interface

Perfect for:
- Windows incident response
- Digital forensic investigations
- Insider threat analysis
- Malware incident response
- CDSA exam preparation
- Blue team training

## Architecture Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Claude AI (LLM)                      ‚îÇ
‚îÇ    - Analysis Engine                    ‚îÇ
‚îÇ    - Guidance & Recommendations         ‚îÇ
‚îÇ    - Investigation Orchestration        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚îÇ (MCP Protocol)
               ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  MCP Server     ‚îÇ
        ‚îÇ  - Tool Bridge  ‚îÇ
        ‚îÇ  - Execution    ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ       ‚îÇ                ‚îÇ              ‚îÇ          ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îê
   ‚îÇERIC   ‚îÇ ‚îÇYara  ‚îÇ ‚îÇChainsaw   ‚îÇ ‚îÇRegistry   ‚îÇ ‚îÇEvent  ‚îÇ
   ‚îÇTools  ‚îÇ ‚îÇScan  ‚îÇ ‚îÇThreat Hunt‚îÇ ‚îÇAnalysis   ‚îÇ ‚îÇLogs   ‚îÇ
   ‚îÇ       ‚îÇ ‚îÇ      ‚îÇ ‚îÇ           ‚îÇ ‚îÇ           ‚îÇ ‚îÇ       ‚îÇ
   ‚îÇRECmd  ‚îÇ ‚îÇ      ‚îÇ ‚îÇSigma Rules‚îÇ ‚îÇPersistence‚îÇ ‚îÇTimeline
   ‚îÇMFTCmd ‚îÇ ‚îÇ      ‚îÇ ‚îÇ           ‚îÇ ‚îÇDetection  ‚îÇ ‚îÇAudit  ‚îÇ
   ‚îÇPECmd  ‚îÇ ‚îÇ      ‚îÇ ‚îÇ           ‚îÇ ‚îÇ           ‚îÇ ‚îÇ       ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Quick Start

### 1. Prerequisites

```bash
# Python 3.10+
python3 --version

# Set API key
export ANTHROPIC_API_KEY="your-api-key"

# Set ERIC tools path (if installed elsewhere)
export ERIC_TOOLS_PATH="/path/to/ERIC"
```

### 2. Install

```bash
# Clone or download the files
cd /home/stanner

# Install dependencies
pip install -r requirements.txt

# Run quick start
bash quick_start.sh
```

### 3. Run Agent

```bash
# Interactive mode (recommended)
python3 blue_team_agent.py

# Single query mode
python3 blue_team_agent.py "Analyze this Windows event log for lateral movement"

# See help
python3 blue_team_agent.py
# Then type: help
```

## Files Included

| File | Purpose |
|------|---------|
| `blue_team_agent.py` | Main interactive agent application |
| `eric_tools_mcp_server.py` | MCP server for forensic tools |
| `claude_code_mcp_config.json` | MCP configuration for Claude Code |
| `SETUP_GUIDE.md` | Detailed installation and configuration |
| `CDSA_TEST_SCENARIOS.md` | 5 realistic incident scenarios |
| `requirements.txt` | Python dependencies |
| `quick_start.sh` | Automated setup script |
| `README.md` | This file |

## Available Tools

### Registry & Event Log Analysis
- **RECmd**: Registry hive analysis (SYSTEM, SOFTWARE, NTUSER.DAT, SAM, SECURITY)
- **EvtxECmd**: Windows event log parsing and timeline extraction
- **SBECmd**: ShellBags analysis for folder access history

### Filesystem Forensics
- **MFTECmd**: $MFT analysis for file timeline reconstruction
- **JLECmd**: Jump Lists for recent file access
- **LECmd**: Shortcut (.lnk) file analysis

### Program Execution
- **PECmd**: Prefetch file analysis for program execution timeline

### Threat Hunting & Malware Analysis
- **Yara**: Malware signature scanning
- **Chainsaw**: Windows event log threat hunting with Sigma rules

## Usage Examples

### Example 1: Incident Response

```bash
$ python3 blue_team_agent.py

[Investigation] > We detected suspicious activity on a Windows server.
Can you help me investigate?

[Agent] I'd be happy to help. Let me gather some information first:

1. What type of suspicious activity was detected?
2. Approximately when did it occur?
3. Which Windows system is affected?
4. Do you have access to the following artifacts?
   - Security event log (Security.evtx)
   - System event log (System.evtx)
   - Registry hives (SYSTEM, SOFTWARE, NTUSER.DAT)
   - Prefetch files (C:\Windows\Prefetch\)

Once you provide these, I can help you:
- Build a timeline of events
- Identify malware execution
- Detect persistence mechanisms
- Correlate findings across artifacts
```

### Example 2: Malware Analysis

```
[Investigation] > Scan this suspected malware file

[Agent] I'll scan the file with Yara. First, I need:
1. Full path to the file
2. Which Yara rules to use?
   - Community rules (YARA-RULES)
   - Custom rules for specific malware families
   - Generic suspicious behavior rules

Then I can:
- Identify malware family
- Show matching signatures
- Recommend next analysis steps
```

### Example 3: Timeline Reconstruction

```
[Investigation] > Build a timeline of user activity last week

[Agent] I'll analyze the user's artifacts to reconstruct their activity:

1. First, I'll check Jump Lists for recent files
2. Then review ShellBags for folder navigation
3. Analyze Prefetch for program execution
4. Review event logs for logon/logoff
5. Correlate all findings into a timeline

Which user account should I investigate?
```

## CDSA Exam Preparation

Use this agent to prepare for the Certified Data Security Administrator (CDSA) exam:

### Study Mode
```
[Investigation] > help
Shows detailed explanation of all available tools and techniques
```

### Practice Mode
```
[Investigation] > Give me a Windows forensics scenario to practice
Agent presents realistic incident scenario with artifacts
```

### Knowledge Testing
```
[Investigation] > Explain Windows event IDs relevant to incident response
Agent provides comprehensive technical explanation
```

### Exam Simulation
```
[Investigation] > Run scenario 5 from CDSA_TEST_SCENARIOS.md
Agent presents exam-style investigation with time constraints
```

## Supported Tools

### Core Forensic Tools (ERIC Suite)
```
‚úì RECmd        - Registry analysis
‚úì EvtxECmd     - Event log parsing
‚úì MFTECmd      - NTFS filesystem timeline
‚úì PECmd        - Prefetch analysis
‚úì JLECmd       - Jump List extraction
‚úì LECmd        - Shortcut file analysis
‚úì SBECmd       - ShellBags analysis
```

### Threat Analysis Tools
```
‚úì Yara         - Malware signature scanning
‚úì Chainsaw     - Event log threat hunting
```

### Future Integrations (Ready)
```
‚ö° VirusTotal  - Malware intelligence
‚ö° Volatility  - Memory forensics
‚ö° Wazuh       - SIEM integration
```

## Configuration

### Environment Variables

```bash
# Required
export ANTHROPIC_API_KEY="your-api-key"

# Recommended
export ERIC_TOOLS_PATH="/opt/ERIC"        # Default: /opt/ERIC
export WORKING_DIR="/tmp/eric_analysis"    # Default: /tmp/eric_analysis
```

### MCP Server

The MCP server in `eric_tools_mcp_server.py`:
- Provides standardized interface to forensic tools
- Handles tool execution and output parsing
- Supports CSV/JSON output parsing
- Implements timeout protection
- Logs all operations

Configure in `claude_code_mcp_config.json`:
```json
{
  "mcpServers": {
    "eric-tools": {
      "command": "python3",
      "args": ["/home/stanner/eric_tools_mcp_server.py"],
      "env": {
        "ERIC_TOOLS_PATH": "/opt/ERIC",
        "WORKING_DIR": "/tmp/eric_analysis"
      }
    }
  }
}
```

## Investigation Workflow

### Typical Investigation Flow

```
1. INCIDENT TRIAGE
   ‚îú‚îÄ Understand scope
   ‚îú‚îÄ Identify affected systems
   ‚îî‚îÄ Establish timeline bounds

2. ARTIFACT COLLECTION
   ‚îú‚îÄ Event logs (Security, System, Application)
   ‚îú‚îÄ Registry hives (SYSTEM, SOFTWARE, NTUSER.DAT)
   ‚îú‚îÄ Filesystem evidence ($MFT)
   ‚îî‚îÄ User activity artifacts (Prefetch, Jump Lists)

3. ANALYSIS PHASE
   ‚îú‚îÄ Event log analysis ‚Üí Timeline extraction
   ‚îú‚îÄ Registry analysis ‚Üí Persistence detection
   ‚îú‚îÄ Filesystem analysis ‚Üí File activity patterns
   ‚îî‚îÄ User activity ‚Üí Behavior analysis

4. CORRELATION
   ‚îú‚îÄ Cross-artifact timeline
   ‚îú‚îÄ IOC identification
   ‚îú‚îÄ Attack pattern recognition
   ‚îî‚îÄ Impact assessment

5. REPORT & REMEDIATION
   ‚îú‚îÄ Comprehensive timeline
   ‚îú‚îÄ Findings documentation
   ‚îú‚îÄ Containment recommendations
   ‚îî‚îÄ Recovery planning
```

### Supported Scenarios

| Scenario | Primary Tools | Key Questions |
|----------|---------------|---------------|
| **Ransomware** | EvtxECmd, PECmd, $MFT | When? What programs? Persistence? |
| **Lateral Movement** | EvtxECmd, RECmd | Who? From where? Credentials? |
| **Data Exfiltration** | JLECmd, MFTECmd, Jump Lists | What files? When? By whom? |
| **Malware Infection** | Yara, PECmd, RECmd | Family? Persistence? Lateral movement? |
| **Insider Threat** | Jump Lists, ShellBags, $MFT | Files accessed? Timeline? Intent? |

## Troubleshooting

### Agent Won't Start
```bash
# Check API key
echo $ANTHROPIC_API_KEY

# Verify Python and dependencies
python3 --version
pip list | grep anthropic

# Test directly
python3 blue_team_agent.py "test"
```

### Tools Not Found
```bash
# Verify ERIC tools installed
ls -la /opt/ERIC/

# Check environment variable
echo $ERIC_TOOLS_PATH

# Update if needed
export ERIC_TOOLS_PATH="/correct/path"
```

### File Not Found Errors
```bash
# Use absolute paths
# ‚úó Wrong: /home/user/artifacts/event.evtx
# ‚úì Correct: /full/absolute/path/to/event.evtx

ls -la "/path/to/artifact"
```

### MCP Server Issues
```bash
# Test MCP server directly
python3 eric_tools_mcp_server.py

# Check logs
tail -f /tmp/eric_analysis/mcp_server.log
```

## Command Reference

### Interactive Commands

```
analyze         - Start forensic artifact analysis
hunt            - Run threat hunting on event logs
timeline        - Reconstruct timeline from artifacts
scan            - Scan for malware with Yara
help            - Show detailed tool documentation
exit            - Exit the agent
```

### Natural Language Examples

```
"Analyze this event log for lateral movement"
"Show me what programs executed yesterday"
"Did anyone access the finance folder?"
"Is there malware on this system?"
"Build a timeline of user activity"
"What persistence mechanisms are installed?"
"Scan these files for known malware"
```

## Performance Considerations

- **Event Logs**: Can handle logs with 100,000+ events
- **Registry Hives**: Processes multi-GB hive files
- **MFT Analysis**: Handles $MFT files with millions of entries
- **Tool Execution**: 5-minute timeout per tool execution
- **Output Limits**: Samples first 100 events for display (full data available)

## Security Considerations

‚úì **No external data transmission** - All analysis local
‚úì **Chain of custody** - Preserves original artifacts
‚úì **Read-only access** - No modifications to evidence
‚úì **API key management** - Secure environment variable handling
‚úì **Output sanitization** - Removes sensitive data from logs

## Advanced Usage

### Custom Tool Integration

Add new tools by extending `eric_tools_mcp_server.py`:

```python
def run_custom_tool(self, artifact_path: str) -> dict[str, Any]:
    """Your custom tool implementation"""
    cmd = ["tool_name", artifact_path]
    success, stdout, stderr = self._run_command(cmd)
    # Parse and return results
```

### Batch Processing

Process multiple artifacts:

```python
artifacts = [
    "/artifacts/Security.evtx",
    "/artifacts/System.evtx",
    "/artifacts/$MFT"
]

for artifact in artifacts:
    response = agent.chat(f"Analyze {artifact}")
    print(response)
```

### Integration with SIEM

Connect to Splunk, Elastic, or Wazuh:

```bash
# Update MCP config to add SIEM server
# Agent can then query live SIEM data while analyzing artifacts
```

## Learning Resources

### CDSA Exam Prep
- Study with 5 realistic scenarios (CDSA_TEST_SCENARIOS.md)
- Practice timeline reconstruction
- Learn forensic concepts interactively
- Get feedback on analysis methodology

### Windows Forensics
- https://ericzimmerman.github.io/ (ERIC Tools documentation)
- https://www.sans.org/white-papers/ (DFIR papers)
- https://dfir.training/ (Forensic training)

### Threat Hunting
- https://github.com/SigmaHQ/sigma (Sigma rules)
- https://github.com/WithSecureLabs/chainsaw (Chainsaw)

### Malware Analysis
- https://virustotal.github.io/yara/ (Yara documentation)
- https://www.malware-traffic-analysis.net/ (Real samples)

## Support & Issues

### Getting Help

1. **Within Agent**: Type `help` for detailed tool documentation
2. **Scenarios**: See `CDSA_TEST_SCENARIOS.md` for example investigations
3. **Setup**: Follow `SETUP_GUIDE.md` for installation help
4. **Tool Docs**: https://ericzimmerman.github.io/

### Common Issues

| Issue | Solution |
|-------|----------|
| "Tool not found" | Verify ERIC_TOOLS_PATH environment variable |
| "File not found" | Use absolute paths, verify file exists |
| "API key error" | Check ANTHROPIC_API_KEY is set |
| "MCP connection failed" | Ensure Python 3.10+ and mcp package installed |

## Next Steps

1. ‚úÖ **Install**: Follow SETUP_GUIDE.md
2. ‚úÖ **Configure**: Set environment variables
3. ‚úÖ **Test**: Run `python3 blue_team_agent.py`
4. ‚úÖ **Learn**: Type `help` in the agent
5. ‚úÖ **Practice**: Try scenarios from CDSA_TEST_SCENARIOS.md
6. ‚úÖ **Investigate**: Analyze your own artifacts

## License & Attribution

This project integrates:
- **Claude AI**: Anthropic
- **ERIC Tools**: Eric Zimmerman (https://ericzimmerman.github.io/)
- **Chainsaw**: WithSecure Labs (https://github.com/WithSecureLabs/chainsaw)
- **Yara**: VirusTotal (https://virustotal.github.io/yara/)
- **MCP Protocol**: Anthropic (https://modelcontextprotocol.io/)

## Contributing

Improvements welcome! Consider adding:
- Additional ERIC tool wrappers
- Custom Sigma rules
- Integration with other forensic tools
- Additional test scenarios
- Documentation improvements

## Disclaimer

This tool is for authorized security testing, incident response, and educational purposes only. Users are responsible for:
- Obtaining proper authorization
- Maintaining forensic integrity
- Following applicable laws and regulations
- Protecting sensitive data
- Documenting chain of custody

## Success Criteria - What You Can Do

After setup, you'll be able to:

‚úÖ Analyze Windows event logs interactively
‚úÖ Parse registry hives for forensic artifacts
‚úÖ Reconstruct filesystem timelines
‚úÖ Identify program execution patterns
‚úÖ Track user activity across artifacts
‚úÖ Scan for malware with Yara
‚úÖ Hunt for threats with Chainsaw
‚úÖ Build comprehensive incident timelines
‚úÖ Correlate findings across multiple sources
‚úÖ Practice real-world incident response
‚úÖ Prepare for CDSA exam scenarios
‚úÖ Get AI-powered analysis and guidance

## Questions?

Refer to:
- **Setup Issues**: SETUP_GUIDE.md
- **Investigation Examples**: CDSA_TEST_SCENARIOS.md
- **Tool Documentation**: Type `help` in agent
- **ERIC Tools**: https://ericzimmerman.github.io/
- **MCP Protocol**: https://modelcontextprotocol.io/

---

**Version**: 1.0
**Last Updated**: 2024
**Status**: Ready for CDSA Exam Preparation and Incident Response

Good luck with your blue team journey! üõ°Ô∏è
