<!--
  Wazuh Detection Rules for LummaC2 Stealer

  Threat Overview:
  - Browser credential and authentication data theft
  - Cryptocurrency wallet theft
  - C2 communication via POST /c2sock with multipart/form-data
  - Targets Chrome, Edge, Firefox, and other Chromium-based browsers
  - Session token and cookie exfiltration

  MITRE ATT&CK Mapping:
  - T1555.003: Credentials from Password Stores - Credentials from Web Browsers
  - T1539: Steal Web Session Cookie
  - T1005: Data from Local System
  - T1041: Exfiltration Over C2 Channel
  - T1071.001: Application Layer Protocol - Web Protocols
  - T1552.001: Unsecured Credentials - Credentials In Files

  Required Telemetry:
  - Sysmon Event ID 1 (Process Creation)
  - Sysmon Event ID 3 (Network Connection)
  - Sysmon Event ID 11 (File Creation)
  - File Integrity Monitoring for browser directories
  - Network traffic logs (HTTP POST monitoring)
-->

<group name="lummac2_stealer,infostealer,credential_theft,browser_theft,">

  <!-- Rule: LummaC2 - Chrome Login Data File Access -->
  <rule id="100042" level="12">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\\Google\\Chrome\\User Data\\.*\\Login Data$</field>
    <description>LummaC2 Stealer: Suspicious access to Chrome Login Data file (credential theft attempt)</description>
    <mitre>
      <id>T1555.003</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: LummaC2 - Chrome Cookies File Access -->
  <rule id="100043" level="11">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\\Google\\Chrome\\User Data\\.*\\Cookies$</field>
    <description>LummaC2 Stealer: Suspicious access to Chrome Cookies file (session theft attempt)</description>
    <mitre>
      <id>T1539</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: LummaC2 - Edge Login Data File Access -->
  <rule id="100044" level="12">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\\Microsoft\\Edge\\User Data\\.*\\Login Data$</field>
    <description>LummaC2 Stealer: Suspicious access to Edge Login Data file (credential theft attempt)</description>
    <mitre>
      <id>T1555.003</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: LummaC2 - Edge Cookies File Access -->
  <rule id="100045" level="11">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\\Microsoft\\Edge\\User Data\\.*\\Cookies$</field>
    <description>LummaC2 Stealer: Suspicious access to Edge Cookies file (session theft attempt)</description>
    <mitre>
      <id>T1539</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: LummaC2 - Firefox Login Data File Access -->
  <rule id="100046" level="12">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\\Mozilla\\Firefox\\Profiles\\.*\\logins\.json$</field>
    <description>LummaC2 Stealer: Suspicious access to Firefox logins.json file (credential theft attempt)</description>
    <mitre>
      <id>T1555.003</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: LummaC2 - Firefox Cookies File Access -->
  <rule id="100047" level="11">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\\Mozilla\\Firefox\\Profiles\\.*\\cookies\.sqlite$</field>
    <description>LummaC2 Stealer: Suspicious access to Firefox cookies.sqlite file (session theft attempt)</description>
    <mitre>
      <id>T1539</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: LummaC2 - Cryptocurrency Wallet File Access (Exodus) -->
  <rule id="100048" level="13">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\\Exodus\\.*\\wallet\.dat$</field>
    <description>LummaC2 Stealer: Suspicious access to Exodus cryptocurrency wallet file</description>
    <mitre>
      <id>T1005</id>
      <id>T1552.001</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: LummaC2 - Cryptocurrency Wallet File Access (Electrum) -->
  <rule id="100049" level="13">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\\Electrum\\wallets\\.*$</field>
    <description>LummaC2 Stealer: Suspicious access to Electrum cryptocurrency wallet file</description>
    <mitre>
      <id>T1005</id>
      <id>T1552.001</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: LummaC2 - MetaMask Extension Data Access -->
  <rule id="100050" level="13">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\\Extensions\\nkbihfbeogaeaoehlefnkodbefgpgknn\\</field>
    <description>LummaC2 Stealer: Suspicious access to MetaMask browser extension data</description>
    <mitre>
      <id>T1555.003</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: LummaC2 - C2 Communication Pattern (POST /c2sock) -->
  <rule id="100051" level="14">
    <if_sid>31101</if_sid>
    <match>POST /c2sock</match>
    <description>LummaC2 Stealer: Suspicious POST request to /c2sock endpoint (C2 communication)</description>
    <mitre>
      <id>T1041</id>
      <id>T1071.001</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: LummaC2 - C2 Communication with Multipart Form Data -->
  <rule id="100052" level="14">
    <if_sid>100051</if_sid>
    <match>Content-Type: multipart/form-data</match>
    <description>LummaC2 Stealer: C2 communication with multipart/form-data (data exfiltration)</description>
    <mitre>
      <id>T1041</id>
      <id>T1071.001</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: LummaC2 - Process Accessing Multiple Browser Credential Files -->
  <rule id="100053" level="14" frequency="3" timeframe="120">
    <if_matched_sid>100042</if_matched_sid>
    <same_field>win.eventdata.image</same_field>
    <description>LummaC2 Stealer: Process accessing multiple browser credential files (active credential harvesting - 3+ accesses in 120 seconds)</description>
    <mitre>
      <id>T1555.003</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: LummaC2 - SQLite Database Access Pattern (Browser Credential Theft) -->
  <rule id="100054" level="11">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)SELECT.*FROM.*logins|SELECT.*FROM.*cookies</field>
    <description>LummaC2 Stealer: SQLite query targeting browser credential databases</description>
    <mitre>
      <id>T1555.003</id>
      <id>T1539</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,</group>
  </rule>

  <!-- Rule: LummaC2 - Browser Profile Directory Enumeration -->
  <rule id="100055" level="9">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)dir.*(\\Google\\Chrome\\User Data|\\Microsoft\\Edge\\User Data|\\Mozilla\\Firefox\\Profiles)</field>
    <description>LummaC2 Stealer: Browser profile directory enumeration detected (reconnaissance)</description>
    <mitre>
      <id>T1083</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,</group>
  </rule>

  <!-- Rule: LummaC2 - Chromium Browser Data Copy to Temp -->
  <rule id="100056" level="12">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)copy.*(Login Data|Cookies|Web Data).*\\temp\\</field>
    <description>LummaC2 Stealer: Browser credential file copied to temp directory (staging for exfiltration)</description>
    <mitre>
      <id>T1074.001</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,</group>
  </rule>

  <!-- Rule: LummaC2 - High-Confidence Attack (Credential Access + C2 Exfiltration) -->
  <rule id="100057" level="15">
    <if_sid>100042</if_sid>
    <if_matched_sid>100051</if_matched_sid>
    <description>LummaC2 Stealer: High-confidence attack - Browser credential access followed by C2 exfiltration</description>
    <mitre>
      <id>T1555.003</id>
      <id>T1041</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: LummaC2 - Wallet Theft Combined with Browser Credential Theft -->
  <rule id="100058" level="15">
    <if_sid>100048</if_sid>
    <if_matched_sid>100042</if_matched_sid>
    <description>LummaC2 Stealer: High-confidence attack - Cryptocurrency wallet and browser credential theft detected</description>
    <mitre>
      <id>T1005</id>
      <id>T1555.003</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: LummaC2 - Suspicious Process Name Pattern -->
  <rule id="100059" level="10">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.image" type="pcre2">(?i)\\(lumma|lummac2|stealer)\.exe$</field>
    <description>LummaC2 Stealer: Suspicious process name pattern matching known stealer variants</description>
    <mitre>
      <id>T1204.002</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,</group>
  </rule>

</group>
