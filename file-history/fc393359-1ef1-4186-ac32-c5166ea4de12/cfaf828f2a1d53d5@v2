<!--
  Consolidated Threat Detection Rules for Malware & APT Threats

  This rule set covers detection of:
  - Tomiris APT (C2 communication, malicious processes)
  - Trigona Ransomware (MS-SQL attacks, credential theft)
  - Akira Ransomware (Credential dumping, encryption, persistence)
  - LummaC2 Stealer (Credential & wallet theft)
  - Mirai/Gafgyt Botnets (Brute force, DDoS)
  - HolyCat Ransomware (Rust-based malware)

  Rule Severity: Critical (15), High (14), Medium (13-12), Low (10-6)
  MITRE ATT&CK Coverage: 15+ techniques
-->

<group name="threat_detection,malware,apt,ransomware,botnet,infostealer">

  <!-- ============================================================ -->
  <!-- TOMIRIS APT DETECTION RULES -->
  <!-- ============================================================ -->

  <!-- Rule: Tomiris APT - Known Malicious File Hash Detection -->
  <rule id="100001" level="15">
    <if_group>syscheck</if_group>
    <field name="md5">^(078be0065d0277935cdcf7e3e9db4679|087743415e1f6cc961e9d2bb6dfd6d51|091fbacd889fa390dc76bb24c2013b59)$</field>
    <description>Tomiris APT: Known malicious file hash detected (reverse shell indicator)</description>
    <mitre>
      <id>T1105</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,tsc_CC6.1,</group>
  </rule>

  <!-- Rule: Tomiris APT - C2 IP Connection Detection (188.127.227.226) -->
  <rule id="100002" level="14">
    <if_sid>87101</if_sid>
    <field name="win.eventdata.destinationIp">^188\.127\.227\.226$</field>
    <description>Tomiris APT: Connection to known C2 IP 188.127.227.226 detected</description>
    <mitre>
      <id>T1071.001</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: Tomiris APT - C2 IP Connection Detection (188.127.231.136) -->
  <rule id="100003" level="14">
    <if_sid>87101</if_sid>
    <field name="win.eventdata.destinationIp">^188\.127\.231\.136$</field>
    <description>Tomiris APT: Connection to known C2 IP 188.127.231.136 detected</description>
    <mitre>
      <id>T1071.001</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: Tomiris APT - Process Execution with Suspicious Command Line -->
  <rule id="100004" level="13">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)(reverseshell|telegram|discord).*--c2</field>
    <description>Tomiris APT: Suspicious process execution with C2 indicators detected</description>
    <mitre>
      <id>T1071.001</id>
      <id>T1059</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- TRIGONA RANSOMWARE DETECTION RULES -->
  <!-- ============================================================ -->

  <!-- Rule: Trigona - BCP.exe Abuse Detection -->
  <rule id="100005" level="14">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.image" type="pcre2">(?i)\\bcp\.exe$</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)queryout</field>
    <description>Trigona Ransomware: SQL Server BCP.exe abuse for data extraction detected</description>
    <mitre>
      <id>T1190</id>
      <id>T1218.004</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: Trigona - Known Malicious File Hash Detection -->
  <rule id="100006" level="15">
    <if_group>syscheck</if_group>
    <field name="md5">^(2e4d250ecae8635fa3698eba5772a3b9|3c21181c35d955f9e557417998c38942|44bca3e7da4c28be4f55af0370091931)$</field>
    <description>Trigona Ransomware: Known malicious file hash detected</description>
    <mitre>
      <id>T1105</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: Trigona - MS-SQL Brute Force Attack Detection -->
  <rule id="100007" level="12" frequency="5" timeframe="60">
    <if_sid>1002</if_sid>
    <field name="protocol">tcp</field>
    <same_source_ip/>
    <description>Trigona Ransomware: MS-SQL brute force attack detected (5+ connection attempts in 60 seconds)</description>
    <mitre>
      <id>T1110.001</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- AKIRA RANSOMWARE DETECTION RULES -->
  <!-- ============================================================ -->

  <!-- Rule: Akira - Ngrok Process Execution Detection -->
  <rule id="100008" level="13">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.image" type="pcre2">(?i)\\ngrok\.exe$</field>
    <description>Akira Ransomware: Ngrok tunneling tool execution detected (C2 tunneling)</description>
    <mitre>
      <id>T1572</id>
      <id>T1071</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: Akira - Credential Dumping Tool Execution (Mimikatz) -->
  <rule id="100009" level="14">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.image" type="pcre2">(?i)(mimikatz|mimilib)\.exe$</field>
    <description>Akira Ransomware: Mimikatz credential dumping tool execution detected</description>
    <mitre>
      <id>T1003.001</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: Akira - Ransomware File Extension Detection -->
  <rule id="100010" level="15">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\.(akira|powerranges|akiranew|aki)$</field>
    <description>Akira Ransomware: File with known ransomware extension detected (active encryption)</description>
    <mitre>
      <id>T1486</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- LUMMAC2 STEALER DETECTION RULES -->
  <!-- ============================================================ -->

  <!-- Rule: LummaC2 - Chrome Login Data File Access -->
  <rule id="100011" level="12">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)Google\\Chrome.*Login Data$</field>
    <description>LummaC2 Stealer: Chrome credential database access detected (credential theft)</description>
    <mitre>
      <id>T1555.003</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: LummaC2 - C2 Communication Pattern Detection -->
  <rule id="100012" level="14">
    <if_sid>31101</if_sid>
    <match>POST /c2sock</match>
    <description>LummaC2 Stealer: Suspicious POST request to /c2sock endpoint (C2 communication)</description>
    <mitre>
      <id>T1041</id>
      <id>T1071.001</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- MIRAI/GAFGYT BOTNET DETECTION RULES -->
  <!-- ============================================================ -->

  <!-- Rule: Mirai/Gafgyt - Known Malicious File Hash Detection -->
  <rule id="100013" level="15">
    <if_group>syscheck</if_group>
    <field name="sha256">^(46797b147888fe2866543cf6c5dd55811d0968e5b6e461a8e4639ec33c9f2eab|bb80d618d7831ecd42d4b4caa1dac3cc22060f627ad217f7489073546ccb6c86)$</field>
    <description>Mirai/Gafgyt Botnet: Known malicious botnet binary detected on system</description>
    <mitre>
      <id>T1105</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: Mirai/Gafgyt - Connection to Known C2 IP (209.141.44.28) -->
  <rule id="100014" level="14">
    <if_sid>87101</if_sid>
    <field name="win.eventdata.destinationIp">^209\.141\.44\.28$</field>
    <description>Mirai/Gafgyt Botnet: Connection to known C2 IP 209.141.44.28 detected</description>
    <mitre>
      <id>T1071.001</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: Mirai/Gafgyt - Telnet Brute Force Attack Detection -->
  <rule id="100015" level="12" frequency="5" timeframe="60">
    <if_sid>5503</if_sid>
    <match>telnet</match>
    <same_source_ip/>
    <description>Mirai/Gafgyt Botnet: Telnet brute force attack detected (5+ failed attempts in 60 seconds)</description>
    <mitre>
      <id>T1110.001</id>
    </mitre>
    <group>authentication_failures,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: Mirai/Gafgyt - SSH Brute Force Attack Detection -->
  <rule id="100016" level="12" frequency="5" timeframe="60">
    <if_sid>5710</if_sid>
    <same_source_ip/>
    <description>Mirai/Gafgyt Botnet: SSH brute force attack detected (5+ failed attempts in 60 seconds)</description>
    <mitre>
      <id>T1110.001</id>
    </mitre>
    <group>authentication_failures,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- ============================================================ -->
  <!-- CROSS-THREAT CORRELATION RULES -->
  <!-- ============================================================ -->

  <!-- Rule: Multiple Brute Force Attacks from Same Source -->
  <rule id="100017" level="13">
    <if_sid>100015</if_sid>
    <if_matched_sid>100016</if_matched_sid>
    <same_source_ip/>
    <description>Botnet Activity: Multiple simultaneous brute force attack types detected from same source (potential botnet propagation)</description>
    <mitre>
      <id>T1110.001</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: Rapid File Encryption Detection (Frequency-Based) -->
  <rule id="100018" level="15" frequency="50" timeframe="60">
    <if_matched_sid>100010</if_matched_sid>
    <description>Ransomware Activity: Rapid file encryption detected (50+ encrypted files in 60 seconds - active ransomware attack)</description>
    <mitre>
      <id>T1486</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

</group>
