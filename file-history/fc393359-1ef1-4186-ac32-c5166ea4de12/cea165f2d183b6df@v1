<!--
  Wazuh Detection Rules for Akira Ransomware

  Threat Overview:
  - Ngrok tunneling for C2 communication and data exfiltration
  - Credential dumping using Mimikatz and LaZagne
  - Shadow copy deletion for recovery prevention
  - File encryption with multiple extensions (.akira, .powerranges, .akiranew, .aki)
  - Rapid data exfiltration techniques

  MITRE ATT&CK Mapping:
  - T1572: Protocol Tunneling
  - T1071: Application Layer Protocol
  - T1003.001: OS Credential Dumping - LSASS Memory
  - T1003.002: OS Credential Dumping - Security Account Manager
  - T1490: Inhibit System Recovery
  - T1486: Data Encrypted for Impact
  - T1041: Exfiltration Over C2 Channel

  Required Telemetry:
  - Sysmon Event ID 1 (Process Creation)
  - Sysmon Event ID 3 (Network Connection)
  - Sysmon Event ID 10 (Process Access)
  - File Integrity Monitoring
  - Windows Security Event Logs
-->

<group name="akira_ransomware,ransomware,ngrok,credential_dumping,data_exfiltration,">

  <!-- Rule: Akira - Ngrok Process Execution -->
  <rule id="100024" level="12">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.image" type="pcre2">(?i)\\ngrok\.exe$</field>
    <description>Akira Ransomware: Ngrok tunneling tool execution detected</description>
    <mitre>
      <id>T1572</id>
      <id>T1071</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: Akira - Ngrok Domain Connection -->
  <rule id="100025" level="13">
    <if_sid>87101</if_sid>
    <field name="win.eventdata.destinationHostname" type="pcre2">(?i)\.ngrok\.io$</field>
    <description>Akira Ransomware: Connection to Ngrok domain detected (potential C2 tunneling)</description>
    <mitre>
      <id>T1572</id>
      <id>T1071</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: Akira - Ngrok with TCP/HTTP Tunnel Arguments -->
  <rule id="100026" level="13">
    <if_sid>100024</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)ngrok\s+(tcp|http|tls|start)</field>
    <description>Akira Ransomware: Ngrok tunnel creation command detected (active tunneling)</description>
    <mitre>
      <id>T1572</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,</group>
  </rule>

  <!-- Rule: Akira - Mimikatz Execution Detection -->
  <rule id="100027" level="14">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.image" type="pcre2">(?i)(mimikatz|mimilib|mimispool)\.exe$</field>
    <description>Akira Ransomware: Mimikatz credential dumping tool execution detected</description>
    <mitre>
      <id>T1003.001</id>
      <id>T1003.002</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: Akira - Mimikatz Command Line Patterns -->
  <rule id="100028" level="14">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)(sekurlsa::logonpasswords|lsadump::sam|sekurlsa::tickets|kerberos::golden)</field>
    <description>Akira Ransomware: Mimikatz credential dumping command detected</description>
    <mitre>
      <id>T1003.001</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,</group>
  </rule>

  <!-- Rule: Akira - LaZagne Credential Dumping Tool -->
  <rule id="100029" level="13">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.image" type="pcre2">(?i)\\lazagne\.exe$</field>
    <description>Akira Ransomware: LaZagne credential harvesting tool execution detected</description>
    <mitre>
      <id>T1003</id>
      <id>T1555</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,</group>
  </rule>

  <!-- Rule: Akira - LaZagne Command Line Execution -->
  <rule id="100030" level="13">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)lazagne\.exe\s+all</field>
    <description>Akira Ransomware: LaZagne all-credential dump command detected</description>
    <mitre>
      <id>T1003</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,</group>
  </rule>

  <!-- Rule: Akira - Shadow Copy Deletion via WMIC -->
  <rule id="100031" level="14">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)wmic.*shadowcopy.*delete</field>
    <description>Akira Ransomware: Shadow copy deletion via WMIC detected (inhibiting system recovery)</description>
    <mitre>
      <id>T1490</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: Akira - Shadow Copy Deletion via vssadmin -->
  <rule id="100032" level="14">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)vssadmin.*delete\s+shadows</field>
    <description>Akira Ransomware: Shadow copy deletion via vssadmin detected (inhibiting system recovery)</description>
    <mitre>
      <id>T1490</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,tsc_CC7.2,</group>
  </rule>

  <!-- Rule: Akira - File Extension .akira Detection -->
  <rule id="100033" level="15">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\.akira$</field>
    <description>Akira Ransomware: File with .akira extension detected (active ransomware encryption)</description>
    <mitre>
      <id>T1486</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,tsc_CC6.1,</group>
  </rule>

  <!-- Rule: Akira - File Extension .powerranges Detection -->
  <rule id="100034" level="15">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\.powerranges$</field>
    <description>Akira Ransomware: File with .powerranges extension detected (active ransomware encryption)</description>
    <mitre>
      <id>T1486</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,tsc_CC6.1,</group>
  </rule>

  <!-- Rule: Akira - File Extension .akiranew Detection -->
  <rule id="100035" level="15">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\.akiranew$</field>
    <description>Akira Ransomware: File with .akiranew extension detected (active ransomware encryption)</description>
    <mitre>
      <id>T1486</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,tsc_CC6.1,</group>
  </rule>

  <!-- Rule: Akira - File Extension .aki Detection -->
  <rule id="100036" level="15">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)\.aki$</field>
    <description>Akira Ransomware: File with .aki extension detected (active ransomware encryption)</description>
    <mitre>
      <id>T1486</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC7.2,tsc_CC6.1,</group>
  </rule>

  <!-- Rule: Akira - LSASS Memory Access (Credential Dumping) -->
  <rule id="100037" level="13">
    <if_sid>61610</if_sid>
    <field name="win.eventdata.targetImage" type="pcre2">(?i)\\lsass\.exe$</field>
    <field name="win.eventdata.grantedAccess">0x1410|0x1010|0x1438|0x143a|0x1400</field>
    <description>Akira Ransomware: Suspicious access to LSASS memory (potential credential dumping)</description>
    <mitre>
      <id>T1003.001</id>
    </mitre>
    <group>pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,</group>
  </rule>

  <!-- Rule: Akira - High-Confidence Attack Chain (Ngrok + Credential Dump) -->
  <rule id="100038" level="15">
    <if_sid>100024,100026</if_sid>
    <if_matched_sid>100027,100028,100029</if_matched_sid>
    <description>Akira Ransomware: High-confidence attack - Ngrok tunneling combined with credential dumping</description>
    <mitre>
      <id>T1572</id>
      <id>T1003.001</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: Akira - Attack Chain (Credential Dump + Shadow Deletion) -->
  <rule id="100039" level="15">
    <if_sid>100027,100028,100029</if_sid>
    <if_matched_sid>100031,100032</if_matched_sid>
    <description>Akira Ransomware: High-confidence attack - Credential dumping followed by shadow copy deletion</description>
    <mitre>
      <id>T1003.001</id>
      <id>T1490</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: Akira - Rapid File Encryption (Frequency-Based) -->
  <rule id="100040" level="15" frequency="50" timeframe="60">
    <if_matched_sid>100033,100034,100035,100036</if_matched_sid>
    <description>Akira Ransomware: Rapid file encryption detected (50+ files in 60 seconds)</description>
    <mitre>
      <id>T1486</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

  <!-- Rule: Akira - Ransomware Note Detection -->
  <rule id="100041" level="15">
    <if_group>syscheck</if_group>
    <field name="file" type="pcre2">(?i)(akira_readme|how_to_decrypt|recovery_instructions)\.txt$</field>
    <description>Akira Ransomware: Ransomware note file detected (active infection)</description>
    <mitre>
      <id>T1486</id>
    </mitre>
    <group>pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,</group>
  </rule>

</group>
