#!/bin/bash
# Deploy Wazuh rules via REST API (no SSH needed)

WAZUH_API="https://192.168.0.141:55000"
WAZUH_USER="${WAZUH_USER:-wazuh-wui}"
WAZUH_PASS="${WAZUH_PASS:-wazuh-wui}"

RULE_FILE="$1"

if [ -z "$RULE_FILE" ]; then
    echo "Usage: $0 <rule-file.xml>"
    exit 1
fi

if [ ! -f "$RULE_FILE" ]; then
    echo "Error: File $RULE_FILE not found"
    exit 1
fi

echo "Step 1: Validating rule file..."

# Run XML validation
xmllint --noout "$RULE_FILE" 2>&1
if [ $? -ne 0 ]; then
    echo "✗ XML validation failed"
    exit 1
fi
echo "✓ XML syntax valid"

# Run rule ID conflict check
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
python3 "$SCRIPT_DIR/scripts/check_rule_ids.py" 2>&1
if [ $? -ne 0 ]; then
    echo "✗ Rule validation failed"
    exit 1
fi

echo ""
echo "Step 2: Deploying $RULE_FILE via Wazuh API..."

# Get API token
TOKEN=$(curl -s -u "$WAZUH_USER:$WAZUH_PASS" -k -X GET "$WAZUH_API/security/user/authenticate" | jq -r '.data.token')

if [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then
    echo "Error: Failed to authenticate with Wazuh API"
    exit 1
fi

echo "✓ Authenticated"

# Upload rule file
RESPONSE=$(curl -s -k -X PUT "$WAZUH_API/rules/files/$(basename $RULE_FILE)?overwrite=true" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/octet-stream" \
    --data-binary "@$RULE_FILE")

# Check upload result
UPLOAD_ERROR=$(echo "$RESPONSE" | jq -r '.error')
if [ "$UPLOAD_ERROR" != "0" ]; then
    echo "✗ Upload failed:"
    echo "$RESPONSE" | jq -r '.message'
    exit 1
fi

UPLOADED_FILE=$(echo "$RESPONSE" | jq -r '.data.affected_items[0]')
echo "✓ Rule uploaded: $UPLOADED_FILE"

# Restart manager
echo ""
echo "Step 3: Restarting Wazuh manager..."
RESTART_RESPONSE=$(curl -s -k -X PUT "$WAZUH_API/manager/restart" \
    -H "Authorization: Bearer $TOKEN")

RESTART_ERROR=$(echo "$RESTART_RESPONSE" | jq -r '.error')
if [ "$RESTART_ERROR" != "0" ]; then
    echo "✗ Restart failed"
    echo "$RESTART_RESPONSE" | jq '.'
    exit 1
fi

echo "✓ Manager restarted"
echo ""
echo "✅ Deployment complete! Rule is now active on Wazuh server."
