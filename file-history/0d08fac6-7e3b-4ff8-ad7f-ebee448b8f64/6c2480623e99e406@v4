#!/bin/bash
# Deploy Wazuh rules via REST API (no SSH needed)

WAZUH_API="https://192.168.0.141:55000"
WAZUH_USER="${WAZUH_USER:-wazuh-wui}"
WAZUH_PASS="${WAZUH_PASS:-wazuh-wui}"

RULE_FILE="$1"

if [ -z "$RULE_FILE" ]; then
    echo "Usage: $0 <rule-file.xml>"
    exit 1
fi

if [ ! -f "$RULE_FILE" ]; then
    echo "Error: File $RULE_FILE not found"
    exit 1
fi

echo "Deploying $RULE_FILE via Wazuh API..."

# Get API token
TOKEN=$(curl -s -u "$WAZUH_USER:$WAZUH_PASS" -k -X GET "$WAZUH_API/security/user/authenticate" | jq -r '.data.token')

if [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then
    echo "Error: Failed to authenticate with Wazuh API"
    exit 1
fi

echo "✓ Authenticated"

# Upload rule file
RESPONSE=$(curl -s -k -X PUT "$WAZUH_API/rules/files/$(basename $RULE_FILE)?overwrite=true" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/octet-stream" \
    --data-binary "@$RULE_FILE")

echo "Response: $RESPONSE"

# Restart manager
echo "Restarting Wazuh manager..."
curl -s -k -X PUT "$WAZUH_API/manager/restart" \
    -H "Authorization: Bearer $TOKEN"

echo "✓ Deployment complete"
