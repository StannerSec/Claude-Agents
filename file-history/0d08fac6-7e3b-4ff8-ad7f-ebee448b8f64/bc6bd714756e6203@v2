#!/bin/bash
# Query alerts directly on Wazuh server (run this ON the Wazuh server)

INDEXER_URL="https://localhost:9200"
INDEX="wazuh-alerts-4.x-$(date +%Y.%m.%d)"

case "$1" in
    recent)
        echo "=== Recent Alerts ==="
        curl -s -k -u "admin:admin" "$INDEXER_URL/$INDEX/_search" \
            -H 'Content-Type: application/json' \
            -d '{
              "query": {"match_all": {}},
              "size": 10,
              "sort": [{"timestamp": "desc"}]
            }' | jq -r '.hits.hits[]._source | "\(.timestamp) - Rule \(.rule.id): \(.rule.description) - Agent: \(.agent.name)"'
        ;;

    rule)
        RULE_ID="$2"
        echo "=== Alerts for Rule $RULE_ID ==="
        curl -s -k -u "admin:admin" "$INDEXER_URL/$INDEX/_search" \
            -H 'Content-Type: application/json' \
            -d "{
              \"query\": {
                \"term\": {
                  \"rule.id\": \"$RULE_ID\"
                }
              },
              \"size\": 20,
              \"sort\": [{\"timestamp\": \"desc\"}]
            }" | jq -r '.hits.hits[]._source | "\(.timestamp) - \(.rule.description) - Agent: \(.agent.name)"'
        ;;

    count)
        echo "=== Total Alerts Today ==="
        curl -s -k -u "admin:admin" "$INDEXER_URL/$INDEX/_count" | jq '{total_alerts: .count}'
        ;;

    *)
        echo "Usage: $0 {recent|rule <rule_id>|count}"
        echo ""
        echo "This script must be run ON the Wazuh server"
        echo ""
        echo "Examples:"
        echo "  $0 recent          # Get 10 most recent alerts"
        echo "  $0 rule 100001     # Get alerts for rule 100001"
        echo "  $0 count           # Count total alerts today"
        ;;
esac
