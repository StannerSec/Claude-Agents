# Generate Detection Logic Skill

This skill creates Wazuh detection rules using threat intelligence research provided by the Threat Research Engineer.

## Detection Philosophy: The Pyramid of Pain

Build rules using the **Pyramid of Pain** approach to create resilient detections that are difficult for attackers to evade:

### Pyramid Levels (Bottom to Top):
1. **Hash Values** (Trivial) - Easy for attackers to change
2. **IP Addresses** (Easy) - Simple to rotate infrastructure
3. **Domain Names** (Simple) - Attackers can register new domains
4. **Network/Host Artifacts** (Annoying) - Requires some operational changes
5. **Tools** (Challenging) - Forces attackers to learn new tools
6. **TTPs (Tactics, Techniques, Procedures)** (Tough) - Requires fundamental changes to attack methodology

### Detection Strategy

**Goal**: Create a balanced mix of detection rules across the pyramid:
- **IOC-based rules** (bottom of pyramid) - Fast deployment, catches known threats
- **TTP-based rules** (top of pyramid) - Resilient detection, harder to evade

Nothing is wrong with IOC-based rules, but we want to also create rules that are at the top of the pyramid and are harder for attackers to evade without completely changing a technique.

### Key Resources

Review these resources for detection strategies:
- **MITRE ATT&CK Detection Strategies**: https://attack.mitre.org/detectionstrategies/ - Detection analytics and attack chaining ideas
- **Pyramid of Pain**: https://detect-respond.blogspot.com/2013/03/the-pyramid-of-pain.html - Understanding detection effectiveness
- **Summiting the Pyramid**: https://center-for-threat-informed-defense.github.io/summiting-the-pyramid/ - In-depth guide to building great detection rules

## Rule Development Requirements

### 1. Create Detection Rules
Generate Wazuh XML rules that detect the threat across multiple pyramid levels when possible.

### 2. Document Required Log Sources
After building detections, **always document the required log sources** in Wazuh format so the user can easily configure them:

**Example Log Source Documentation:**
```yaml
Required Log Sources (Wazuh Configuration):
---
Windows Event Logs:
  - Security (EventID 4688 - Process Creation)
  - Sysmon (EventID 1 - Process Creation, EventID 3 - Network Connection)

Linux Logs:
  - auditd (execve syscalls)
  - syslog (/var/log/auth.log)

File Integrity Monitoring:
  - Monitor: C:\Windows\System32\drivers\etc\hosts
  - Monitor: /etc/passwd, /etc/shadow

Network Logs:
  - DNS queries
  - Firewall logs (source/destination IPs and ports)
```

### 3. Balance Detection Strategy
For each threat, create rules at multiple pyramid levels:
- **Low Pyramid** (IOCs): Hashes, IPs, domains - for quick wins
- **High Pyramid** (TTPs): Behavioral detection, command patterns, attack chains - for resilience

## Output Format

When creating detection rules, provide:

1. **Detection Strategy Summary** - Which pyramid levels you're targeting
2. **Wazuh XML Rules** - Complete, production-ready rules
3. **Required Log Sources** - Wazuh configuration format for easy deployment
4. **MITRE ATT&CK Mapping** - Techniques and tactics detected
5. **Detection Rationale** - Why these rules are effective against the threat 
