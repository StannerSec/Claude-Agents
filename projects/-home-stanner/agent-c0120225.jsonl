{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_016BczUvpoaW3MRFyKts7Ji4","type":"message","role":"assistant","content":[{"type":"text","text":"I'll develop comprehensive Wazuh detection rules for these threats. Let me create a complete ruleset organized by threat category with proper XML syntax, severity levels, and MITRE ATT&CK mappings."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":2820,"cache_read_input_tokens":22127,"cache_creation":{"ephemeral_5m_input_tokens":2820,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CVXtNQXRBPF5XWzTyDjUZ","type":"assistant","uuid":"f40cc45d-15da-4015-9cd0-1e630fe8f001","timestamp":"2025-11-27T06:02:20.755Z"}
{"parentUuid":"f40cc45d-15da-4015-9cd0-1e630fe8f001","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_016BczUvpoaW3MRFyKts7Ji4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Qif9pwkZPgYTZpZoBhLwWi","name":"Write","input":{"file_path":"/home/stanner/wazuh_malware_detection_rules.xml","content":"<!--\n  Wazuh Detection Rules for Recent Malware Threats (November 27, 2025)\n\n  Description: Comprehensive ruleset for detecting:\n    - Mirai botnet variants (UPX-packed ELF)\n    - RondoDox botnet activity\n    - EDR killer techniques (BYOVD)\n    - Credential theft (T1555)\n    - Ransomware behaviors\n    - SharePoint exploitation (CVE-2025-53770/53771)\n\n  Rule ID Range: 100000-100099\n  Integration: Requires FIM, Sysmon, auditd, web server log collection\n\n  Author: Wazuh Threat Detection Engineering\n  Date: 2025-11-27\n-->\n\n<group name=\"malware,threat_detection,\">\n\n  <!-- =============================================== -->\n  <!-- SECTION 1: FILE HASH DETECTION                 -->\n  <!-- =============================================== -->\n\n  <rule id=\"100000\" level=\"12\">\n    <if_sid>550</if_sid>\n    <field name=\"file_sha256\">b6873744cfb1b2bc92f49ca61975afb7b8c491ccf41111ded5bc63575bba59d5</field>\n    <description>Mirai botnet malware detected (UPX-packed ELF) - SHA256 match</description>\n    <info>SHA256: b6873744cfb1b2bc92f49ca61975afb7b8c491ccf41111ded5bc63575bba59d5</info>\n    <info>Type: Linux.Backdoor.Mirai (UPX-compressed)</info>\n    <info>AV Detection Rate: 23.68% (9/38)</info>\n    <group>malware_hash,mirai,botnet,elf_malware,</group>\n    <mitre>\n      <id>T1059.004</id>\n      <id>T1071.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100001\" level=\"13\">\n    <if_sid>550</if_sid>\n    <field name=\"file_sha256\">7e5fbce9bce17de629ccfc1f8cc40ff780c8be1b0efd42f726e2bc469923fbdf</field>\n    <description>High-confidence malicious ARM ELF binary detected - SHA256 match</description>\n    <info>SHA256: 7e5fbce9bce17de629ccfc1f8cc40ff780c8be1b0efd42f726e2bc469923fbdf</info>\n    <info>Type: UPX decompressed ARM architecture malware</info>\n    <info>Threat Level: 0.75 (LIKELY_MALICIOUS)</info>\n    <info>YARA Hits: linux_generic_ipv6_catcher, unixredflags3</info>\n    <group>malware_hash,elf_malware,arm_malware,ipv6_malware,</group>\n    <mitre>\n      <id>T1027.002</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100002\" level=\"14\">\n    <if_sid>550</if_sid>\n    <field name=\"file_sha256\">5c2bbb00f32b9b196fe1ca35263516a7ebf9fb64ab29b3c85cc320618a6cc6c9</field>\n    <description>RondoDox botnet/scanner malware detected - SHA256 match</description>\n    <info>SHA256: 5c2bbb00f32b9b196fe1ca35263516a7ebf9fb64ab29b3c85cc320618a6cc6c9</info>\n    <info>Type: Linux botnet/scanner (RondoDox variant)</info>\n    <info>Behavior: Mass network scanning, credential brute force, process enumeration</info>\n    <info>Network Activity: 44,640+ remote host contacts</info>\n    <group>malware_hash,botnet,rondodox,credential_access,discovery,</group>\n    <mitre>\n      <id>T1110</id>\n      <id>T1046</id>\n      <id>T1057</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- SECTION 2: MIRAI/UPX-PACKED ELF DETECTION      -->\n  <!-- =============================================== -->\n\n  <rule id=\"100010\" level=\"10\">\n    <if_sid>554</if_sid>\n    <match>ELF</match>\n    <regex>UPX|upx</regex>\n    <description>UPX-packed ELF binary detected on system</description>\n    <info>UPX packing commonly used by Mirai and IoT botnet malware</info>\n    <group>file_monitoring,upx_detection,elf_malware,packer,</group>\n    <mitre>\n      <id>T1027.002</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100011\" level=\"12\">\n    <if_sid>100010</if_sid>\n    <field name=\"file_path\">/tmp|/dev/shm|/var/tmp</field>\n    <description>UPX-packed ELF binary in suspicious directory (potential Mirai dropper)</description>\n    <info>UPX-packed binaries in temporary directories indicate malware staging</info>\n    <group>file_monitoring,upx_detection,mirai,suspicious_location,</group>\n    <mitre>\n      <id>T1027.002</id>\n      <id>T1036</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100012\" level=\"8\">\n    <if_sid>550,554</if_sid>\n    <match>execve</match>\n    <regex>\\.\\/[a-zA-Z0-9]{5,10}\\.elf|\\.\\/[a-zA-Z0-9]{5,10}\\.bin</regex>\n    <description>Execution of randomly-named ELF binary (Mirai behavior pattern)</description>\n    <info>Mirai variants often use short random filenames for binaries</info>\n    <group>execution,mirai,botnet,suspicious_binary,</group>\n    <mitre>\n      <id>T1059.004</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100013\" level=\"11\">\n    <if_sid>550</if_sid>\n    <match>auditd</match>\n    <regex>syscall=socket.*inet6|AF_INET6</regex>\n    <field name=\"exe\">!/usr/bin|!/usr/sbin|!/bin|!/sbin</field>\n    <description>Suspicious IPv6 socket creation by non-standard binary (potential malware)</description>\n    <info>Matches YARA rule linux_generic_ipv6_catcher pattern</info>\n    <group>network_activity,ipv6_malware,suspicious_socket,</group>\n    <mitre>\n      <id>T1071.001</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- SECTION 3: BOTNET ACTIVITY DETECTION           -->\n  <!-- =============================================== -->\n\n  <rule id=\"100020\" level=\"8\">\n    <if_group>syslog</if_group>\n    <match>SYN_SENT|connection attempt</match>\n    <frequency>1000</frequency>\n    <timeframe>300</timeframe>\n    <description>Mass network connection attempts detected (>1000 in 5 min) - Possible botnet scanning</description>\n    <info>RondoDox and similar botnets contact 44,000+ hosts during scanning operations</info>\n    <group>botnet,network_scanning,mass_connection,</group>\n    <mitre>\n      <id>T1046</id>\n      <id>T1595.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100021\" level=\"10\">\n    <if_sid>100020</if_sid>\n    <field name=\"dstport\">22|23|445|3389|5555|8080|8081</field>\n    <description>Mass connection attempts to common exploitation ports - Botnet brute force activity</description>\n    <info>Targeting SSH(22), Telnet(23), SMB(445), RDP(3389), Android Debug(5555), HTTP proxies</info>\n    <group>botnet,brute_force,credential_access,rondodox,</group>\n    <mitre>\n      <id>T1110.001</id>\n      <id>T1110.003</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100022\" level=\"9\">\n    <if_sid>5712,5716</if_sid>\n    <frequency>50</frequency>\n    <timeframe>60</timeframe>\n    <description>Rapid authentication failures across multiple hosts - Credential brute force attack</description>\n    <info>Botnet credential stuffing or brute force campaign detected</info>\n    <group>authentication_failed,brute_force,botnet,credential_access,</group>\n    <mitre>\n      <id>T1110</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100023\" level=\"10\">\n    <if_sid>550</if_sid>\n    <match>execve</match>\n    <regex>ps\\s+(-e|aux|axu)|/proc/[0-9]+/|pidof|pgrep</regex>\n    <frequency>20</frequency>\n    <timeframe>60</timeframe>\n    <description>Rapid process enumeration detected - Botnet reconnaissance activity</description>\n    <info>Searching for security tools, competitors, or system information</info>\n    <group>discovery,process_enumeration,botnet,</group>\n    <mitre>\n      <id>T1057</id>\n      <id>T1518.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100024\" level=\"12\">\n    <if_sid>550</if_sid>\n    <match>connect</match>\n    <field name=\"syscall\">connect</field>\n    <frequency>5000</frequency>\n    <timeframe>600</timeframe>\n    <same_source_ip />\n    <description>CRITICAL: Extreme network connection rate (>5000 in 10 min) - Active botnet node</description>\n    <info>Network behavior consistent with RondoDox mass scanning operations</info>\n    <group>botnet,mass_connection,active_infection,rondodox,</group>\n    <mitre>\n      <id>T1046</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- SECTION 4: EDR KILLER DETECTION (BYOVD)        -->\n  <!-- =============================================== -->\n\n  <rule id=\"100030\" level=\"12\">\n    <if_sid>61603,61612</if_sid>\n    <regex>\\\\[a-zA-Z]{5}\\.sys|\\\\[0-9]{5}\\.sys</regex>\n    <description>Driver loaded with suspicious 5-character random name - Possible EDR killer (BYOVD)</description>\n    <info>8+ ransomware groups use BYOVD technique with 5-char driver names</info>\n    <group>edr_killer,byovd,driver_load,defense_evasion,</group>\n    <mitre>\n      <id>T1068</id>\n      <id>T1562.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100031\" level=\"14\">\n    <if_sid>61603,61612</if_sid>\n    <regex>\\\\[a-zA-Z]{5}\\.sys</regex>\n    <if_match_sid>100032</if_match_sid>\n    <description>CRITICAL: EDR killer driver loaded followed by security service termination</description>\n    <info>BYOVD attack chain: vulnerable driver + security product termination</info>\n    <group>edr_killer,byovd,attack_chain,defense_evasion,</group>\n    <mitre>\n      <id>T1068</id>\n      <id>T1562.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100032\" level=\"11\">\n    <if_group>windows,sysmon_event1</if_group>\n    <match>sc.exe stop|net stop|taskkill</match>\n    <regex>MsMpEng|CylanceSvc|SentinelAgent|CSFalconService|McAfee|Norton|Kaspersky|ESET|Sophos|Trend Micro|Carbon Black|Defender</regex>\n    <description>Attempted termination of EDR/AV security service</description>\n    <info>Common EDR killer behavior targeting endpoint protection</info>\n    <group>edr_killer,defense_evasion,service_stop,</group>\n    <mitre>\n      <id>T1562.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100033\" level=\"13\">\n    <if_sid>61603</if_sid>\n    <regex>RTCore64\\.sys|gdrv\\.sys|AsrDrv10[0-9]\\.sys|DBUtil_2_3\\.sys|PROCEXP152\\.SYS|kernelcheatsys\\.sys</regex>\n    <description>Known vulnerable driver loaded - BYOVD technique detected</description>\n    <info>These drivers are commonly abused for privilege escalation and EDR termination</info>\n    <group>edr_killer,byovd,vulnerable_driver,known_bad,</group>\n    <mitre>\n      <id>T1068</id>\n      <id>T1543.003</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100034\" level=\"10\">\n    <if_group>windows,sysmon_event1</if_group>\n    <match>sc.exe create</match>\n    <regex>type=\\s*kernel|binPath=.*\\.sys</regex>\n    <description>Kernel driver service creation detected - Potential BYOVD preparation</description>\n    <info>Service creation for kernel driver - validate legitimacy</info>\n    <group>driver_load,service_creation,byovd,</group>\n    <mitre>\n      <id>T1543.003</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- SECTION 5: CREDENTIAL THEFT DETECTION (T1555)  -->\n  <!-- =============================================== -->\n\n  <rule id=\"100040\" level=\"11\">\n    <if_group>sysmon_event_10</if_group>\n    <field name=\"TargetImage\">\\\\Google\\\\Chrome\\\\Application\\\\chrome\\.exe|\\\\Mozilla Firefox\\\\firefox\\.exe|\\\\Microsoft\\\\Edge\\\\Application\\\\msedge\\.exe</field>\n    <field name=\"SourceImage\">!\\\\Google\\\\Chrome\\\\|!\\\\Mozilla Firefox\\\\|!\\\\Microsoft\\\\Edge\\\\</field>\n    <description>Suspicious process accessing browser memory - Potential credential theft (T1555)</description>\n    <info>3X increase in T1555 malware targeting browser credential stores</info>\n    <group>credential_theft,browser_credentials,t1555,memory_access,</group>\n    <mitre>\n      <id>T1555.003</id>\n      <id>T1555</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100041\" level=\"12\">\n    <if_sid>554</if_sid>\n    <field name=\"file_path\">\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\User Data\\\\.*\\\\Login Data|\\\\AppData\\\\Roaming\\\\Mozilla\\\\Firefox\\\\Profiles\\\\.*\\\\logins\\.json|\\\\AppData\\\\Local\\\\Microsoft\\\\Edge\\\\User Data\\\\.*\\\\Login Data</field>\n    <field name=\"process\">!chrome\\.exe|!firefox\\.exe|!msedge\\.exe|!brave\\.exe</field>\n    <description>Unauthorized access to browser credential database - Active credential theft</description>\n    <info>Non-browser process accessing Login Data or logins.json files</info>\n    <group>credential_theft,browser_credentials,t1555,file_access,</group>\n    <mitre>\n      <id>T1555.003</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100042\" level=\"13\">\n    <if_sid>554</if_sid>\n    <field name=\"file_path\">\\\\AppData\\\\Local\\\\Microsoft\\\\Vault|\\\\AppData\\\\Roaming\\\\Microsoft\\\\Vault|\\\\AppData\\\\Local\\\\Microsoft\\\\Credentials</field>\n    <regex>vaultcmd|VaultPasswordV1\\.dat|Policy\\.vpol</regex>\n    <description>Windows Vault or Credential Manager access detected - Credential harvesting</description>\n    <info>Access to Windows stored credentials (T1555.004)</info>\n    <group>credential_theft,windows_vault,t1555,credential_manager,</group>\n    <mitre>\n      <id>T1555.004</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100043\" level=\"12\">\n    <if_group>sysmon_event1</if_group>\n    <regex>cmdkey\\s+/list|vaultcmd\\s+/list|Get-VaultCredential|Get-StoredCredential</regex>\n    <description>Credential enumeration command executed - Credential discovery activity</description>\n    <info>Listing stored credentials using native Windows tools</info>\n    <group>credential_theft,credential_enumeration,t1555,discovery,</group>\n    <mitre>\n      <id>T1555</id>\n      <id>T1087</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100044\" level=\"11\">\n    <if_group>sysmon_event_11</if_group>\n    <regex>passwords\\.txt|credentials\\.txt|logins\\.txt|creds\\.txt|dump\\.txt</regex>\n    <field name=\"file_path\">\\\\AppData\\\\Local\\\\Temp|\\\\Users\\\\Public|C:\\\\Temp</field>\n    <description>Suspicious credential dump file created - Credential exfiltration staging</description>\n    <info>Credential theft often stages harvested data in temp directories</info>\n    <group>credential_theft,data_staging,exfiltration,t1555,</group>\n    <mitre>\n      <id>T1555</id>\n      <id>T1074.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100045\" level=\"10\">\n    <if_group>linux,auditd</if_group>\n    <field name=\"file_path\">.mozilla/firefox/.*/logins.json|.config/google-chrome/.*/Login Data|.config/chromium/.*/Login Data</field>\n    <field name=\"syscall\">open|openat</field>\n    <description>Linux browser credential file access detected - Potential credential theft</description>\n    <info>Access to Firefox/Chrome credential stores on Linux systems</info>\n    <group>credential_theft,browser_credentials,linux,t1555,</group>\n    <mitre>\n      <id>T1555.003</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- SECTION 6: RANSOMWARE BEHAVIOR DETECTION       -->\n  <!-- =============================================== -->\n\n  <rule id=\"100050\" level=\"12\">\n    <if_sid>554</if_sid>\n    <regex>\\.encrypted$|\\.locked$|\\.crypto$|\\.crypt$|\\.lockbit$|\\.lynx$|\\.vanhelsing$</regex>\n    <frequency>50</frequency>\n    <timeframe>60</timeframe>\n    <description>Mass file encryption activity detected - Active ransomware attack</description>\n    <info>Rapid creation of encrypted file extensions indicates ransomware</info>\n    <group>ransomware,file_encryption,lockbit,lynx,vanhelsing,</group>\n    <mitre>\n      <id>T1486</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100051\" level=\"14\">\n    <if_sid>554</if_sid>\n    <regex>READ_ME\\.txt|HOW_TO_DECRYPT\\.txt|RECOVERY_INSTRUCTIONS\\.txt|ransom\\.txt|README\\.txt|DECRYPT\\.txt</regex>\n    <field name=\"file_path\">\\\\Desktop\\\\|\\\\Users\\\\|C:\\\\|D:\\\\</field>\n    <description>CRITICAL: Ransom note created - Ransomware attack confirmed</description>\n    <info>Ransom note creation in common locations (LockBit, VanHelsing, Lynx patterns)</info>\n    <group>ransomware,ransom_note,lockbit,lynx,vanhelsing,</group>\n    <mitre>\n      <id>T1486</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100052\" level=\"13\">\n    <if_group>sysmon_event1</if_group>\n    <regex>vssadmin\\.exe.*delete.*shadows|wmic.*shadowcopy.*delete|bcdedit.*recoveryenabled.*no|wbadmin.*delete.*catalog</regex>\n    <description>Shadow copy/backup deletion detected - Ransomware anti-recovery technique</description>\n    <info>Preventing recovery by deleting volume shadow copies and backups</info>\n    <group>ransomware,anti_recovery,shadow_copy,defense_evasion,</group>\n    <mitre>\n      <id>T1490</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100053\" level=\"11\">\n    <if_group>sysmon_event1</if_group>\n    <regex>cipher\\.exe\\s+/w|sdelete|wipe|shred</regex>\n    <description>Secure file deletion tool executed - Data destruction or anti-forensics</description>\n    <info>Ransomware may use secure deletion to remove recovery options</info>\n    <group>ransomware,anti_forensics,data_destruction,</group>\n    <mitre>\n      <id>T1485</id>\n      <id>T1070.004</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100054\" level=\"12\">\n    <if_sid>554</if_sid>\n    <match>file modification</match>\n    <frequency>500</frequency>\n    <timeframe>120</timeframe>\n    <same_source_ip />\n    <description>Extreme file modification rate (>500 in 2 min) - Ransomware encryption in progress</description>\n    <info>Mass file modifications indicate active encryption process</info>\n    <group>ransomware,mass_encryption,file_modification,</group>\n    <mitre>\n      <id>T1486</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100055\" level=\"10\">\n    <if_group>sysmon_event1</if_group>\n    <regex>net\\.exe\\s+stop.*sql|net\\.exe\\s+stop.*backup|net\\.exe\\s+stop.*vss</regex>\n    <description>Critical service termination - Ransomware preparation activity</description>\n    <info>Stopping SQL, backup, or VSS services before encryption</info>\n    <group>ransomware,service_stop,pre_encryption,</group>\n    <mitre>\n      <id>T1489</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- SECTION 7: SHAREPOINT EXPLOITATION DETECTION   -->\n  <!-- CVE-2025-53770 / CVE-2025-53771                -->\n  <!-- =============================================== -->\n\n  <rule id=\"100060\" level=\"11\">\n    <if_sid>31100,31101,31103</if_sid>\n    <match>/_vti_bin/</match>\n    <field name=\"status\">200|401|403</field>\n    <field name=\"auth\">^-$|^$</field>\n    <description>Unauthenticated access to SharePoint _vti_bin endpoint - Potential CVE-2025-53770 exploitation</description>\n    <info>SharePoint RCE vulnerability targeting /_vti_bin/ paths without authentication</info>\n    <group>sharepoint,web_attack,cve_2025_53770,rce,</group>\n    <mitre>\n      <id>T1190</id>\n      <id>T1059</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100061\" level=\"13\">\n    <if_sid>31100,31101,31103</if_sid>\n    <match>/_vti_bin/</match>\n    <regex>Referer:.*sharepoint\\.com|Referer:.*office\\.com</regex>\n    <field name=\"status\">200</field>\n    <description>SharePoint exploitation with forged Referer header - Active CVE-2025-53770 attack</description>\n    <info>Forged Referer headers used to bypass SharePoint authentication checks</info>\n    <group>sharepoint,web_attack,cve_2025_53770,authentication_bypass,</group>\n    <mitre>\n      <id>T1190</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100062\" level=\"12\">\n    <if_sid>31100,31101</if_sid>\n    <regex>deserialization|SerializationException|BinaryFormatter|ObjectStateFormatter</regex>\n    <match>/_vti_bin/|/_layouts/</match>\n    <description>SharePoint deserialization error detected - Possible exploitation attempt (CVE-2025-53771)</description>\n    <info>Deserialization vulnerabilities in SharePoint can lead to RCE</info>\n    <group>sharepoint,deserialization,cve_2025_53771,rce,</group>\n    <mitre>\n      <id>T1190</id>\n      <id>T1203</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100063\" level=\"10\">\n    <if_sid>31100,31101</if_sid>\n    <match>/_vti_bin/</match>\n    <frequency>20</frequency>\n    <timeframe>60</timeframe>\n    <same_source_ip />\n    <description>Rapid SharePoint _vti_bin endpoint scanning - Vulnerability probing</description>\n    <info>Multiple requests to SharePoint endpoints may indicate exploitation attempts</info>\n    <group>sharepoint,web_scanning,reconnaissance,</group>\n    <mitre>\n      <id>T1595.002</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100064\" level=\"14\">\n    <if_sid>31100,31101</if_sid>\n    <regex>cmd\\.exe|powershell\\.exe|/bin/bash|/bin/sh</regex>\n    <match>/_vti_bin/|/_layouts/</match>\n    <field name=\"status\">200|500|502</field>\n    <description>CRITICAL: Command execution pattern in SharePoint request - RCE exploitation detected</description>\n    <info>SharePoint RCE attack in progress (CVE-2025-53770/53771)</info>\n    <group>sharepoint,rce,web_attack,critical,cve_2025_53770,</group>\n    <mitre>\n      <id>T1190</id>\n      <id>T1059.003</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100065\" level=\"12\">\n    <if_sid>31100,31101</if_sid>\n    <match>/_vti_bin/spdisco.aspx|/_vti_bin/Lists.asmx|/_vti_bin/SharePointProjectService.svc</match>\n    <field name=\"method\">POST</field>\n    <field name=\"content-type\">text/xml|application/soap</field>\n    <description>Suspicious SOAP/XML POST to SharePoint web service - Potential deserialization attack</description>\n    <info>SOAP endpoints vulnerable to deserialization attacks (CVE-2025-53771)</info>\n    <group>sharepoint,web_attack,deserialization,cve_2025_53771,</group>\n    <mitre>\n      <id>T1190</id>\n      <id>T1203</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100066\" level=\"11\">\n    <if_sid>31100,31101</if_sid>\n    <match>/_layouts/</match>\n    <regex>__VIEWSTATE|__EVENTVALIDATION</regex>\n    <field name=\"content-length\">10000:</field>\n    <description>Large ViewState payload in SharePoint request - Possible deserialization exploit</description>\n    <info>Oversized ViewState may contain malicious deserialization payloads</info>\n    <group>sharepoint,deserialization,web_attack,</group>\n    <mitre>\n      <id>T1190</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- COMPOSITE/CORRELATION RULES                     -->\n  <!-- =============================================== -->\n\n  <rule id=\"100070\" level=\"15\">\n    <if_matched_sid>100000,100001,100002</if_matched_sid>\n    <if_matched_sid>100020,100021,100024</if_matched_sid>\n    <timeframe>600</timeframe>\n    <description>CRITICAL: Known malware hash detected with active botnet behavior - Confirmed infection</description>\n    <info>System infected with known malware sample exhibiting botnet activity</info>\n    <group>malware_confirmed,active_infection,botnet,critical,</group>\n    <mitre>\n      <id>T1071</id>\n      <id>T1110</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100071\" level=\"15\">\n    <if_matched_sid>100030,100031,100033</if_matched_sid>\n    <if_matched_sid>100050,100051,100052</if_matched_sid>\n    <timeframe>1800</timeframe>\n    <description>CRITICAL: EDR killer + ransomware attack chain detected - Immediate response required</description>\n    <info>Multi-stage ransomware attack: EDR termination followed by encryption</info>\n    <group>ransomware,edr_killer,attack_chain,critical,</group>\n    <mitre>\n      <id>T1562.001</id>\n      <id>T1486</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100072\" level=\"14\">\n    <if_matched_sid>100040,100041,100042</if_matched_sid>\n    <if_matched_sid>100044</if_matched_sid>\n    <timeframe>900</timeframe>\n    <description>CRITICAL: Credential theft and data staging detected - Active information stealing</description>\n    <info>Complete credential theft attack chain: harvesting + staging for exfiltration</info>\n    <group>credential_theft,data_staging,attack_chain,t1555,</group>\n    <mitre>\n      <id>T1555</id>\n      <id>T1074</id>\n    </mitre>\n  </rule>\n\n</group>\n"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":2820,"cache_read_input_tokens":22127,"cache_creation":{"ephemeral_5m_input_tokens":2820,"ephemeral_1h_input_tokens":0},"output_tokens":8097,"service_tier":"standard"},"context_management":{"applied_edits":[]}},"requestId":"req_011CVXtNQXRBPF5XWzTyDjUZ","type":"assistant","uuid":"011be716-4d61-47db-8292-75ab08ac2b18","timestamp":"2025-11-27T06:04:18.812Z"}
{"parentUuid":"011be716-4d61-47db-8292-75ab08ac2b18","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Qif9pwkZPgYTZpZoBhLwWi","type":"tool_result","content":"File created successfully at: /home/stanner/wazuh_malware_detection_rules.xml"}]},"uuid":"84ce1431-eee2-4da8-9528-c7af703aeee5","timestamp":"2025-11-27T06:04:35.487Z","toolUseResult":{"type":"create","filePath":"/home/stanner/wazuh_malware_detection_rules.xml","content":"<!--\n  Wazuh Detection Rules for Recent Malware Threats (November 27, 2025)\n\n  Description: Comprehensive ruleset for detecting:\n    - Mirai botnet variants (UPX-packed ELF)\n    - RondoDox botnet activity\n    - EDR killer techniques (BYOVD)\n    - Credential theft (T1555)\n    - Ransomware behaviors\n    - SharePoint exploitation (CVE-2025-53770/53771)\n\n  Rule ID Range: 100000-100099\n  Integration: Requires FIM, Sysmon, auditd, web server log collection\n\n  Author: Wazuh Threat Detection Engineering\n  Date: 2025-11-27\n-->\n\n<group name=\"malware,threat_detection,\">\n\n  <!-- =============================================== -->\n  <!-- SECTION 1: FILE HASH DETECTION                 -->\n  <!-- =============================================== -->\n\n  <rule id=\"100000\" level=\"12\">\n    <if_sid>550</if_sid>\n    <field name=\"file_sha256\">b6873744cfb1b2bc92f49ca61975afb7b8c491ccf41111ded5bc63575bba59d5</field>\n    <description>Mirai botnet malware detected (UPX-packed ELF) - SHA256 match</description>\n    <info>SHA256: b6873744cfb1b2bc92f49ca61975afb7b8c491ccf41111ded5bc63575bba59d5</info>\n    <info>Type: Linux.Backdoor.Mirai (UPX-compressed)</info>\n    <info>AV Detection Rate: 23.68% (9/38)</info>\n    <group>malware_hash,mirai,botnet,elf_malware,</group>\n    <mitre>\n      <id>T1059.004</id>\n      <id>T1071.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100001\" level=\"13\">\n    <if_sid>550</if_sid>\n    <field name=\"file_sha256\">7e5fbce9bce17de629ccfc1f8cc40ff780c8be1b0efd42f726e2bc469923fbdf</field>\n    <description>High-confidence malicious ARM ELF binary detected - SHA256 match</description>\n    <info>SHA256: 7e5fbce9bce17de629ccfc1f8cc40ff780c8be1b0efd42f726e2bc469923fbdf</info>\n    <info>Type: UPX decompressed ARM architecture malware</info>\n    <info>Threat Level: 0.75 (LIKELY_MALICIOUS)</info>\n    <info>YARA Hits: linux_generic_ipv6_catcher, unixredflags3</info>\n    <group>malware_hash,elf_malware,arm_malware,ipv6_malware,</group>\n    <mitre>\n      <id>T1027.002</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100002\" level=\"14\">\n    <if_sid>550</if_sid>\n    <field name=\"file_sha256\">5c2bbb00f32b9b196fe1ca35263516a7ebf9fb64ab29b3c85cc320618a6cc6c9</field>\n    <description>RondoDox botnet/scanner malware detected - SHA256 match</description>\n    <info>SHA256: 5c2bbb00f32b9b196fe1ca35263516a7ebf9fb64ab29b3c85cc320618a6cc6c9</info>\n    <info>Type: Linux botnet/scanner (RondoDox variant)</info>\n    <info>Behavior: Mass network scanning, credential brute force, process enumeration</info>\n    <info>Network Activity: 44,640+ remote host contacts</info>\n    <group>malware_hash,botnet,rondodox,credential_access,discovery,</group>\n    <mitre>\n      <id>T1110</id>\n      <id>T1046</id>\n      <id>T1057</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- SECTION 2: MIRAI/UPX-PACKED ELF DETECTION      -->\n  <!-- =============================================== -->\n\n  <rule id=\"100010\" level=\"10\">\n    <if_sid>554</if_sid>\n    <match>ELF</match>\n    <regex>UPX|upx</regex>\n    <description>UPX-packed ELF binary detected on system</description>\n    <info>UPX packing commonly used by Mirai and IoT botnet malware</info>\n    <group>file_monitoring,upx_detection,elf_malware,packer,</group>\n    <mitre>\n      <id>T1027.002</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100011\" level=\"12\">\n    <if_sid>100010</if_sid>\n    <field name=\"file_path\">/tmp|/dev/shm|/var/tmp</field>\n    <description>UPX-packed ELF binary in suspicious directory (potential Mirai dropper)</description>\n    <info>UPX-packed binaries in temporary directories indicate malware staging</info>\n    <group>file_monitoring,upx_detection,mirai,suspicious_location,</group>\n    <mitre>\n      <id>T1027.002</id>\n      <id>T1036</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100012\" level=\"8\">\n    <if_sid>550,554</if_sid>\n    <match>execve</match>\n    <regex>\\.\\/[a-zA-Z0-9]{5,10}\\.elf|\\.\\/[a-zA-Z0-9]{5,10}\\.bin</regex>\n    <description>Execution of randomly-named ELF binary (Mirai behavior pattern)</description>\n    <info>Mirai variants often use short random filenames for binaries</info>\n    <group>execution,mirai,botnet,suspicious_binary,</group>\n    <mitre>\n      <id>T1059.004</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100013\" level=\"11\">\n    <if_sid>550</if_sid>\n    <match>auditd</match>\n    <regex>syscall=socket.*inet6|AF_INET6</regex>\n    <field name=\"exe\">!/usr/bin|!/usr/sbin|!/bin|!/sbin</field>\n    <description>Suspicious IPv6 socket creation by non-standard binary (potential malware)</description>\n    <info>Matches YARA rule linux_generic_ipv6_catcher pattern</info>\n    <group>network_activity,ipv6_malware,suspicious_socket,</group>\n    <mitre>\n      <id>T1071.001</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- SECTION 3: BOTNET ACTIVITY DETECTION           -->\n  <!-- =============================================== -->\n\n  <rule id=\"100020\" level=\"8\">\n    <if_group>syslog</if_group>\n    <match>SYN_SENT|connection attempt</match>\n    <frequency>1000</frequency>\n    <timeframe>300</timeframe>\n    <description>Mass network connection attempts detected (>1000 in 5 min) - Possible botnet scanning</description>\n    <info>RondoDox and similar botnets contact 44,000+ hosts during scanning operations</info>\n    <group>botnet,network_scanning,mass_connection,</group>\n    <mitre>\n      <id>T1046</id>\n      <id>T1595.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100021\" level=\"10\">\n    <if_sid>100020</if_sid>\n    <field name=\"dstport\">22|23|445|3389|5555|8080|8081</field>\n    <description>Mass connection attempts to common exploitation ports - Botnet brute force activity</description>\n    <info>Targeting SSH(22), Telnet(23), SMB(445), RDP(3389), Android Debug(5555), HTTP proxies</info>\n    <group>botnet,brute_force,credential_access,rondodox,</group>\n    <mitre>\n      <id>T1110.001</id>\n      <id>T1110.003</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100022\" level=\"9\">\n    <if_sid>5712,5716</if_sid>\n    <frequency>50</frequency>\n    <timeframe>60</timeframe>\n    <description>Rapid authentication failures across multiple hosts - Credential brute force attack</description>\n    <info>Botnet credential stuffing or brute force campaign detected</info>\n    <group>authentication_failed,brute_force,botnet,credential_access,</group>\n    <mitre>\n      <id>T1110</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100023\" level=\"10\">\n    <if_sid>550</if_sid>\n    <match>execve</match>\n    <regex>ps\\s+(-e|aux|axu)|/proc/[0-9]+/|pidof|pgrep</regex>\n    <frequency>20</frequency>\n    <timeframe>60</timeframe>\n    <description>Rapid process enumeration detected - Botnet reconnaissance activity</description>\n    <info>Searching for security tools, competitors, or system information</info>\n    <group>discovery,process_enumeration,botnet,</group>\n    <mitre>\n      <id>T1057</id>\n      <id>T1518.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100024\" level=\"12\">\n    <if_sid>550</if_sid>\n    <match>connect</match>\n    <field name=\"syscall\">connect</field>\n    <frequency>5000</frequency>\n    <timeframe>600</timeframe>\n    <same_source_ip />\n    <description>CRITICAL: Extreme network connection rate (>5000 in 10 min) - Active botnet node</description>\n    <info>Network behavior consistent with RondoDox mass scanning operations</info>\n    <group>botnet,mass_connection,active_infection,rondodox,</group>\n    <mitre>\n      <id>T1046</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- SECTION 4: EDR KILLER DETECTION (BYOVD)        -->\n  <!-- =============================================== -->\n\n  <rule id=\"100030\" level=\"12\">\n    <if_sid>61603,61612</if_sid>\n    <regex>\\\\[a-zA-Z]{5}\\.sys|\\\\[0-9]{5}\\.sys</regex>\n    <description>Driver loaded with suspicious 5-character random name - Possible EDR killer (BYOVD)</description>\n    <info>8+ ransomware groups use BYOVD technique with 5-char driver names</info>\n    <group>edr_killer,byovd,driver_load,defense_evasion,</group>\n    <mitre>\n      <id>T1068</id>\n      <id>T1562.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100031\" level=\"14\">\n    <if_sid>61603,61612</if_sid>\n    <regex>\\\\[a-zA-Z]{5}\\.sys</regex>\n    <if_match_sid>100032</if_match_sid>\n    <description>CRITICAL: EDR killer driver loaded followed by security service termination</description>\n    <info>BYOVD attack chain: vulnerable driver + security product termination</info>\n    <group>edr_killer,byovd,attack_chain,defense_evasion,</group>\n    <mitre>\n      <id>T1068</id>\n      <id>T1562.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100032\" level=\"11\">\n    <if_group>windows,sysmon_event1</if_group>\n    <match>sc.exe stop|net stop|taskkill</match>\n    <regex>MsMpEng|CylanceSvc|SentinelAgent|CSFalconService|McAfee|Norton|Kaspersky|ESET|Sophos|Trend Micro|Carbon Black|Defender</regex>\n    <description>Attempted termination of EDR/AV security service</description>\n    <info>Common EDR killer behavior targeting endpoint protection</info>\n    <group>edr_killer,defense_evasion,service_stop,</group>\n    <mitre>\n      <id>T1562.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100033\" level=\"13\">\n    <if_sid>61603</if_sid>\n    <regex>RTCore64\\.sys|gdrv\\.sys|AsrDrv10[0-9]\\.sys|DBUtil_2_3\\.sys|PROCEXP152\\.SYS|kernelcheatsys\\.sys</regex>\n    <description>Known vulnerable driver loaded - BYOVD technique detected</description>\n    <info>These drivers are commonly abused for privilege escalation and EDR termination</info>\n    <group>edr_killer,byovd,vulnerable_driver,known_bad,</group>\n    <mitre>\n      <id>T1068</id>\n      <id>T1543.003</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100034\" level=\"10\">\n    <if_group>windows,sysmon_event1</if_group>\n    <match>sc.exe create</match>\n    <regex>type=\\s*kernel|binPath=.*\\.sys</regex>\n    <description>Kernel driver service creation detected - Potential BYOVD preparation</description>\n    <info>Service creation for kernel driver - validate legitimacy</info>\n    <group>driver_load,service_creation,byovd,</group>\n    <mitre>\n      <id>T1543.003</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- SECTION 5: CREDENTIAL THEFT DETECTION (T1555)  -->\n  <!-- =============================================== -->\n\n  <rule id=\"100040\" level=\"11\">\n    <if_group>sysmon_event_10</if_group>\n    <field name=\"TargetImage\">\\\\Google\\\\Chrome\\\\Application\\\\chrome\\.exe|\\\\Mozilla Firefox\\\\firefox\\.exe|\\\\Microsoft\\\\Edge\\\\Application\\\\msedge\\.exe</field>\n    <field name=\"SourceImage\">!\\\\Google\\\\Chrome\\\\|!\\\\Mozilla Firefox\\\\|!\\\\Microsoft\\\\Edge\\\\</field>\n    <description>Suspicious process accessing browser memory - Potential credential theft (T1555)</description>\n    <info>3X increase in T1555 malware targeting browser credential stores</info>\n    <group>credential_theft,browser_credentials,t1555,memory_access,</group>\n    <mitre>\n      <id>T1555.003</id>\n      <id>T1555</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100041\" level=\"12\">\n    <if_sid>554</if_sid>\n    <field name=\"file_path\">\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\User Data\\\\.*\\\\Login Data|\\\\AppData\\\\Roaming\\\\Mozilla\\\\Firefox\\\\Profiles\\\\.*\\\\logins\\.json|\\\\AppData\\\\Local\\\\Microsoft\\\\Edge\\\\User Data\\\\.*\\\\Login Data</field>\n    <field name=\"process\">!chrome\\.exe|!firefox\\.exe|!msedge\\.exe|!brave\\.exe</field>\n    <description>Unauthorized access to browser credential database - Active credential theft</description>\n    <info>Non-browser process accessing Login Data or logins.json files</info>\n    <group>credential_theft,browser_credentials,t1555,file_access,</group>\n    <mitre>\n      <id>T1555.003</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100042\" level=\"13\">\n    <if_sid>554</if_sid>\n    <field name=\"file_path\">\\\\AppData\\\\Local\\\\Microsoft\\\\Vault|\\\\AppData\\\\Roaming\\\\Microsoft\\\\Vault|\\\\AppData\\\\Local\\\\Microsoft\\\\Credentials</field>\n    <regex>vaultcmd|VaultPasswordV1\\.dat|Policy\\.vpol</regex>\n    <description>Windows Vault or Credential Manager access detected - Credential harvesting</description>\n    <info>Access to Windows stored credentials (T1555.004)</info>\n    <group>credential_theft,windows_vault,t1555,credential_manager,</group>\n    <mitre>\n      <id>T1555.004</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100043\" level=\"12\">\n    <if_group>sysmon_event1</if_group>\n    <regex>cmdkey\\s+/list|vaultcmd\\s+/list|Get-VaultCredential|Get-StoredCredential</regex>\n    <description>Credential enumeration command executed - Credential discovery activity</description>\n    <info>Listing stored credentials using native Windows tools</info>\n    <group>credential_theft,credential_enumeration,t1555,discovery,</group>\n    <mitre>\n      <id>T1555</id>\n      <id>T1087</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100044\" level=\"11\">\n    <if_group>sysmon_event_11</if_group>\n    <regex>passwords\\.txt|credentials\\.txt|logins\\.txt|creds\\.txt|dump\\.txt</regex>\n    <field name=\"file_path\">\\\\AppData\\\\Local\\\\Temp|\\\\Users\\\\Public|C:\\\\Temp</field>\n    <description>Suspicious credential dump file created - Credential exfiltration staging</description>\n    <info>Credential theft often stages harvested data in temp directories</info>\n    <group>credential_theft,data_staging,exfiltration,t1555,</group>\n    <mitre>\n      <id>T1555</id>\n      <id>T1074.001</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100045\" level=\"10\">\n    <if_group>linux,auditd</if_group>\n    <field name=\"file_path\">.mozilla/firefox/.*/logins.json|.config/google-chrome/.*/Login Data|.config/chromium/.*/Login Data</field>\n    <field name=\"syscall\">open|openat</field>\n    <description>Linux browser credential file access detected - Potential credential theft</description>\n    <info>Access to Firefox/Chrome credential stores on Linux systems</info>\n    <group>credential_theft,browser_credentials,linux,t1555,</group>\n    <mitre>\n      <id>T1555.003</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- SECTION 6: RANSOMWARE BEHAVIOR DETECTION       -->\n  <!-- =============================================== -->\n\n  <rule id=\"100050\" level=\"12\">\n    <if_sid>554</if_sid>\n    <regex>\\.encrypted$|\\.locked$|\\.crypto$|\\.crypt$|\\.lockbit$|\\.lynx$|\\.vanhelsing$</regex>\n    <frequency>50</frequency>\n    <timeframe>60</timeframe>\n    <description>Mass file encryption activity detected - Active ransomware attack</description>\n    <info>Rapid creation of encrypted file extensions indicates ransomware</info>\n    <group>ransomware,file_encryption,lockbit,lynx,vanhelsing,</group>\n    <mitre>\n      <id>T1486</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100051\" level=\"14\">\n    <if_sid>554</if_sid>\n    <regex>READ_ME\\.txt|HOW_TO_DECRYPT\\.txt|RECOVERY_INSTRUCTIONS\\.txt|ransom\\.txt|README\\.txt|DECRYPT\\.txt</regex>\n    <field name=\"file_path\">\\\\Desktop\\\\|\\\\Users\\\\|C:\\\\|D:\\\\</field>\n    <description>CRITICAL: Ransom note created - Ransomware attack confirmed</description>\n    <info>Ransom note creation in common locations (LockBit, VanHelsing, Lynx patterns)</info>\n    <group>ransomware,ransom_note,lockbit,lynx,vanhelsing,</group>\n    <mitre>\n      <id>T1486</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100052\" level=\"13\">\n    <if_group>sysmon_event1</if_group>\n    <regex>vssadmin\\.exe.*delete.*shadows|wmic.*shadowcopy.*delete|bcdedit.*recoveryenabled.*no|wbadmin.*delete.*catalog</regex>\n    <description>Shadow copy/backup deletion detected - Ransomware anti-recovery technique</description>\n    <info>Preventing recovery by deleting volume shadow copies and backups</info>\n    <group>ransomware,anti_recovery,shadow_copy,defense_evasion,</group>\n    <mitre>\n      <id>T1490</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100053\" level=\"11\">\n    <if_group>sysmon_event1</if_group>\n    <regex>cipher\\.exe\\s+/w|sdelete|wipe|shred</regex>\n    <description>Secure file deletion tool executed - Data destruction or anti-forensics</description>\n    <info>Ransomware may use secure deletion to remove recovery options</info>\n    <group>ransomware,anti_forensics,data_destruction,</group>\n    <mitre>\n      <id>T1485</id>\n      <id>T1070.004</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100054\" level=\"12\">\n    <if_sid>554</if_sid>\n    <match>file modification</match>\n    <frequency>500</frequency>\n    <timeframe>120</timeframe>\n    <same_source_ip />\n    <description>Extreme file modification rate (>500 in 2 min) - Ransomware encryption in progress</description>\n    <info>Mass file modifications indicate active encryption process</info>\n    <group>ransomware,mass_encryption,file_modification,</group>\n    <mitre>\n      <id>T1486</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100055\" level=\"10\">\n    <if_group>sysmon_event1</if_group>\n    <regex>net\\.exe\\s+stop.*sql|net\\.exe\\s+stop.*backup|net\\.exe\\s+stop.*vss</regex>\n    <description>Critical service termination - Ransomware preparation activity</description>\n    <info>Stopping SQL, backup, or VSS services before encryption</info>\n    <group>ransomware,service_stop,pre_encryption,</group>\n    <mitre>\n      <id>T1489</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- SECTION 7: SHAREPOINT EXPLOITATION DETECTION   -->\n  <!-- CVE-2025-53770 / CVE-2025-53771                -->\n  <!-- =============================================== -->\n\n  <rule id=\"100060\" level=\"11\">\n    <if_sid>31100,31101,31103</if_sid>\n    <match>/_vti_bin/</match>\n    <field name=\"status\">200|401|403</field>\n    <field name=\"auth\">^-$|^$</field>\n    <description>Unauthenticated access to SharePoint _vti_bin endpoint - Potential CVE-2025-53770 exploitation</description>\n    <info>SharePoint RCE vulnerability targeting /_vti_bin/ paths without authentication</info>\n    <group>sharepoint,web_attack,cve_2025_53770,rce,</group>\n    <mitre>\n      <id>T1190</id>\n      <id>T1059</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100061\" level=\"13\">\n    <if_sid>31100,31101,31103</if_sid>\n    <match>/_vti_bin/</match>\n    <regex>Referer:.*sharepoint\\.com|Referer:.*office\\.com</regex>\n    <field name=\"status\">200</field>\n    <description>SharePoint exploitation with forged Referer header - Active CVE-2025-53770 attack</description>\n    <info>Forged Referer headers used to bypass SharePoint authentication checks</info>\n    <group>sharepoint,web_attack,cve_2025_53770,authentication_bypass,</group>\n    <mitre>\n      <id>T1190</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100062\" level=\"12\">\n    <if_sid>31100,31101</if_sid>\n    <regex>deserialization|SerializationException|BinaryFormatter|ObjectStateFormatter</regex>\n    <match>/_vti_bin/|/_layouts/</match>\n    <description>SharePoint deserialization error detected - Possible exploitation attempt (CVE-2025-53771)</description>\n    <info>Deserialization vulnerabilities in SharePoint can lead to RCE</info>\n    <group>sharepoint,deserialization,cve_2025_53771,rce,</group>\n    <mitre>\n      <id>T1190</id>\n      <id>T1203</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100063\" level=\"10\">\n    <if_sid>31100,31101</if_sid>\n    <match>/_vti_bin/</match>\n    <frequency>20</frequency>\n    <timeframe>60</timeframe>\n    <same_source_ip />\n    <description>Rapid SharePoint _vti_bin endpoint scanning - Vulnerability probing</description>\n    <info>Multiple requests to SharePoint endpoints may indicate exploitation attempts</info>\n    <group>sharepoint,web_scanning,reconnaissance,</group>\n    <mitre>\n      <id>T1595.002</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100064\" level=\"14\">\n    <if_sid>31100,31101</if_sid>\n    <regex>cmd\\.exe|powershell\\.exe|/bin/bash|/bin/sh</regex>\n    <match>/_vti_bin/|/_layouts/</match>\n    <field name=\"status\">200|500|502</field>\n    <description>CRITICAL: Command execution pattern in SharePoint request - RCE exploitation detected</description>\n    <info>SharePoint RCE attack in progress (CVE-2025-53770/53771)</info>\n    <group>sharepoint,rce,web_attack,critical,cve_2025_53770,</group>\n    <mitre>\n      <id>T1190</id>\n      <id>T1059.003</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100065\" level=\"12\">\n    <if_sid>31100,31101</if_sid>\n    <match>/_vti_bin/spdisco.aspx|/_vti_bin/Lists.asmx|/_vti_bin/SharePointProjectService.svc</match>\n    <field name=\"method\">POST</field>\n    <field name=\"content-type\">text/xml|application/soap</field>\n    <description>Suspicious SOAP/XML POST to SharePoint web service - Potential deserialization attack</description>\n    <info>SOAP endpoints vulnerable to deserialization attacks (CVE-2025-53771)</info>\n    <group>sharepoint,web_attack,deserialization,cve_2025_53771,</group>\n    <mitre>\n      <id>T1190</id>\n      <id>T1203</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100066\" level=\"11\">\n    <if_sid>31100,31101</if_sid>\n    <match>/_layouts/</match>\n    <regex>__VIEWSTATE|__EVENTVALIDATION</regex>\n    <field name=\"content-length\">10000:</field>\n    <description>Large ViewState payload in SharePoint request - Possible deserialization exploit</description>\n    <info>Oversized ViewState may contain malicious deserialization payloads</info>\n    <group>sharepoint,deserialization,web_attack,</group>\n    <mitre>\n      <id>T1190</id>\n    </mitre>\n  </rule>\n\n  <!-- =============================================== -->\n  <!-- COMPOSITE/CORRELATION RULES                     -->\n  <!-- =============================================== -->\n\n  <rule id=\"100070\" level=\"15\">\n    <if_matched_sid>100000,100001,100002</if_matched_sid>\n    <if_matched_sid>100020,100021,100024</if_matched_sid>\n    <timeframe>600</timeframe>\n    <description>CRITICAL: Known malware hash detected with active botnet behavior - Confirmed infection</description>\n    <info>System infected with known malware sample exhibiting botnet activity</info>\n    <group>malware_confirmed,active_infection,botnet,critical,</group>\n    <mitre>\n      <id>T1071</id>\n      <id>T1110</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100071\" level=\"15\">\n    <if_matched_sid>100030,100031,100033</if_matched_sid>\n    <if_matched_sid>100050,100051,100052</if_matched_sid>\n    <timeframe>1800</timeframe>\n    <description>CRITICAL: EDR killer + ransomware attack chain detected - Immediate response required</description>\n    <info>Multi-stage ransomware attack: EDR termination followed by encryption</info>\n    <group>ransomware,edr_killer,attack_chain,critical,</group>\n    <mitre>\n      <id>T1562.001</id>\n      <id>T1486</id>\n    </mitre>\n  </rule>\n\n  <rule id=\"100072\" level=\"14\">\n    <if_matched_sid>100040,100041,100042</if_matched_sid>\n    <if_matched_sid>100044</if_matched_sid>\n    <timeframe>900</timeframe>\n    <description>CRITICAL: Credential theft and data staging detected - Active information stealing</description>\n    <info>Complete credential theft attack chain: harvesting + staging for exfiltration</info>\n    <group>credential_theft,data_staging,attack_chain,t1555,</group>\n    <mitre>\n      <id>T1555</id>\n      <id>T1074</id>\n    </mitre>\n  </rule>\n\n</group>\n","structuredPatch":[],"originalFile":null}}
{"parentUuid":"84ce1431-eee2-4da8-9528-c7af703aeee5","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_018pdhq4kh2URF3ukyL1Fbs4","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create comprehensive documentation for these rules:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":8121,"cache_read_input_tokens":24947,"cache_creation":{"ephemeral_5m_input_tokens":8121,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CVXtYeR7aRMUDw3gXCevJ","type":"assistant","uuid":"b6c9b8f0-cea2-4094-916e-80c61428b3ba","timestamp":"2025-11-27T06:04:38.440Z"}
{"parentUuid":"b6c9b8f0-cea2-4094-916e-80c61428b3ba","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_018pdhq4kh2URF3ukyL1Fbs4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0114LCMu22SLixeuRKyT1fc4","name":"Write","input":{"file_path":"/home/stanner/wazuh_rules_documentation.md","content":"# Wazuh Malware Detection Rules - Implementation Guide\n\n**Version:** 1.0\n**Date:** 2025-11-27\n**Rule ID Range:** 100000-100099\n**Author:** Wazuh Threat Detection Engineering\n\n## Executive Summary\n\nThis ruleset provides comprehensive detection coverage for emerging malware threats identified on November 27, 2025, including:\n\n- **Mirai botnet variants** (UPX-packed ELF binaries)\n- **RondoDox botnet** (mass network scanning and credential brute force)\n- **EDR killer techniques** (BYOVD - Bring Your Own Vulnerable Driver)\n- **Credential theft malware** (T1555 - 3X surge in browser credential harvesting)\n- **Ransomware behaviors** (LockBit 5.0, VanHelsing RaaS, Lynx)\n- **SharePoint exploitation** (CVE-2025-53770/53771 RCE vulnerabilities)\n\n---\n\n## Table of Contents\n\n1. [Rule Categories and Coverage](#rule-categories-and-coverage)\n2. [Integration Requirements](#integration-requirements)\n3. [Rule-by-Rule Analysis](#rule-by-rule-analysis)\n4. [Testing and Validation](#testing-and-validation)\n5. [False Positive Mitigation](#false-positive-mitigation)\n6. [Tuning Recommendations](#tuning-recommendations)\n7. [Response Playbooks](#response-playbooks)\n\n---\n\n## Rule Categories and Coverage\n\n### Category 1: File Hash Detection (Rules 100000-100002)\n\n**Threat Context:**\nThree specific malware samples identified in recent threat intelligence:\n\n| Hash | Type | Threat Level | Detection Rate |\n|------|------|--------------|----------------|\n| b6873744... | Mirai (UPX-packed) | High (12) | 23.68% |\n| 7e5fbce9... | ARM malware | Critical (13) | 75% confidence |\n| 5c2bbb00... | RondoDox botnet | Critical (14) | High behavioral indicators |\n\n**Detection Approach:**\n- **Rule 100000:** Direct SHA256 hash match for Mirai UPX-packed ELF\n- **Rule 100001:** SHA256 match for ARM architecture malware with IPv6 capabilities\n- **Rule 100002:** SHA256 match for RondoDox botnet/scanner variant\n\n**Log Source Requirements:**\n- Wazuh FIM (File Integrity Monitoring) with SHA256 hashing enabled\n- Syscheck configured to monitor critical directories: `/tmp`, `/dev/shm`, `/var/tmp`, `/usr/bin`, `/usr/sbin`\n\n**Rationale:**\nHash-based detection provides immediate identification of known threats. These three samples represent active threats with varying AV detection rates (23-75%), making behavioral detection crucial as a complementary control.\n\n---\n\n### Category 2: Mirai/UPX-Packed ELF Detection (Rules 100010-100013)\n\n**Threat Context:**\nMirai and IoT botnets commonly use UPX packing to evade detection. The first sample (b6873744...) is a UPX-packed Mirai variant targeting Linux IoT devices.\n\n**Detection Logic:**\n\n**Rule 100010** (Level 10):\n- Detects any UPX-packed ELF binary on the system\n- Uses file content matching for \"ELF\" + \"UPX\" strings\n- **Low severity** as legitimate software may use UPX\n\n**Rule 100011** (Level 12):\n- Triggers on UPX binaries in suspicious directories: `/tmp`, `/dev/shm`, `/var/tmp`\n- **Medium-high severity** as this indicates staging behavior\n- Malware often downloads to temp directories for execution\n\n**Rule 100012** (Level 8):\n- Detects execution of randomly-named binaries (`.elf`, `.bin` with 5-10 char names)\n- Matches Mirai dropper naming convention\n- Uses `execve` syscall monitoring via auditd\n\n**Rule 100013** (Level 11):\n- Identifies IPv6 socket creation by non-standard binaries\n- Correlates with YARA signature `linux_generic_ipv6_catcher`\n- Sample 7e5fbce9... matches this pattern\n\n**Log Source Requirements:**\n- FIM monitoring `/tmp`, `/dev/shm`, `/var/tmp`, `/home`, `/root`\n- auditd configured for syscall monitoring (`execve`, `socket`, `connect`)\n- File type inspection enabled in Wazuh syscheck\n\n**False Positive Considerations:**\n- Legitimate software may use UPX (games, older utilities)\n- **Mitigation:** Whitelist known legitimate UPX binaries by hash or path\n- IoT devices may have legitimate custom binaries\n- **Mitigation:** Baseline normal IoT device behavior first\n\n---\n\n### Category 3: Botnet Activity Detection (Rules 100020-100024)\n\n**Threat Context:**\nRondoDox botnet (sample 5c2bbb00...) exhibits extreme network behavior:\n- Contacts 44,640+ remote hosts during scanning operations\n- Conducts credential brute force on SSH, Telnet, RDP, SMB\n- Performs process enumeration to identify security tools\n\n**Detection Logic:**\n\n**Rule 100020** (Level 8):\n- **Threshold:** >1000 connection attempts in 5 minutes\n- Detects initial mass scanning behavior\n- Uses frequency analysis of `SYN_SENT` states or connection attempts\n\n**Rule 100021** (Level 10):\n- **Enhancement** to 100020 targeting exploitation ports\n- Ports: 22 (SSH), 23 (Telnet), 445 (SMB), 3389 (RDP), 5555 (ADB), 8080/8081 (HTTP)\n- Higher severity due to clear malicious intent\n\n**Rule 100022** (Level 9):\n- **Threshold:** 50+ authentication failures in 60 seconds\n- Detects credential brute force campaigns\n- Correlates with Wazuh auth failure rules (5712, 5716)\n\n**Rule 100023** (Level 10):\n- **Threshold:** 20+ process enumeration commands in 60 seconds\n- Commands: `ps`, `/proc/` access, `pidof`, `pgrep`\n- Indicates reconnaissance for security tools\n\n**Rule 100024** (Level 12):\n- **CRITICAL threshold:** >5000 connections in 10 minutes\n- Confirms active botnet infection\n- Matches RondoDox behavioral profile\n\n**Log Source Requirements:**\n- Network connection logging (iptables/nftables logs, netflow, or conntrack)\n- Authentication logs (SSH: `/var/log/auth.log`, Windows: Security Event ID 4625)\n- auditd monitoring `connect()` syscalls\n- Process execution monitoring\n\n**Tuning Recommendations:**\n- Adjust thresholds based on normal network behavior\n- High-traffic servers may need higher thresholds\n- Consider time-of-day baselines (scanning often occurs during off-hours)\n\n---\n\n### Category 4: EDR Killer Detection (Rules 100030-100034)\n\n**Threat Context:**\n8+ ransomware groups now use BYOVD (Bring Your Own Vulnerable Driver) technique:\n- Load vulnerable signed drivers (RTCore64.sys, gdrv.sys, etc.)\n- Exploit driver vulnerabilities to gain kernel privileges\n- Terminate EDR/AV processes to evade detection\n- **Signature:** Random 5-character driver names\n\n**Detection Logic:**\n\n**Rule 100030** (Level 12):\n- Detects driver loading with 5-character random names (e.g., `abcde.sys`, `12345.sys`)\n- Monitors Windows Event ID 6 (driver load) via Sysmon Event ID 6\n- **High severity** as this is a strong ransomware indicator\n\n**Rule 100031** (Level 14):\n- **CRITICAL correlation rule**\n- Combines driver load (100030) + security service termination (100032)\n- Confirms multi-stage BYOVD attack chain\n\n**Rule 100032** (Level 11):\n- Detects termination of EDR/AV services\n- Commands: `sc.exe stop`, `net stop`, `taskkill`\n- Targets: MsMpEng (Defender), CrowdStrike, SentinelOne, Carbon Black, etc.\n\n**Rule 100033** (Level 13):\n- Identifies known vulnerable drivers by exact filename\n- Drivers: RTCore64.sys, gdrv.sys, AsrDrv10x.sys, DBUtil_2_3.sys, PROCEXP152.SYS\n- **High confidence** as these are documented BYOVD targets\n\n**Rule 100034** (Level 10):\n- Detects kernel driver service creation\n- Command: `sc.exe create` with `type=kernel` or `binPath=*.sys`\n- **Early warning** of driver installation\n\n**Log Source Requirements:**\n- **Windows:** Sysmon Event ID 6 (driver load), Event ID 1 (process creation)\n- **Windows:** System Event Log for service state changes\n- **Windows:** Security Event Log for service installation (Event ID 4697)\n\n**False Positive Mitigation:**\n- Legitimate drivers may have short names (audio, network drivers)\n- **Whitelist:** Known legitimate driver hashes using Sysmon hash matching\n- Security tools may load their own drivers\n- **Whitelist:** Paths like `C:\\Program Files\\` for known security vendors\n- System updates may install drivers\n- **Correlation:** Check for signed drivers from Microsoft/OEM vendors\n\n**Response Actions:**\n1. **Immediate isolation** of affected endpoint\n2. Memory dump for forensic analysis\n3. Verify driver digital signature (`sigcheck.exe -h`)\n4. Check driver hash against threat intelligence (VirusTotal)\n5. Restore from last known-good backup if encryption occurred\n\n---\n\n### Category 5: Credential Theft Detection (Rules 100040-100045)\n\n**Threat Context:**\n**3X increase** in T1555 (Credentials from Password Stores) malware:\n- Browser credential databases (Chrome, Firefox, Edge)\n- Windows Vault and Credential Manager\n- Linux credential stores\n\n**Detection Logic:**\n\n**Rule 100040** (Level 11):\n- Detects suspicious process memory access to browsers\n- Uses Sysmon Event ID 10 (process access)\n- **Indicator:** Non-browser process accessing browser memory\n\n**Rule 100041** (Level 12):\n- Detects file access to browser credential databases\n- Paths:\n  - Chrome: `\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data`\n  - Firefox: `\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\*\\logins.json`\n  - Edge: `\\AppData\\Local\\Microsoft\\Edge\\User Data\\Default\\Login Data`\n- **Excludes:** Browser executables themselves\n\n**Rule 100042** (Level 13):\n- Detects access to Windows Vault/Credential Manager\n- Paths: `\\AppData\\Local\\Microsoft\\Vault`, `\\AppData\\Roaming\\Microsoft\\Vault`\n- Files: `VaultPasswordV1.dat`, `Policy.vpol`\n- **High severity** as this is sensitive credential storage\n\n**Rule 100043** (Level 12):\n- Detects credential enumeration commands\n- Commands: `cmdkey /list`, `vaultcmd /list`, PowerShell `Get-VaultCredential`\n- **Discovery phase** of credential theft\n\n**Rule 100044** (Level 11):\n- Detects creation of credential dump files\n- Filenames: `passwords.txt`, `credentials.txt`, `logins.txt`, `creds.txt`\n- Locations: `\\AppData\\Local\\Temp`, `\\Users\\Public`, `C:\\Temp`\n- **Staging for exfiltration**\n\n**Rule 100045** (Level 10):\n- **Linux version** of browser credential theft\n- Paths: `.mozilla/firefox/*/logins.json`, `.config/google-chrome/*/Login Data`\n- Monitors `open()` and `openat()` syscalls via auditd\n\n**Log Source Requirements:**\n- **Windows:** Sysmon Event ID 10 (process access), Event ID 11 (file creation)\n- **Windows:** FIM monitoring credential directories\n- **Linux:** auditd monitoring file access (`open`, `openat`, `read`)\n- **Linux:** FIM monitoring `~/.mozilla`, `~/.config/google-chrome`\n\n**False Positive Scenarios:**\n- Password managers accessing credential stores (LastPass, 1Password)\n- **Mitigation:** Whitelist known password manager executables\n- Browser sync processes accessing databases\n- **Mitigation:** Whitelist browser sync services by process name\n- Backup software accessing user directories\n- **Mitigation:** Whitelist backup agents by path and signature\n\n**Response Actions:**\n1. **Force password reset** for all accounts on affected system\n2. Review authentication logs for account compromise\n3. Check for data exfiltration (network connections, USB usage)\n4. Scan for infostealer malware (RedLine, Raccoon, Vidar)\n5. Enable MFA on all accounts\n\n---\n\n### Category 6: Ransomware Behavior Detection (Rules 100050-100055)\n\n**Threat Context:**\nEmerging ransomware families in November 2025:\n- **LockBit 5.0** (most prolific)\n- **VanHelsing RaaS** (Ransomware-as-a-Service)\n- **Lynx** (new variant)\n\n**Detection Logic:**\n\n**Rule 100050** (Level 12):\n- **Threshold:** 50+ files encrypted in 60 seconds\n- File extensions: `.encrypted`, `.locked`, `.crypto`, `.crypt`, `.lockbit`, `.lynx`, `.vanhelsing`\n- **High confidence** ransomware indicator\n\n**Rule 100051** (Level 14):\n- **CRITICAL:** Ransom note creation\n- Filenames: `READ_ME.txt`, `HOW_TO_DECRYPT.txt`, `RECOVERY_INSTRUCTIONS.txt`\n- Locations: Desktop, user directories, drive roots\n- **Confirms active ransomware attack**\n\n**Rule 100052** (Level 13):\n- Detects shadow copy/backup deletion\n- Commands:\n  - `vssadmin delete shadows`\n  - `wmic shadowcopy delete`\n  - `bcdedit /set recoveryenabled no`\n  - `wbadmin delete catalog`\n- **Anti-recovery technique**\n\n**Rule 100053** (Level 11):\n- Detects secure file deletion tools\n- Tools: `cipher.exe /w`, `sdelete`, `wipe`, `shred`\n- **Data destruction or anti-forensics**\n\n**Rule 100054** (Level 12):\n- **Threshold:** 500+ file modifications in 2 minutes\n- **Extreme** file activity indicating mass encryption\n- Higher threshold than 100050 for different data sources\n\n**Rule 100055** (Level 10):\n- Detects service termination preparation\n- Targets: SQL servers, backup services, VSS\n- Commands: `net stop sql`, `net stop backup`, `net stop vss`\n- **Pre-encryption phase**\n\n**Log Source Requirements:**\n- **Windows:** FIM with high-frequency file monitoring\n- **Windows:** Sysmon Event ID 1 (process creation) for commands\n- **Windows:** Sysmon Event ID 11 (file creation) for ransom notes\n- **Windows:** File modification event tracking\n\n**Detection Challenges:**\n- Legitimate mass file operations (backup, indexing)\n- **Mitigation:** Whitelist known backup/indexing processes\n- Developers may create test files with similar names\n- **Mitigation:** Scope monitoring to production systems\n- Compression tools may modify many files\n- **Mitigation:** Check for actual encryption vs. compression\n\n**Immediate Response Actions:**\n1. **Isolate endpoint** from network immediately\n2. **DO NOT** shut down (preserve memory evidence)\n3. Identify ransomware variant (ransom note analysis)\n4. Check backups and shadow copies for recovery\n5. Engage incident response team\n6. Report to law enforcement if required\n7. **DO NOT PAY RANSOM** without executive approval\n\n---\n\n### Category 7: SharePoint Exploitation Detection (Rules 100060-100066)\n\n**Threat Context:**\n**CVE-2025-53770 / CVE-2025-53771** - Critical SharePoint RCE vulnerabilities:\n- Targets `/_vti_bin/` SOAP endpoints\n- Deserialization vulnerabilities in SharePoint web services\n- Authentication bypass via forged Referer headers\n- **Actively exploited in the wild**\n\n**Detection Logic:**\n\n**Rule 100060** (Level 11):\n- Detects unauthenticated access to `/_vti_bin/` paths\n- **Indicator:** HTTP 200/401/403 with empty authentication field\n- Baseline for SharePoint exploitation attempts\n\n**Rule 100061** (Level 13):\n- **Enhanced detection:** Forged Referer header\n- Referer values: `sharepoint.com`, `office.com`\n- HTTP 200 status indicates successful bypass\n- **Active exploitation**\n\n**Rule 100062** (Level 12):\n- Detects deserialization errors in logs\n- Keywords: `deserialization`, `SerializationException`, `BinaryFormatter`, `ObjectStateFormatter`\n- Paths: `/_vti_bin/`, `/_layouts/`\n- **CVE-2025-53771 exploitation**\n\n**Rule 100063** (Level 10):\n- **Threshold:** 20+ requests to `/_vti_bin/` in 60 seconds\n- Indicates vulnerability scanning/probing\n- **Reconnaissance phase**\n\n**Rule 100064** (Level 14):\n- **CRITICAL:** Command execution patterns in requests\n- Strings: `cmd.exe`, `powershell.exe`, `/bin/bash`, `/bin/sh`\n- HTTP status 200/500/502 (successful or error during execution)\n- **Confirmed RCE exploitation**\n\n**Rule 100065** (Level 12):\n- Targets specific vulnerable SOAP endpoints\n- Endpoints: `spdisco.aspx`, `Lists.asmx`, `SharePointProjectService.svc`\n- Method: POST with `text/xml` or `application/soap` content-type\n- **Deserialization attack vector**\n\n**Rule 100066** (Level 11):\n- Detects oversized ViewState payloads\n- Size threshold: >10,000 bytes\n- Contains `__VIEWSTATE` or `__EVENTVALIDATION`\n- **Malicious deserialization payload**\n\n**Log Source Requirements:**\n- **IIS:** Web server access logs (W3C format)\n- **SharePoint:** ULS logs (Unified Logging Service)\n- **SharePoint:** Application Event Logs\n- **Network:** Web application firewall (WAF) logs\n\n**False Positive Mitigation:**\n- Legitimate SharePoint API usage may access `/_vti_bin/`\n- **Mitigation:** Whitelist known service accounts and internal IPs\n- Developers may test SharePoint web services\n- **Mitigation:** Exclude development environments\n- SharePoint Designer uses `_vti_bin` endpoints\n- **Mitigation:** Identify and whitelist Designer connections\n\n**Emergency Response Actions:**\n1. **Block source IP** at firewall immediately\n2. **Disable affected SharePoint web services** temporarily\n3. Apply emergency patches (CVE-2025-53770/53771)\n4. Review IIS logs for successful exploitation (HTTP 200)\n5. Check for web shells: `*.aspx`, `*.ashx` in SharePoint directories\n6. Restore from last known-good backup if compromised\n7. Force password resets for all SharePoint service accounts\n\n---\n\n### Category 8: Composite/Correlation Rules (Rules 100070-100072)\n\n**Purpose:**\nDetect multi-stage attack chains by correlating multiple detection events.\n\n**Rule 100070** (Level 15):\n- **Combination:** Known malware hash + active botnet behavior\n- Timeframe: 10 minutes\n- **Confirms:** System is infected and actively participating in botnet operations\n- **Action:** Immediate quarantine required\n\n**Rule 100071** (Level 15):\n- **Combination:** EDR killer + ransomware behavior\n- Timeframe: 30 minutes\n- **Attack chain:** BYOVD  EDR termination  encryption\n- **Action:** Emergency incident response activation\n\n**Rule 100072** (Level 14):\n- **Combination:** Credential theft + data staging\n- Timeframe: 15 minutes\n- **Attack chain:** Credential harvesting  staging for exfiltration\n- **Action:** Network isolation and credential reset\n\n---\n\n## Integration Requirements\n\n### 1. Wazuh Agent Configuration\n\n**Linux Systems:**\n\n```xml\n<!-- /var/ossec/etc/ossec.conf -->\n<syscheck>\n  <directories check_all=\"yes\" realtime=\"yes\" report_changes=\"yes\">/tmp</directories>\n  <directories check_all=\"yes\" realtime=\"yes\">/dev/shm</directories>\n  <directories check_all=\"yes\" realtime=\"yes\">/var/tmp</directories>\n  <directories check_all=\"yes\">/usr/bin,/usr/sbin,/bin,/sbin</directories>\n  <directories check_all=\"yes\">~/.mozilla/firefox</directories>\n  <directories check_all=\"yes\">~/.config/google-chrome</directories>\n</syscheck>\n\n<localfile>\n  <log_format>audit</log_format>\n  <location>/var/log/audit/audit.log</location>\n</localfile>\n```\n\n**auditd Rules:**\n\n```bash\n# /etc/audit/rules.d/wazuh-malware.rules\n\n# Monitor execve syscalls for suspicious binary execution\n-a always,exit -F arch=b64 -S execve -F key=execve_monitor\n\n# Monitor socket creation (IPv6 malware)\n-a always,exit -F arch=b64 -S socket -F a0=10 -F key=ipv6_socket\n\n# Monitor connect syscalls (botnet activity)\n-a always,exit -F arch=b64 -S connect -F key=connect_monitor\n\n# Monitor file access to credential stores\n-w ~/.mozilla/firefox/ -p r -k firefox_creds\n-w ~/.config/google-chrome/ -p r -k chrome_creds\n```\n\n**Windows Systems:**\n\n```xml\n<!-- C:\\Program Files (x86)\\ossec-agent\\ossec.conf -->\n<syscheck>\n  <directories check_all=\"yes\" realtime=\"yes\">C:\\Temp</directories>\n  <directories check_all=\"yes\" realtime=\"yes\">C:\\Users\\Public</directories>\n  <directories check_all=\"yes\" realtime=\"yes\">%APPDATA%\\Local\\Temp</directories>\n  <directories check_all=\"yes\">%APPDATA%\\Local\\Google\\Chrome</directories>\n  <directories check_all=\"yes\">%APPDATA%\\Local\\Microsoft\\Edge</directories>\n  <directories check_all=\"yes\">%APPDATA%\\Roaming\\Mozilla\\Firefox</directories>\n  <directories check_all=\"yes\">%APPDATA%\\Local\\Microsoft\\Vault</directories>\n</syscheck>\n\n<localfile>\n  <location>Microsoft-Windows-Sysmon/Operational</location>\n  <log_format>eventchannel</log_format>\n</localfile>\n```\n\n**Sysmon Configuration:**\n\n```xml\n<!-- Minimal Sysmon config for these rules -->\n<Sysmon schemaversion=\"4.90\">\n  <EventFiltering>\n    <ProcessCreate onmatch=\"include\">\n      <CommandLine condition=\"contains\">vssadmin</CommandLine>\n      <CommandLine condition=\"contains\">bcdedit</CommandLine>\n      <CommandLine condition=\"contains\">wbadmin</CommandLine>\n      <CommandLine condition=\"contains\">sc.exe</CommandLine>\n      <CommandLine condition=\"contains\">net stop</CommandLine>\n      <CommandLine condition=\"contains\">cmdkey</CommandLine>\n      <CommandLine condition=\"contains\">vaultcmd</CommandLine>\n    </ProcessCreate>\n\n    <DriverLoad onmatch=\"include\">\n      <ImageLoaded condition=\"end with\">.sys</ImageLoaded>\n    </DriverLoad>\n\n    <ProcessAccess onmatch=\"include\">\n      <TargetImage condition=\"contains\">chrome.exe</TargetImage>\n      <TargetImage condition=\"contains\">firefox.exe</TargetImage>\n      <TargetImage condition=\"contains\">msedge.exe</TargetImage>\n    </ProcessAccess>\n\n    <FileCreate onmatch=\"include\">\n      <TargetFilename condition=\"contains\">READ_ME.txt</TargetFilename>\n      <TargetFilename condition=\"contains\">HOW_TO_DECRYPT</TargetFilename>\n      <TargetFilename condition=\"contains\">passwords.txt</TargetFilename>\n      <TargetFilename condition=\"end with\">.encrypted</TargetFilename>\n      <TargetFilename condition=\"end with\">.locked</TargetFilename>\n    </FileCreate>\n  </EventFiltering>\n</Sysmon>\n```\n\n### 2. SharePoint/IIS Log Collection\n\n**IIS W3C Log Format:**\n\n```xml\n<localfile>\n  <location>C:\\inetpub\\logs\\LogFiles\\W3SVC1\\*.log</location>\n  <log_format>iis</log_format>\n</localfile>\n```\n\n**Required IIS Log Fields:**\n- date, time\n- c-ip (client IP)\n- cs-method (HTTP method)\n- cs-uri-stem (request path)\n- cs-uri-query (query parameters)\n- sc-status (HTTP status code)\n- cs(User-Agent)\n- cs(Referer)\n- cs-username (authentication)\n\n### 3. Network Connection Logging\n\n**iptables/nftables (Linux):**\n\n```bash\n# Log new connections\niptables -A OUTPUT -m state --state NEW -j LOG --log-prefix \"NEW_CONN: \"\n\n# Configure rsyslog to send to Wazuh\necho \"kern.warning /var/log/iptables.log\" >> /etc/rsyslog.conf\n```\n\n**Windows Firewall:**\n\n```powershell\n# Enable connection logging\nSet-NetFirewallProfile -Profile Domain,Public,Private -LogBlocked True -LogAllowed True\nauditpol /set /category:\"Logon/Logoff\" /success:enable /failure:enable\n```\n\n---\n\n## Testing and Validation\n\n### Test Cases\n\n#### Test 1: Mirai Hash Detection (Rule 100000)\n\n```bash\n# Create test file with known hash\necho \"test_mirai_sample\" > /tmp/test_mirai.elf\n# Manually calculate SHA256 and inject into Wazuh log for testing\n# Or use actual sample in controlled environment\n```\n\n**Expected Result:**\n- Alert level 12\n- Description: \"Mirai botnet malware detected (UPX-packed ELF) - SHA256 match\"\n\n#### Test 2: UPX Detection (Rules 100010-100011)\n\n```bash\n# Download legitimate UPX\nwget https://github.com/upx/upx/releases/download/v4.2.1/upx-4.2.1-amd64_linux.tar.xz\ntar xf upx-4.2.1-amd64_linux.tar.xz\ncp upx-4.2.1-amd64_linux/upx /tmp/upx_test\n```\n\n**Expected Result:**\n- Rule 100010: Level 10 (UPX binary detected)\n- Rule 100011: Level 12 (UPX in /tmp - suspicious location)\n\n#### Test 3: Botnet Mass Connection (Rule 100020)\n\n```bash\n# Simulate mass connections (NON-PRODUCTION ONLY)\nfor i in {1..1100}; do\n  timeout 0.1 nc -zv 192.168.1.$((RANDOM % 255)) 22 2>&1 | logger &\ndone\n```\n\n**Expected Result:**\n- Rule 100020: Level 8 (>1000 connections in 5 min)\n\n#### Test 4: EDR Killer Detection (Rule 100032)\n\n```powershell\n# Windows test (controlled environment)\nsc query \"WinDefend\" | Out-String | Write-EventLog -LogName Application -Source \"Test\" -EventId 1 -Message\n```\n\n**Expected Result:**\n- Rule 100032: Level 11 (EDR service termination attempt)\n\n#### Test 5: Credential Theft (Rule 100041)\n\n```bash\n# Linux test\ncat ~/.config/google-chrome/Default/Login\\ Data > /dev/null\n```\n\n**Expected Result:**\n- Rule 100045: Level 10 (Linux browser credential access)\n\n#### Test 6: Ransomware Simulation (Rule 100051)\n\n```powershell\n# Windows test\necho \"Your files are encrypted. Send Bitcoin to...\" > $env:USERPROFILE\\Desktop\\READ_ME.txt\n```\n\n**Expected Result:**\n- Rule 100051: Level 14 (CRITICAL: Ransom note created)\n\n#### Test 7: SharePoint Exploitation (Rule 100060)\n\n```bash\n# Test against SharePoint server (authorized testing only)\ncurl -H \"Referer: https://sharepoint.com\" http://sharepoint-server/_vti_bin/spdisco.aspx\n```\n\n**Expected Result:**\n- Rule 100060: Level 11 (Unauthenticated _vti_bin access)\n- Rule 100061: Level 13 (Forged Referer header)\n\n---\n\n## False Positive Mitigation\n\n### 1. UPX Detection (Rules 100010-100011)\n\n**Common False Positives:**\n- Legitimate games using UPX compression\n- Open-source tools (penetration testing utilities)\n- Legacy industrial/embedded software\n\n**Mitigation Strategies:**\n\n```xml\n<!-- Create whitelist rule -->\n<rule id=\"100015\" level=\"0\">\n  <if_sid>100010,100011</if_sid>\n  <field name=\"file_sha256\">HASH_OF_LEGITIMATE_UPX_BINARY</field>\n  <description>Whitelisted legitimate UPX binary</description>\n</rule>\n\n<!-- Whitelist specific paths -->\n<rule id=\"100016\" level=\"0\">\n  <if_sid>100010,100011</if_sid>\n  <field name=\"file_path\">^/opt/legitimate_software/|^/usr/local/games/</field>\n  <description>Whitelisted UPX in approved directories</description>\n</rule>\n```\n\n### 2. Botnet Connection Detection (Rules 100020-100024)\n\n**Common False Positives:**\n- Web servers with high connection volumes\n- Load balancers and proxies\n- Network monitoring tools (Nagios, Zabbix)\n\n**Mitigation:**\n\n```xml\n<!-- Exclude known high-traffic servers -->\n<rule id=\"100025\" level=\"0\">\n  <if_sid>100020,100021,100024</if_sid>\n  <hostname>web-server-01|proxy-01|monitoring-server</hostname>\n  <description>Whitelisted high-traffic server</description>\n</rule>\n\n<!-- Adjust thresholds for specific hosts -->\n<!-- Modify frequency values in original rules per-host -->\n```\n\n### 3. Credential Access (Rules 100040-100042)\n\n**Common False Positives:**\n- Password managers (LastPass, 1Password, Bitwarden)\n- Browser sync services\n- Backup software (Veeam, Acronis)\n\n**Mitigation:**\n\n```xml\n<!-- Whitelist password managers -->\n<rule id=\"100046\" level=\"0\">\n  <if_sid>100040,100041</if_sid>\n  <field name=\"process\">LastPass\\.exe|1Password\\.exe|Bitwarden\\.exe</field>\n  <description>Whitelisted password manager access</description>\n</rule>\n\n<!-- Whitelist backup software -->\n<rule id=\"100047\" level=\"0\">\n  <if_sid>100041,100042</if_sid>\n  <field name=\"process\">VeeamAgent\\.exe|AcronisAgent\\.exe</field>\n  <description>Whitelisted backup software</description>\n</rule>\n```\n\n### 4. Ransomware Behavior (Rules 100050-100055)\n\n**Common False Positives:**\n- Legitimate encryption tools (BitLocker, VeraCrypt)\n- Backup/archival operations (7-Zip, WinRAR)\n- Development environments (compiling, testing)\n\n**Mitigation:**\n\n```xml\n<!-- Whitelist legitimate encryption tools -->\n<rule id=\"100056\" level=\"0\">\n  <if_sid>100050</if_sid>\n  <field name=\"process\">BitLocker\\.exe|VeraCrypt\\.exe</field>\n  <description>Whitelisted encryption software</description>\n</rule>\n\n<!-- Exclude development/test directories -->\n<rule id=\"100057\" level=\"0\">\n  <if_sid>100050,100054</if_sid>\n  <field name=\"file_path\">^C:\\\\Dev\\\\|^C:\\\\Projects\\\\|^D:\\\\Testing\\\\</field>\n  <description>Whitelisted development directories</description>\n</rule>\n```\n\n### 5. SharePoint Detection (Rules 100060-100066)\n\n**Common False Positives:**\n- SharePoint Designer legitimate access\n- Internal monitoring tools\n- Authenticated API integrations\n\n**Mitigation:**\n\n```xml\n<!-- Whitelist internal IPs -->\n<rule id=\"100067\" level=\"0\">\n  <if_sid>100060,100061,100063</if_sid>\n  <srcip>10.0.0.0/8|172.16.0.0/12|192.168.0.0/16</srcip>\n  <description>Whitelisted internal SharePoint access</description>\n</rule>\n\n<!-- Whitelist authenticated users -->\n<rule id=\"100068\" level=\"0\">\n  <if_sid>100060</if_sid>\n  <field name=\"auth\">!^-$|!^$</field>\n  <description>Authenticated SharePoint access (exclude from CVE rule)</description>\n</rule>\n```\n\n---\n\n## Tuning Recommendations\n\n### 1. Baseline Normal Behavior (First 30 Days)\n\n**Objective:** Understand environment-specific patterns before enforcing strict thresholds.\n\n**Process:**\n1. Deploy rules at **INFO level (0-3)** initially\n2. Collect baseline data for:\n   - Normal connection volumes per host\n   - Legitimate UPX binaries in environment\n   - Authorized credential access patterns\n   - SharePoint API usage patterns\n3. After 30 days, adjust thresholds and exclusions\n4. Raise severity levels to operational values\n\n**Example Baseline Rule:**\n\n```xml\n<!-- Baseline version of Rule 100020 -->\n<rule id=\"100020\" level=\"3\">\n  <if_group>syslog</if_group>\n  <match>SYN_SENT|connection attempt</match>\n  <frequency>1000</frequency>\n  <timeframe>300</timeframe>\n  <description>[BASELINE] Mass network connection attempts - Collecting data</description>\n  <group>baseline,botnet,network_scanning,</group>\n</rule>\n```\n\n### 2. Environment-Specific Threshold Adjustments\n\n**High-Traffic Environments:**\n\n| Rule | Default Threshold | High-Traffic Threshold |\n|------|-------------------|------------------------|\n| 100020 | 1000 connections/5min | 5000 connections/5min |\n| 100024 | 5000 connections/10min | 25000 connections/10min |\n| 100022 | 50 auth failures/1min | 200 auth failures/1min |\n\n**Implementation:**\n\n```xml\n<!-- High-traffic variant of Rule 100020 -->\n<rule id=\"100020\" level=\"8\">\n  <if_group>syslog</if_group>\n  <match>SYN_SENT|connection attempt</match>\n  <frequency>5000</frequency>\n  <timeframe>300</timeframe>\n  <hostname>!web-farm-*|!proxy-*</hostname>\n  <description>Mass network connection attempts (adjusted threshold)</description>\n</rule>\n```\n\n### 3. Time-Based Tuning\n\n**Objective:** Reduce false positives during maintenance windows or known high-activity periods.\n\n```xml\n<!-- Suppress during maintenance window (Sunday 2-4 AM) -->\n<rule id=\"100058\" level=\"0\">\n  <if_sid>100050,100051,100052</if_sid>\n  <time>02:00:00-04:00:00</time>\n  <weekday>sunday</weekday>\n  <description>Maintenance window suppression</description>\n</rule>\n```\n\n### 4. Severity Escalation Based on Asset Criticality\n\n**Objective:** Increase alert priority for critical systems.\n\n```xml\n<!-- Escalate EDR killer detection on critical servers -->\n<rule id=\"100035\" level=\"15\">\n  <if_sid>100030,100031,100033</if_sid>\n  <hostname>dc-|sql-|exchange-|sharepoint-</hostname>\n  <description>CRITICAL: EDR killer on critical infrastructure</description>\n  <group>critical_asset,edr_killer,</group>\n</rule>\n```\n\n---\n\n## Response Playbooks\n\n### Playbook 1: Known Malware Hash Detection (Rules 100000-100002)\n\n**Trigger:** Any of Rules 100000, 100001, 100002\n\n**Severity:** High to Critical\n\n**Response Steps:**\n\n1. **Immediate (Within 5 minutes):**\n   - Isolate affected system from network (disconnect network cable or disable NIC)\n   - Capture memory dump: `dd if=/dev/mem of=/forensics/memory_dump.raw` (Linux) or use WinPMEM (Windows)\n   - Document active network connections: `netstat -antp` or `Get-NetTCPConnection`\n\n2. **Investigation (Within 30 minutes):**\n   - Verify file hash: `sha256sum /path/to/file`\n   - Check VirusTotal for additional context\n   - Review file creation time and parent process\n   - Identify initial infection vector (web download, email, lateral movement)\n\n3. **Containment (Within 1 hour):**\n   - Quarantine malware sample: `mv /tmp/malware /quarantine/` (preserve for analysis)\n   - Kill malicious processes: `kill -9 PID`\n   - Block C2 domains/IPs at firewall\n   - Scan other systems for same hash (enterprise-wide)\n\n4. **Eradication:**\n   - Remove malware and associated files\n   - Clear persistence mechanisms (cron jobs, systemd services, registry Run keys)\n   - Restore from last known-good backup if system integrity compromised\n\n5. **Recovery:**\n   - Rebuild system if heavily compromised\n   - Restore data from verified clean backups\n   - Update detection signatures and IOCs across environment\n\n6. **Post-Incident:**\n   - Document timeline and root cause\n   - Update SIEM correlation rules\n   - Share IOCs with threat intelligence community\n\n---\n\n### Playbook 2: Active Botnet Infection (Rules 100020-100024)\n\n**Trigger:** Rule 100024 (>5000 connections) or correlation rule 100070\n\n**Severity:** Critical\n\n**Response Steps:**\n\n1. **Immediate (Within 2 minutes):**\n   - **BLOCK** all outbound connections from infected host at firewall\n   - Capture network traffic: `tcpdump -i eth0 -w /forensics/botnet_traffic.pcap`\n   - Document active connections: `netstat -antp > /forensics/connections.txt`\n\n2. **Analysis (Within 15 minutes):**\n   - Identify C2 servers from connection logs\n   - Extract targeted ports (brute force targets)\n   - Determine botnet family (Mirai, RondoDox, etc.)\n   - Check for lateral movement to other internal systems\n\n3. **Containment (Within 30 minutes):**\n   - Isolate all potentially infected systems\n   - Block C2 IP ranges at perimeter firewall\n   - Deploy network-based IPS signatures for identified botnet\n   - Force password resets on all systems (credential brute force risk)\n\n4. **Eradication:**\n   - Identify and remove botnet binary (check /tmp, /dev/shm, /var/tmp)\n   - Remove persistence mechanisms\n   - Patch exploited vulnerabilities (if initial infection via CVE)\n\n5. **Recovery:**\n   - Rebuild compromised IoT devices (factory reset often insufficient)\n   - Segment IoT devices on isolated VLAN\n   - Implement egress filtering (deny unknown outbound connections)\n\n6. **Prevention:**\n   - Disable unnecessary services (Telnet, unnecessary SSH access)\n   - Implement strong authentication (key-based SSH, disable root login)\n   - Deploy device-level firewalls on IoT devices\n\n---\n\n### Playbook 3: EDR Killer + Ransomware (Rule 100071)\n\n**Trigger:** Correlation Rule 100071 (EDR termination + encryption)\n\n**Severity:** CRITICAL - Active Ransomware Attack\n\n**Response Steps:**\n\n1. **IMMEDIATE (Within 60 seconds):**\n   - **DO NOT SHUT DOWN** infected system (preserve memory evidence)\n   - **ISOLATE** system from network (pull cable, disable switch port)\n   - **ALERT** executive leadership and legal team\n   - **PRESERVE** memory dump if safe to do so\n\n2. **Rapid Assessment (Within 5 minutes):**\n   - Identify ransomware variant (ransom note analysis, file extensions)\n   - Determine encryption scope (local files only vs. network shares)\n   - Check if backups were targeted (shared backup drives)\n   - Assess business impact (critical systems encrypted?)\n\n3. **Containment (Within 15 minutes):**\n   - Isolate all systems in affected network segment\n   - Disable domain admin accounts (prevent lateral spread)\n   - Shutdown shared file servers if encryption spreading\n   - Block identified ransomware C2 domains/IPs\n\n4. **Recovery Decision (Within 30 minutes):**\n   - **Option A: Restore from Backup**\n     - Verify backup integrity (not encrypted)\n     - Restore to isolated recovery environment\n     - Scan restored data for malware before production\n   - **Option B: Attempt Decryption**\n     - Check NoMoreRansom.org for decryption tools\n     - Consult with ransomware specialists\n     - **DO NOT PAY RANSOM** without executive decision\n   - **Option C: Accept Data Loss**\n     - If backups compromised and no decryption available\n     - Document decision and rationale\n\n5. **Forensic Analysis:**\n   - Identify initial access vector (phishing, RDP brute force, CVE)\n   - Reconstruct attack timeline\n   - Analyze BYOVD driver used (submit to threat intel)\n   - Document all compromised accounts\n\n6. **Eradication:**\n   - Remove ransomware binaries and associated files\n   - Remove vulnerable drivers\n   - Clear persistence mechanisms\n   - Scan entire network for related IOCs\n\n7. **Recovery:**\n   - Rebuild compromised systems from scratch\n   - Restore data from verified clean backups\n   - Force password reset for all accounts\n   - Re-enable EDR/AV and verify protection\n\n8. **Post-Incident Hardening:**\n   - Implement application whitelisting\n   - Enable Windows Attack Surface Reduction (ASR) rules\n   - Deploy driver signature enforcement\n   - Implement privileged access workstations (PAWs)\n   - Conduct tabletop exercise for lessons learned\n\n9. **Legal/Regulatory:**\n   - Notify law enforcement (FBI, local cyber crime unit)\n   - Comply with breach notification requirements (GDPR, state laws)\n   - Engage cyber insurance carrier\n   - Preserve evidence for potential legal action\n\n---\n\n### Playbook 4: Credential Theft Detected (Rules 100040-100045, 100072)\n\n**Trigger:** Rule 100072 (credential theft + staging) or multiple credential access alerts\n\n**Severity:** High\n\n**Response Steps:**\n\n1. **Immediate (Within 5 minutes):**\n   - Isolate affected system from network\n   - Force logout of all active sessions for affected user\n   - Disable affected user account temporarily\n   - Capture memory dump (credentials may still be in memory)\n\n2. **Investigation (Within 15 minutes):**\n   - Identify stolen credentials (browser, Windows Vault, etc.)\n   - Review process execution logs (identify infostealer malware)\n   - Check for data exfiltration (network logs, USB usage)\n   - Search for staging files (passwords.txt, creds.txt)\n\n3. **Impact Assessment (Within 30 minutes):**\n   - Determine scope of compromised accounts\n   - Check authentication logs for unauthorized access\n   - Review email sent items for phishing (compromised email)\n   - Assess financial accounts (banking credentials)\n\n4. **Containment:**\n   - Force password reset for ALL accounts on compromised system\n   - Revoke active sessions for affected accounts\n   - Enable MFA on all accounts (if not already enabled)\n   - Monitor for credential stuffing attacks using stolen data\n\n5. **Eradication:**\n   - Identify and remove infostealer malware (RedLine, Raccoon, Vidar, etc.)\n   - Clear browser caches and credential stores\n   - Scan for additional persistence mechanisms\n\n6. **Recovery:**\n   - Rebuild system if heavily infected\n   - Restore browser profiles from clean backup\n   - Re-enable accounts with new strong passwords\n\n7. **User Notification:**\n   - Inform affected users of credential compromise\n   - Provide guidance on changing passwords across services\n   - Recommend credit monitoring if financial data stolen\n   - Report to HR/Legal if corporate data exfiltrated\n\n8. **Prevention:**\n   - Deploy password manager (reduce browser credential storage)\n   - Implement credential guard (Windows)\n   - Enable browser profile encryption\n   - Train users on phishing awareness\n\n---\n\n### Playbook 5: SharePoint Exploitation (Rules 100060-100066)\n\n**Trigger:** Rule 100064 (confirmed RCE) or Rule 100061 (active exploitation)\n\n**Severity:** Critical\n\n**Response Steps:**\n\n1. **IMMEDIATE (Within 2 minutes):**\n   - **BLOCK** source IP at firewall\n   - **DISABLE** affected SharePoint web services (`iisreset /stop`)\n   - Capture memory dump of IIS worker process (w3wp.exe)\n   - Preserve IIS logs and SharePoint ULS logs\n\n2. **Rapid Assessment (Within 10 minutes):**\n   - Review IIS logs for successful exploitation (HTTP 200 with RCE indicators)\n   - Check for web shell creation:\n     - `dir C:\\inetpub\\wwwroot\\_vti_bin\\*.aspx /s`\n     - `dir C:\\inetpub\\wwwroot\\_layouts\\*.aspx /s`\n   - Identify extent of compromise (single server vs. farm)\n   - Review SharePoint admin logs for unauthorized changes\n\n3. **Containment (Within 30 minutes):**\n   - Isolate compromised SharePoint server(s)\n   - Disable SharePoint service accounts (prevent lateral movement)\n   - Block identified attacker IPs at perimeter\n   - Deploy emergency WAF rules to block exploitation patterns\n\n4. **Forensic Analysis:**\n   - Analyze IIS logs for full attack timeline\n   - Extract web shells for malware analysis\n   - Review security event logs for privilege escalation\n   - Check for data exfiltration (large HTTP responses, unusual times)\n\n5. **Eradication:**\n   - Remove web shells and malicious files\n   - Apply CVE-2025-53770/53771 patches\n   - Rebuild server if deep compromise suspected\n   - Clear attacker accounts created during exploitation\n\n6. **Recovery:**\n   - Restore SharePoint from last known-good backup\n   - Verify data integrity (no backdoors in restored content)\n   - Re-enable services in staged approach\n   - Monitor for re-exploitation attempts\n\n7. **Emergency Patching:**\n   - Apply SharePoint security updates immediately\n   - Update all servers in farm (not just compromised)\n   - Test patches in isolated environment first if possible\n   - Document patch application for compliance\n\n8. **Prevention:**\n   - Deploy WAF with OWASP ModSecurity rules\n   - Implement IP whitelisting for `/_vti_bin/` if possible\n   - Enable SharePoint audit logging (all actions)\n   - Disable unnecessary SharePoint web services\n   - Implement least-privilege for SharePoint service accounts\n\n9. **Notification:**\n   - Inform management of breach\n   - Report to cyber insurance carrier\n   - Comply with breach notification laws (if data exfiltrated)\n   - Share IOCs with ISAC/threat intelligence community\n\n---\n\n## Performance Considerations\n\n### Rule Efficiency Analysis\n\n**High-Performance Rules (Minimal CPU Impact):**\n- Hash matching (100000-100002): Direct field comparison\n- Exact string matching (100051, 100032): Simple pattern matching\n\n**Medium-Performance Rules (Moderate CPU Impact):**\n- Frequency-based detection (100020-100024): Requires event aggregation\n- Regex matching (100012, 100030): Pattern complexity impacts performance\n\n**Resource-Intensive Rules (Higher CPU Impact):**\n- Complex regex with backreferences\n- Multi-field correlation (100070-100072)\n- High-frequency event processing (100054)\n\n### Optimization Recommendations\n\n1. **Index Frequently Matched Fields:**\n   ```xml\n   <!-- Wazuh manager: /var/ossec/etc/ossec.conf -->\n   <indexer>\n     <enabled>yes</enabled>\n     <index>file_sha256,srcip,dstport,hostname</index>\n   </indexer>\n   ```\n\n2. **Use Specific Parent Rules:**\n   - Instead of `<if_sid>1</if_sid>` (all events), use specific parent rule IDs\n   - Example: `<if_sid>550</if_sid>` for auditd events only\n\n3. **Limit Regex Complexity:**\n   - Avoid excessive backreferences\n   - Use anchors (`^`, `$`) to limit search scope\n   - Pre-filter with simple `<match>` before complex `<regex>`\n\n4. **Adjust Frequency Timeframes:**\n   - Shorter timeframes = less memory usage\n   - Balance detection effectiveness with resource consumption\n\n5. **Implement Rule Exclusions Early:**\n   - Place high-frequency exclusions (whitelists) before intensive rules\n   - Use `level=\"0\"` rules to drop events early in processing\n\n---\n\n## MITRE ATT&CK Mapping\n\n### Complete Coverage Matrix\n\n| MITRE Technique | Technique Name | Wazuh Rules | Coverage Level |\n|-----------------|----------------|-------------|----------------|\n| **T1027.002** | Obfuscated Files or Information: Software Packing | 100000, 100001, 100010, 100011 | High |\n| **T1036** | Masquerading | 100011, 100012 | Medium |\n| **T1046** | Network Service Discovery | 100002, 100020, 100021, 100024 | High |\n| **T1057** | Process Discovery | 100002, 100023 | Medium |\n| **T1059.003** | Command and Scripting Interpreter: Windows Command Shell | 100064 | High |\n| **T1059.004** | Command and Scripting Interpreter: Unix Shell | 100000, 100012 | Medium |\n| **T1068** | Exploitation for Privilege Escalation | 100030, 100031, 100033 | High |\n| **T1070.004** | Indicator Removal: File Deletion | 100053 | Medium |\n| **T1071.001** | Application Layer Protocol: Web Protocols | 100000, 100013 | Medium |\n| **T1074.001** | Data Staged: Local Data Staging | 100044, 100072 | High |\n| **T1110** | Brute Force | 100002, 100021, 100022 | High |\n| **T1110.001** | Brute Force: Password Guessing | 100021 | High |\n| **T1110.003** | Brute Force: Password Spraying | 100021 | High |\n| **T1190** | Exploit Public-Facing Application | 100060-100066 | High |\n| **T1203** | Exploitation for Client Execution | 100062, 100065 | Medium |\n| **T1485** | Data Destruction | 100053 | Medium |\n| **T1486** | Data Encrypted for Impact | 100050, 100051, 100054, 100071 | High |\n| **T1489** | Service Stop | 100055 | High |\n| **T1490** | Inhibit System Recovery | 100052, 100071 | High |\n| **T1518.001** | Software Discovery: Security Software Discovery | 100023 | Medium |\n| **T1543.003** | Create or Modify System Process: Windows Service | 100033, 100034 | High |\n| **T1555** | Credentials from Password Stores | 100040-100045, 100072 | High |\n| **T1555.003** | Credentials from Password Stores: Web Browsers | 100040, 100041, 100045 | High |\n| **T1555.004** | Credentials from Password Stores: Windows Credential Manager | 100042, 100043 | High |\n| **T1562.001** | Impair Defenses: Disable or Modify Tools | 100030-100032, 100071 | High |\n| **T1595.001** | Active Scanning: Scanning IP Blocks | 100020 | Medium |\n| **T1595.002** | Active Scanning: Vulnerability Scanning | 100063 | Medium |\n\n**Coverage Levels:**\n- **High:** Multiple rules with different detection angles\n- **Medium:** Single rule or limited coverage\n- **Low:** Partial coverage or indirect detection\n\n---\n\n## Compliance and Reporting\n\n### Regulatory Framework Alignment\n\n**PCI DSS 4.0:**\n- Requirement 10.2.4 (Invalid logical access attempts): Rules 100022, 100060\n- Requirement 10.2.5 (Changes to identification/authentication): Rules 100040-100045\n- Requirement 11.5 (File integrity monitoring): Rules 100000-100002, 100050\n- Requirement 6.5.1 (Injection flaws): Rules 100062, 100064\n\n**NIST CSF 2.0:**\n- DE.CM-1 (Network monitored): Rules 100020-100024\n- DE.CM-4 (Malicious code detected): Rules 100000-100013\n- DE.CM-7 (Monitoring for unauthorized activity): Rules 100040-100045\n- RS.AN-3 (Analysis performed): All correlation rules (100070-100072)\n\n**CIS Controls v8:**\n- Control 8.5 (Collect Detailed Audit Logs): All rules\n- Control 10.1 (Deploy Anti-Malware Software): Rules 100000-100034\n- Control 13.6 (Collect Network Traffic Logs): Rules 100020-100024\n- Control 18.3 (Remediate Penetration Test Findings): Rules 100060-100066\n\n### Executive Reporting Template\n\n```\nWazuh Malware Detection Summary Report\nPeriod: [Start Date] - [End Date]\n\nCRITICAL FINDINGS:\n- Ransomware Attacks Detected: [Count from Rules 100050-100055, 100071]\n- EDR Killer Attempts: [Count from Rules 100030-100034]\n- Known Malware Detections: [Count from Rules 100000-100002]\n\nHIGH PRIORITY:\n- Credential Theft Incidents: [Count from Rules 100040-100045]\n- Botnet Infections: [Count from Rules 100020-100024]\n- SharePoint Exploitation: [Count from Rules 100060-100066]\n\nTREND ANALYSIS:\n- Week-over-week change in malware detections\n- Most frequently triggered rules\n- Top affected systems/departments\n\nREMEDIATION STATUS:\n- Incidents resolved: X%\n- Mean time to detect (MTTD): X minutes\n- Mean time to respond (MTTR): X hours\n\nRECOMMENDATIONS:\n[Based on specific findings]\n```\n\n---\n\n## Maintenance and Updates\n\n### Monthly Review Checklist\n\n- [ ] Review false positive rate per rule\n- [ ] Adjust frequency thresholds based on environmental changes\n- [ ] Update malware hash list (rules 100000-100002)\n- [ ] Review and update whitelists\n- [ ] Validate log source collection (auditd, Sysmon, IIS)\n- [ ] Test correlation rules for accuracy\n- [ ] Update MITRE ATT&CK mappings\n- [ ] Review incident response metrics\n\n### Quarterly Updates\n\n- [ ] Tune rule severity levels based on actual impact\n- [ ] Incorporate new threat intelligence (IOCs, TTPs)\n- [ ] Update SharePoint CVE rules for new vulnerabilities\n- [ ] Review ransomware family indicators (new variants)\n- [ ] Conduct tabletop exercise with SOC team\n- [ ] Update response playbooks based on lessons learned\n\n### Annual Assessment\n\n- [ ] Full ruleset performance audit\n- [ ] Benchmark against industry standards (MITRE Engenuity, etc.)\n- [ ] Cost-benefit analysis of detection coverage\n- [ ] Update compliance mappings for new regulations\n- [ ] Strategic roadmap for threat detection enhancements\n\n---\n\n## Appendix: Quick Reference\n\n### Rule Severity Guide\n\n| Level | Severity | Response Time | Examples |\n|-------|----------|---------------|----------|\n| 0-3 | Informational | N/A | Baseline, whitelists |\n| 4-7 | Low | 24 hours | Reconnaissance, scanning |\n| 8-10 | Medium | 4 hours | Suspicious activity |\n| 11-13 | High | 1 hour | Confirmed threats |\n| 14-15 | Critical | 15 minutes | Active attacks |\n\n### Critical Rules Priority Matrix\n\n| Rule ID | Priority | Threat | Response Action |\n|---------|----------|--------|-----------------|\n| 100071 | P0 | Ransomware + EDR killer | Immediate isolation |\n| 100051 | P0 | Ransom note creation | Activate IR team |\n| 100064 | P0 | SharePoint RCE | Block IP, disable service |\n| 100024 | P1 | Active botnet | Network isolation |\n| 100002 | P1 | RondoDox malware | Quarantine + rebuild |\n| 100072 | P1 | Credential theft chain | Force password reset |\n| 100031 | P1 | BYOVD attack | EDR restoration |\n\n### Log Source Requirements Summary\n\n| Detection Category | Linux | Windows | Network | Web Server |\n|--------------------|-------|---------|---------|------------|\n| Malware Hashes | FIM | FIM | - | - |\n| UPX/Mirai | FIM, auditd | - | - | - |\n| Botnet Activity | auditd, iptables | - | Firewall logs | - |\n| EDR Killer | - | Sysmon (1,6), Event Logs | - | - |\n| Credential Theft | auditd, FIM | Sysmon (1,10,11), FIM | - | - |\n| Ransomware | FIM, auditd | Sysmon (1,11), FIM | - | - |\n| SharePoint CVE | - | - | - | IIS W3C |\n\n---\n\n## Support and Contact\n\n**Wazuh Documentation:**\n- Official Docs: https://documentation.wazuh.com/\n- Rule Syntax: https://documentation.wazuh.com/current/user-manual/ruleset/\n\n**Threat Intelligence Sources:**\n- MalwareBazaar: https://bazaar.abuse.ch/\n- AlienVault OTX: https://otx.alienvault.com/\n- MITRE ATT&CK: https://attack.mitre.org/\n\n**Community:**\n- Wazuh Slack: https://wazuh.com/community/join-us-on-slack/\n- GitHub Issues: https://github.com/wazuh/wazuh/issues\n\n---\n\n**Document Version:** 1.0\n**Last Updated:** 2025-11-27\n**Next Review Date:** 2025-12-27\n"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":8121,"cache_read_input_tokens":24947,"cache_creation":{"ephemeral_5m_input_tokens":8121,"ephemeral_1h_input_tokens":0},"output_tokens":14932,"service_tier":"standard"},"context_management":{"applied_edits":[]}},"requestId":"req_011CVXtYeR7aRMUDw3gXCevJ","type":"assistant","uuid":"ed74591e-ed29-40ea-9778-028a4d58013a","timestamp":"2025-11-27T06:09:14.741Z"}
{"parentUuid":"ed74591e-ed29-40ea-9778-028a4d58013a","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0114LCMu22SLixeuRKyT1fc4","type":"tool_result","content":"File created successfully at: /home/stanner/wazuh_rules_documentation.md"}]},"uuid":"770617fa-0f5f-4299-b40c-e38afcfd6345","timestamp":"2025-11-27T06:09:56.629Z","toolUseResult":{"type":"create","filePath":"/home/stanner/wazuh_rules_documentation.md","content":"# Wazuh Malware Detection Rules - Implementation Guide\n\n**Version:** 1.0\n**Date:** 2025-11-27\n**Rule ID Range:** 100000-100099\n**Author:** Wazuh Threat Detection Engineering\n\n## Executive Summary\n\nThis ruleset provides comprehensive detection coverage for emerging malware threats identified on November 27, 2025, including:\n\n- **Mirai botnet variants** (UPX-packed ELF binaries)\n- **RondoDox botnet** (mass network scanning and credential brute force)\n- **EDR killer techniques** (BYOVD - Bring Your Own Vulnerable Driver)\n- **Credential theft malware** (T1555 - 3X surge in browser credential harvesting)\n- **Ransomware behaviors** (LockBit 5.0, VanHelsing RaaS, Lynx)\n- **SharePoint exploitation** (CVE-2025-53770/53771 RCE vulnerabilities)\n\n---\n\n## Table of Contents\n\n1. [Rule Categories and Coverage](#rule-categories-and-coverage)\n2. [Integration Requirements](#integration-requirements)\n3. [Rule-by-Rule Analysis](#rule-by-rule-analysis)\n4. [Testing and Validation](#testing-and-validation)\n5. [False Positive Mitigation](#false-positive-mitigation)\n6. [Tuning Recommendations](#tuning-recommendations)\n7. [Response Playbooks](#response-playbooks)\n\n---\n\n## Rule Categories and Coverage\n\n### Category 1: File Hash Detection (Rules 100000-100002)\n\n**Threat Context:**\nThree specific malware samples identified in recent threat intelligence:\n\n| Hash | Type | Threat Level | Detection Rate |\n|------|------|--------------|----------------|\n| b6873744... | Mirai (UPX-packed) | High (12) | 23.68% |\n| 7e5fbce9... | ARM malware | Critical (13) | 75% confidence |\n| 5c2bbb00... | RondoDox botnet | Critical (14) | High behavioral indicators |\n\n**Detection Approach:**\n- **Rule 100000:** Direct SHA256 hash match for Mirai UPX-packed ELF\n- **Rule 100001:** SHA256 match for ARM architecture malware with IPv6 capabilities\n- **Rule 100002:** SHA256 match for RondoDox botnet/scanner variant\n\n**Log Source Requirements:**\n- Wazuh FIM (File Integrity Monitoring) with SHA256 hashing enabled\n- Syscheck configured to monitor critical directories: `/tmp`, `/dev/shm`, `/var/tmp`, `/usr/bin`, `/usr/sbin`\n\n**Rationale:**\nHash-based detection provides immediate identification of known threats. These three samples represent active threats with varying AV detection rates (23-75%), making behavioral detection crucial as a complementary control.\n\n---\n\n### Category 2: Mirai/UPX-Packed ELF Detection (Rules 100010-100013)\n\n**Threat Context:**\nMirai and IoT botnets commonly use UPX packing to evade detection. The first sample (b6873744...) is a UPX-packed Mirai variant targeting Linux IoT devices.\n\n**Detection Logic:**\n\n**Rule 100010** (Level 10):\n- Detects any UPX-packed ELF binary on the system\n- Uses file content matching for \"ELF\" + \"UPX\" strings\n- **Low severity** as legitimate software may use UPX\n\n**Rule 100011** (Level 12):\n- Triggers on UPX binaries in suspicious directories: `/tmp`, `/dev/shm`, `/var/tmp`\n- **Medium-high severity** as this indicates staging behavior\n- Malware often downloads to temp directories for execution\n\n**Rule 100012** (Level 8):\n- Detects execution of randomly-named binaries (`.elf`, `.bin` with 5-10 char names)\n- Matches Mirai dropper naming convention\n- Uses `execve` syscall monitoring via auditd\n\n**Rule 100013** (Level 11):\n- Identifies IPv6 socket creation by non-standard binaries\n- Correlates with YARA signature `linux_generic_ipv6_catcher`\n- Sample 7e5fbce9... matches this pattern\n\n**Log Source Requirements:**\n- FIM monitoring `/tmp`, `/dev/shm`, `/var/tmp`, `/home`, `/root`\n- auditd configured for syscall monitoring (`execve`, `socket`, `connect`)\n- File type inspection enabled in Wazuh syscheck\n\n**False Positive Considerations:**\n- Legitimate software may use UPX (games, older utilities)\n- **Mitigation:** Whitelist known legitimate UPX binaries by hash or path\n- IoT devices may have legitimate custom binaries\n- **Mitigation:** Baseline normal IoT device behavior first\n\n---\n\n### Category 3: Botnet Activity Detection (Rules 100020-100024)\n\n**Threat Context:**\nRondoDox botnet (sample 5c2bbb00...) exhibits extreme network behavior:\n- Contacts 44,640+ remote hosts during scanning operations\n- Conducts credential brute force on SSH, Telnet, RDP, SMB\n- Performs process enumeration to identify security tools\n\n**Detection Logic:**\n\n**Rule 100020** (Level 8):\n- **Threshold:** >1000 connection attempts in 5 minutes\n- Detects initial mass scanning behavior\n- Uses frequency analysis of `SYN_SENT` states or connection attempts\n\n**Rule 100021** (Level 10):\n- **Enhancement** to 100020 targeting exploitation ports\n- Ports: 22 (SSH), 23 (Telnet), 445 (SMB), 3389 (RDP), 5555 (ADB), 8080/8081 (HTTP)\n- Higher severity due to clear malicious intent\n\n**Rule 100022** (Level 9):\n- **Threshold:** 50+ authentication failures in 60 seconds\n- Detects credential brute force campaigns\n- Correlates with Wazuh auth failure rules (5712, 5716)\n\n**Rule 100023** (Level 10):\n- **Threshold:** 20+ process enumeration commands in 60 seconds\n- Commands: `ps`, `/proc/` access, `pidof`, `pgrep`\n- Indicates reconnaissance for security tools\n\n**Rule 100024** (Level 12):\n- **CRITICAL threshold:** >5000 connections in 10 minutes\n- Confirms active botnet infection\n- Matches RondoDox behavioral profile\n\n**Log Source Requirements:**\n- Network connection logging (iptables/nftables logs, netflow, or conntrack)\n- Authentication logs (SSH: `/var/log/auth.log`, Windows: Security Event ID 4625)\n- auditd monitoring `connect()` syscalls\n- Process execution monitoring\n\n**Tuning Recommendations:**\n- Adjust thresholds based on normal network behavior\n- High-traffic servers may need higher thresholds\n- Consider time-of-day baselines (scanning often occurs during off-hours)\n\n---\n\n### Category 4: EDR Killer Detection (Rules 100030-100034)\n\n**Threat Context:**\n8+ ransomware groups now use BYOVD (Bring Your Own Vulnerable Driver) technique:\n- Load vulnerable signed drivers (RTCore64.sys, gdrv.sys, etc.)\n- Exploit driver vulnerabilities to gain kernel privileges\n- Terminate EDR/AV processes to evade detection\n- **Signature:** Random 5-character driver names\n\n**Detection Logic:**\n\n**Rule 100030** (Level 12):\n- Detects driver loading with 5-character random names (e.g., `abcde.sys`, `12345.sys`)\n- Monitors Windows Event ID 6 (driver load) via Sysmon Event ID 6\n- **High severity** as this is a strong ransomware indicator\n\n**Rule 100031** (Level 14):\n- **CRITICAL correlation rule**\n- Combines driver load (100030) + security service termination (100032)\n- Confirms multi-stage BYOVD attack chain\n\n**Rule 100032** (Level 11):\n- Detects termination of EDR/AV services\n- Commands: `sc.exe stop`, `net stop`, `taskkill`\n- Targets: MsMpEng (Defender), CrowdStrike, SentinelOne, Carbon Black, etc.\n\n**Rule 100033** (Level 13):\n- Identifies known vulnerable drivers by exact filename\n- Drivers: RTCore64.sys, gdrv.sys, AsrDrv10x.sys, DBUtil_2_3.sys, PROCEXP152.SYS\n- **High confidence** as these are documented BYOVD targets\n\n**Rule 100034** (Level 10):\n- Detects kernel driver service creation\n- Command: `sc.exe create` with `type=kernel` or `binPath=*.sys`\n- **Early warning** of driver installation\n\n**Log Source Requirements:**\n- **Windows:** Sysmon Event ID 6 (driver load), Event ID 1 (process creation)\n- **Windows:** System Event Log for service state changes\n- **Windows:** Security Event Log for service installation (Event ID 4697)\n\n**False Positive Mitigation:**\n- Legitimate drivers may have short names (audio, network drivers)\n- **Whitelist:** Known legitimate driver hashes using Sysmon hash matching\n- Security tools may load their own drivers\n- **Whitelist:** Paths like `C:\\Program Files\\` for known security vendors\n- System updates may install drivers\n- **Correlation:** Check for signed drivers from Microsoft/OEM vendors\n\n**Response Actions:**\n1. **Immediate isolation** of affected endpoint\n2. Memory dump for forensic analysis\n3. Verify driver digital signature (`sigcheck.exe -h`)\n4. Check driver hash against threat intelligence (VirusTotal)\n5. Restore from last known-good backup if encryption occurred\n\n---\n\n### Category 5: Credential Theft Detection (Rules 100040-100045)\n\n**Threat Context:**\n**3X increase** in T1555 (Credentials from Password Stores) malware:\n- Browser credential databases (Chrome, Firefox, Edge)\n- Windows Vault and Credential Manager\n- Linux credential stores\n\n**Detection Logic:**\n\n**Rule 100040** (Level 11):\n- Detects suspicious process memory access to browsers\n- Uses Sysmon Event ID 10 (process access)\n- **Indicator:** Non-browser process accessing browser memory\n\n**Rule 100041** (Level 12):\n- Detects file access to browser credential databases\n- Paths:\n  - Chrome: `\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data`\n  - Firefox: `\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\*\\logins.json`\n  - Edge: `\\AppData\\Local\\Microsoft\\Edge\\User Data\\Default\\Login Data`\n- **Excludes:** Browser executables themselves\n\n**Rule 100042** (Level 13):\n- Detects access to Windows Vault/Credential Manager\n- Paths: `\\AppData\\Local\\Microsoft\\Vault`, `\\AppData\\Roaming\\Microsoft\\Vault`\n- Files: `VaultPasswordV1.dat`, `Policy.vpol`\n- **High severity** as this is sensitive credential storage\n\n**Rule 100043** (Level 12):\n- Detects credential enumeration commands\n- Commands: `cmdkey /list`, `vaultcmd /list`, PowerShell `Get-VaultCredential`\n- **Discovery phase** of credential theft\n\n**Rule 100044** (Level 11):\n- Detects creation of credential dump files\n- Filenames: `passwords.txt`, `credentials.txt`, `logins.txt`, `creds.txt`\n- Locations: `\\AppData\\Local\\Temp`, `\\Users\\Public`, `C:\\Temp`\n- **Staging for exfiltration**\n\n**Rule 100045** (Level 10):\n- **Linux version** of browser credential theft\n- Paths: `.mozilla/firefox/*/logins.json`, `.config/google-chrome/*/Login Data`\n- Monitors `open()` and `openat()` syscalls via auditd\n\n**Log Source Requirements:**\n- **Windows:** Sysmon Event ID 10 (process access), Event ID 11 (file creation)\n- **Windows:** FIM monitoring credential directories\n- **Linux:** auditd monitoring file access (`open`, `openat`, `read`)\n- **Linux:** FIM monitoring `~/.mozilla`, `~/.config/google-chrome`\n\n**False Positive Scenarios:**\n- Password managers accessing credential stores (LastPass, 1Password)\n- **Mitigation:** Whitelist known password manager executables\n- Browser sync processes accessing databases\n- **Mitigation:** Whitelist browser sync services by process name\n- Backup software accessing user directories\n- **Mitigation:** Whitelist backup agents by path and signature\n\n**Response Actions:**\n1. **Force password reset** for all accounts on affected system\n2. Review authentication logs for account compromise\n3. Check for data exfiltration (network connections, USB usage)\n4. Scan for infostealer malware (RedLine, Raccoon, Vidar)\n5. Enable MFA on all accounts\n\n---\n\n### Category 6: Ransomware Behavior Detection (Rules 100050-100055)\n\n**Threat Context:**\nEmerging ransomware families in November 2025:\n- **LockBit 5.0** (most prolific)\n- **VanHelsing RaaS** (Ransomware-as-a-Service)\n- **Lynx** (new variant)\n\n**Detection Logic:**\n\n**Rule 100050** (Level 12):\n- **Threshold:** 50+ files encrypted in 60 seconds\n- File extensions: `.encrypted`, `.locked`, `.crypto`, `.crypt`, `.lockbit`, `.lynx`, `.vanhelsing`\n- **High confidence** ransomware indicator\n\n**Rule 100051** (Level 14):\n- **CRITICAL:** Ransom note creation\n- Filenames: `READ_ME.txt`, `HOW_TO_DECRYPT.txt`, `RECOVERY_INSTRUCTIONS.txt`\n- Locations: Desktop, user directories, drive roots\n- **Confirms active ransomware attack**\n\n**Rule 100052** (Level 13):\n- Detects shadow copy/backup deletion\n- Commands:\n  - `vssadmin delete shadows`\n  - `wmic shadowcopy delete`\n  - `bcdedit /set recoveryenabled no`\n  - `wbadmin delete catalog`\n- **Anti-recovery technique**\n\n**Rule 100053** (Level 11):\n- Detects secure file deletion tools\n- Tools: `cipher.exe /w`, `sdelete`, `wipe`, `shred`\n- **Data destruction or anti-forensics**\n\n**Rule 100054** (Level 12):\n- **Threshold:** 500+ file modifications in 2 minutes\n- **Extreme** file activity indicating mass encryption\n- Higher threshold than 100050 for different data sources\n\n**Rule 100055** (Level 10):\n- Detects service termination preparation\n- Targets: SQL servers, backup services, VSS\n- Commands: `net stop sql`, `net stop backup`, `net stop vss`\n- **Pre-encryption phase**\n\n**Log Source Requirements:**\n- **Windows:** FIM with high-frequency file monitoring\n- **Windows:** Sysmon Event ID 1 (process creation) for commands\n- **Windows:** Sysmon Event ID 11 (file creation) for ransom notes\n- **Windows:** File modification event tracking\n\n**Detection Challenges:**\n- Legitimate mass file operations (backup, indexing)\n- **Mitigation:** Whitelist known backup/indexing processes\n- Developers may create test files with similar names\n- **Mitigation:** Scope monitoring to production systems\n- Compression tools may modify many files\n- **Mitigation:** Check for actual encryption vs. compression\n\n**Immediate Response Actions:**\n1. **Isolate endpoint** from network immediately\n2. **DO NOT** shut down (preserve memory evidence)\n3. Identify ransomware variant (ransom note analysis)\n4. Check backups and shadow copies for recovery\n5. Engage incident response team\n6. Report to law enforcement if required\n7. **DO NOT PAY RANSOM** without executive approval\n\n---\n\n### Category 7: SharePoint Exploitation Detection (Rules 100060-100066)\n\n**Threat Context:**\n**CVE-2025-53770 / CVE-2025-53771** - Critical SharePoint RCE vulnerabilities:\n- Targets `/_vti_bin/` SOAP endpoints\n- Deserialization vulnerabilities in SharePoint web services\n- Authentication bypass via forged Referer headers\n- **Actively exploited in the wild**\n\n**Detection Logic:**\n\n**Rule 100060** (Level 11):\n- Detects unauthenticated access to `/_vti_bin/` paths\n- **Indicator:** HTTP 200/401/403 with empty authentication field\n- Baseline for SharePoint exploitation attempts\n\n**Rule 100061** (Level 13):\n- **Enhanced detection:** Forged Referer header\n- Referer values: `sharepoint.com`, `office.com`\n- HTTP 200 status indicates successful bypass\n- **Active exploitation**\n\n**Rule 100062** (Level 12):\n- Detects deserialization errors in logs\n- Keywords: `deserialization`, `SerializationException`, `BinaryFormatter`, `ObjectStateFormatter`\n- Paths: `/_vti_bin/`, `/_layouts/`\n- **CVE-2025-53771 exploitation**\n\n**Rule 100063** (Level 10):\n- **Threshold:** 20+ requests to `/_vti_bin/` in 60 seconds\n- Indicates vulnerability scanning/probing\n- **Reconnaissance phase**\n\n**Rule 100064** (Level 14):\n- **CRITICAL:** Command execution patterns in requests\n- Strings: `cmd.exe`, `powershell.exe`, `/bin/bash`, `/bin/sh`\n- HTTP status 200/500/502 (successful or error during execution)\n- **Confirmed RCE exploitation**\n\n**Rule 100065** (Level 12):\n- Targets specific vulnerable SOAP endpoints\n- Endpoints: `spdisco.aspx`, `Lists.asmx`, `SharePointProjectService.svc`\n- Method: POST with `text/xml` or `application/soap` content-type\n- **Deserialization attack vector**\n\n**Rule 100066** (Level 11):\n- Detects oversized ViewState payloads\n- Size threshold: >10,000 bytes\n- Contains `__VIEWSTATE` or `__EVENTVALIDATION`\n- **Malicious deserialization payload**\n\n**Log Source Requirements:**\n- **IIS:** Web server access logs (W3C format)\n- **SharePoint:** ULS logs (Unified Logging Service)\n- **SharePoint:** Application Event Logs\n- **Network:** Web application firewall (WAF) logs\n\n**False Positive Mitigation:**\n- Legitimate SharePoint API usage may access `/_vti_bin/`\n- **Mitigation:** Whitelist known service accounts and internal IPs\n- Developers may test SharePoint web services\n- **Mitigation:** Exclude development environments\n- SharePoint Designer uses `_vti_bin` endpoints\n- **Mitigation:** Identify and whitelist Designer connections\n\n**Emergency Response Actions:**\n1. **Block source IP** at firewall immediately\n2. **Disable affected SharePoint web services** temporarily\n3. Apply emergency patches (CVE-2025-53770/53771)\n4. Review IIS logs for successful exploitation (HTTP 200)\n5. Check for web shells: `*.aspx`, `*.ashx` in SharePoint directories\n6. Restore from last known-good backup if compromised\n7. Force password resets for all SharePoint service accounts\n\n---\n\n### Category 8: Composite/Correlation Rules (Rules 100070-100072)\n\n**Purpose:**\nDetect multi-stage attack chains by correlating multiple detection events.\n\n**Rule 100070** (Level 15):\n- **Combination:** Known malware hash + active botnet behavior\n- Timeframe: 10 minutes\n- **Confirms:** System is infected and actively participating in botnet operations\n- **Action:** Immediate quarantine required\n\n**Rule 100071** (Level 15):\n- **Combination:** EDR killer + ransomware behavior\n- Timeframe: 30 minutes\n- **Attack chain:** BYOVD  EDR termination  encryption\n- **Action:** Emergency incident response activation\n\n**Rule 100072** (Level 14):\n- **Combination:** Credential theft + data staging\n- Timeframe: 15 minutes\n- **Attack chain:** Credential harvesting  staging for exfiltration\n- **Action:** Network isolation and credential reset\n\n---\n\n## Integration Requirements\n\n### 1. Wazuh Agent Configuration\n\n**Linux Systems:**\n\n```xml\n<!-- /var/ossec/etc/ossec.conf -->\n<syscheck>\n  <directories check_all=\"yes\" realtime=\"yes\" report_changes=\"yes\">/tmp</directories>\n  <directories check_all=\"yes\" realtime=\"yes\">/dev/shm</directories>\n  <directories check_all=\"yes\" realtime=\"yes\">/var/tmp</directories>\n  <directories check_all=\"yes\">/usr/bin,/usr/sbin,/bin,/sbin</directories>\n  <directories check_all=\"yes\">~/.mozilla/firefox</directories>\n  <directories check_all=\"yes\">~/.config/google-chrome</directories>\n</syscheck>\n\n<localfile>\n  <log_format>audit</log_format>\n  <location>/var/log/audit/audit.log</location>\n</localfile>\n```\n\n**auditd Rules:**\n\n```bash\n# /etc/audit/rules.d/wazuh-malware.rules\n\n# Monitor execve syscalls for suspicious binary execution\n-a always,exit -F arch=b64 -S execve -F key=execve_monitor\n\n# Monitor socket creation (IPv6 malware)\n-a always,exit -F arch=b64 -S socket -F a0=10 -F key=ipv6_socket\n\n# Monitor connect syscalls (botnet activity)\n-a always,exit -F arch=b64 -S connect -F key=connect_monitor\n\n# Monitor file access to credential stores\n-w ~/.mozilla/firefox/ -p r -k firefox_creds\n-w ~/.config/google-chrome/ -p r -k chrome_creds\n```\n\n**Windows Systems:**\n\n```xml\n<!-- C:\\Program Files (x86)\\ossec-agent\\ossec.conf -->\n<syscheck>\n  <directories check_all=\"yes\" realtime=\"yes\">C:\\Temp</directories>\n  <directories check_all=\"yes\" realtime=\"yes\">C:\\Users\\Public</directories>\n  <directories check_all=\"yes\" realtime=\"yes\">%APPDATA%\\Local\\Temp</directories>\n  <directories check_all=\"yes\">%APPDATA%\\Local\\Google\\Chrome</directories>\n  <directories check_all=\"yes\">%APPDATA%\\Local\\Microsoft\\Edge</directories>\n  <directories check_all=\"yes\">%APPDATA%\\Roaming\\Mozilla\\Firefox</directories>\n  <directories check_all=\"yes\">%APPDATA%\\Local\\Microsoft\\Vault</directories>\n</syscheck>\n\n<localfile>\n  <location>Microsoft-Windows-Sysmon/Operational</location>\n  <log_format>eventchannel</log_format>\n</localfile>\n```\n\n**Sysmon Configuration:**\n\n```xml\n<!-- Minimal Sysmon config for these rules -->\n<Sysmon schemaversion=\"4.90\">\n  <EventFiltering>\n    <ProcessCreate onmatch=\"include\">\n      <CommandLine condition=\"contains\">vssadmin</CommandLine>\n      <CommandLine condition=\"contains\">bcdedit</CommandLine>\n      <CommandLine condition=\"contains\">wbadmin</CommandLine>\n      <CommandLine condition=\"contains\">sc.exe</CommandLine>\n      <CommandLine condition=\"contains\">net stop</CommandLine>\n      <CommandLine condition=\"contains\">cmdkey</CommandLine>\n      <CommandLine condition=\"contains\">vaultcmd</CommandLine>\n    </ProcessCreate>\n\n    <DriverLoad onmatch=\"include\">\n      <ImageLoaded condition=\"end with\">.sys</ImageLoaded>\n    </DriverLoad>\n\n    <ProcessAccess onmatch=\"include\">\n      <TargetImage condition=\"contains\">chrome.exe</TargetImage>\n      <TargetImage condition=\"contains\">firefox.exe</TargetImage>\n      <TargetImage condition=\"contains\">msedge.exe</TargetImage>\n    </ProcessAccess>\n\n    <FileCreate onmatch=\"include\">\n      <TargetFilename condition=\"contains\">READ_ME.txt</TargetFilename>\n      <TargetFilename condition=\"contains\">HOW_TO_DECRYPT</TargetFilename>\n      <TargetFilename condition=\"contains\">passwords.txt</TargetFilename>\n      <TargetFilename condition=\"end with\">.encrypted</TargetFilename>\n      <TargetFilename condition=\"end with\">.locked</TargetFilename>\n    </FileCreate>\n  </EventFiltering>\n</Sysmon>\n```\n\n### 2. SharePoint/IIS Log Collection\n\n**IIS W3C Log Format:**\n\n```xml\n<localfile>\n  <location>C:\\inetpub\\logs\\LogFiles\\W3SVC1\\*.log</location>\n  <log_format>iis</log_format>\n</localfile>\n```\n\n**Required IIS Log Fields:**\n- date, time\n- c-ip (client IP)\n- cs-method (HTTP method)\n- cs-uri-stem (request path)\n- cs-uri-query (query parameters)\n- sc-status (HTTP status code)\n- cs(User-Agent)\n- cs(Referer)\n- cs-username (authentication)\n\n### 3. Network Connection Logging\n\n**iptables/nftables (Linux):**\n\n```bash\n# Log new connections\niptables -A OUTPUT -m state --state NEW -j LOG --log-prefix \"NEW_CONN: \"\n\n# Configure rsyslog to send to Wazuh\necho \"kern.warning /var/log/iptables.log\" >> /etc/rsyslog.conf\n```\n\n**Windows Firewall:**\n\n```powershell\n# Enable connection logging\nSet-NetFirewallProfile -Profile Domain,Public,Private -LogBlocked True -LogAllowed True\nauditpol /set /category:\"Logon/Logoff\" /success:enable /failure:enable\n```\n\n---\n\n## Testing and Validation\n\n### Test Cases\n\n#### Test 1: Mirai Hash Detection (Rule 100000)\n\n```bash\n# Create test file with known hash\necho \"test_mirai_sample\" > /tmp/test_mirai.elf\n# Manually calculate SHA256 and inject into Wazuh log for testing\n# Or use actual sample in controlled environment\n```\n\n**Expected Result:**\n- Alert level 12\n- Description: \"Mirai botnet malware detected (UPX-packed ELF) - SHA256 match\"\n\n#### Test 2: UPX Detection (Rules 100010-100011)\n\n```bash\n# Download legitimate UPX\nwget https://github.com/upx/upx/releases/download/v4.2.1/upx-4.2.1-amd64_linux.tar.xz\ntar xf upx-4.2.1-amd64_linux.tar.xz\ncp upx-4.2.1-amd64_linux/upx /tmp/upx_test\n```\n\n**Expected Result:**\n- Rule 100010: Level 10 (UPX binary detected)\n- Rule 100011: Level 12 (UPX in /tmp - suspicious location)\n\n#### Test 3: Botnet Mass Connection (Rule 100020)\n\n```bash\n# Simulate mass connections (NON-PRODUCTION ONLY)\nfor i in {1..1100}; do\n  timeout 0.1 nc -zv 192.168.1.$((RANDOM % 255)) 22 2>&1 | logger &\ndone\n```\n\n**Expected Result:**\n- Rule 100020: Level 8 (>1000 connections in 5 min)\n\n#### Test 4: EDR Killer Detection (Rule 100032)\n\n```powershell\n# Windows test (controlled environment)\nsc query \"WinDefend\" | Out-String | Write-EventLog -LogName Application -Source \"Test\" -EventId 1 -Message\n```\n\n**Expected Result:**\n- Rule 100032: Level 11 (EDR service termination attempt)\n\n#### Test 5: Credential Theft (Rule 100041)\n\n```bash\n# Linux test\ncat ~/.config/google-chrome/Default/Login\\ Data > /dev/null\n```\n\n**Expected Result:**\n- Rule 100045: Level 10 (Linux browser credential access)\n\n#### Test 6: Ransomware Simulation (Rule 100051)\n\n```powershell\n# Windows test\necho \"Your files are encrypted. Send Bitcoin to...\" > $env:USERPROFILE\\Desktop\\READ_ME.txt\n```\n\n**Expected Result:**\n- Rule 100051: Level 14 (CRITICAL: Ransom note created)\n\n#### Test 7: SharePoint Exploitation (Rule 100060)\n\n```bash\n# Test against SharePoint server (authorized testing only)\ncurl -H \"Referer: https://sharepoint.com\" http://sharepoint-server/_vti_bin/spdisco.aspx\n```\n\n**Expected Result:**\n- Rule 100060: Level 11 (Unauthenticated _vti_bin access)\n- Rule 100061: Level 13 (Forged Referer header)\n\n---\n\n## False Positive Mitigation\n\n### 1. UPX Detection (Rules 100010-100011)\n\n**Common False Positives:**\n- Legitimate games using UPX compression\n- Open-source tools (penetration testing utilities)\n- Legacy industrial/embedded software\n\n**Mitigation Strategies:**\n\n```xml\n<!-- Create whitelist rule -->\n<rule id=\"100015\" level=\"0\">\n  <if_sid>100010,100011</if_sid>\n  <field name=\"file_sha256\">HASH_OF_LEGITIMATE_UPX_BINARY</field>\n  <description>Whitelisted legitimate UPX binary</description>\n</rule>\n\n<!-- Whitelist specific paths -->\n<rule id=\"100016\" level=\"0\">\n  <if_sid>100010,100011</if_sid>\n  <field name=\"file_path\">^/opt/legitimate_software/|^/usr/local/games/</field>\n  <description>Whitelisted UPX in approved directories</description>\n</rule>\n```\n\n### 2. Botnet Connection Detection (Rules 100020-100024)\n\n**Common False Positives:**\n- Web servers with high connection volumes\n- Load balancers and proxies\n- Network monitoring tools (Nagios, Zabbix)\n\n**Mitigation:**\n\n```xml\n<!-- Exclude known high-traffic servers -->\n<rule id=\"100025\" level=\"0\">\n  <if_sid>100020,100021,100024</if_sid>\n  <hostname>web-server-01|proxy-01|monitoring-server</hostname>\n  <description>Whitelisted high-traffic server</description>\n</rule>\n\n<!-- Adjust thresholds for specific hosts -->\n<!-- Modify frequency values in original rules per-host -->\n```\n\n### 3. Credential Access (Rules 100040-100042)\n\n**Common False Positives:**\n- Password managers (LastPass, 1Password, Bitwarden)\n- Browser sync services\n- Backup software (Veeam, Acronis)\n\n**Mitigation:**\n\n```xml\n<!-- Whitelist password managers -->\n<rule id=\"100046\" level=\"0\">\n  <if_sid>100040,100041</if_sid>\n  <field name=\"process\">LastPass\\.exe|1Password\\.exe|Bitwarden\\.exe</field>\n  <description>Whitelisted password manager access</description>\n</rule>\n\n<!-- Whitelist backup software -->\n<rule id=\"100047\" level=\"0\">\n  <if_sid>100041,100042</if_sid>\n  <field name=\"process\">VeeamAgent\\.exe|AcronisAgent\\.exe</field>\n  <description>Whitelisted backup software</description>\n</rule>\n```\n\n### 4. Ransomware Behavior (Rules 100050-100055)\n\n**Common False Positives:**\n- Legitimate encryption tools (BitLocker, VeraCrypt)\n- Backup/archival operations (7-Zip, WinRAR)\n- Development environments (compiling, testing)\n\n**Mitigation:**\n\n```xml\n<!-- Whitelist legitimate encryption tools -->\n<rule id=\"100056\" level=\"0\">\n  <if_sid>100050</if_sid>\n  <field name=\"process\">BitLocker\\.exe|VeraCrypt\\.exe</field>\n  <description>Whitelisted encryption software</description>\n</rule>\n\n<!-- Exclude development/test directories -->\n<rule id=\"100057\" level=\"0\">\n  <if_sid>100050,100054</if_sid>\n  <field name=\"file_path\">^C:\\\\Dev\\\\|^C:\\\\Projects\\\\|^D:\\\\Testing\\\\</field>\n  <description>Whitelisted development directories</description>\n</rule>\n```\n\n### 5. SharePoint Detection (Rules 100060-100066)\n\n**Common False Positives:**\n- SharePoint Designer legitimate access\n- Internal monitoring tools\n- Authenticated API integrations\n\n**Mitigation:**\n\n```xml\n<!-- Whitelist internal IPs -->\n<rule id=\"100067\" level=\"0\">\n  <if_sid>100060,100061,100063</if_sid>\n  <srcip>10.0.0.0/8|172.16.0.0/12|192.168.0.0/16</srcip>\n  <description>Whitelisted internal SharePoint access</description>\n</rule>\n\n<!-- Whitelist authenticated users -->\n<rule id=\"100068\" level=\"0\">\n  <if_sid>100060</if_sid>\n  <field name=\"auth\">!^-$|!^$</field>\n  <description>Authenticated SharePoint access (exclude from CVE rule)</description>\n</rule>\n```\n\n---\n\n## Tuning Recommendations\n\n### 1. Baseline Normal Behavior (First 30 Days)\n\n**Objective:** Understand environment-specific patterns before enforcing strict thresholds.\n\n**Process:**\n1. Deploy rules at **INFO level (0-3)** initially\n2. Collect baseline data for:\n   - Normal connection volumes per host\n   - Legitimate UPX binaries in environment\n   - Authorized credential access patterns\n   - SharePoint API usage patterns\n3. After 30 days, adjust thresholds and exclusions\n4. Raise severity levels to operational values\n\n**Example Baseline Rule:**\n\n```xml\n<!-- Baseline version of Rule 100020 -->\n<rule id=\"100020\" level=\"3\">\n  <if_group>syslog</if_group>\n  <match>SYN_SENT|connection attempt</match>\n  <frequency>1000</frequency>\n  <timeframe>300</timeframe>\n  <description>[BASELINE] Mass network connection attempts - Collecting data</description>\n  <group>baseline,botnet,network_scanning,</group>\n</rule>\n```\n\n### 2. Environment-Specific Threshold Adjustments\n\n**High-Traffic Environments:**\n\n| Rule | Default Threshold | High-Traffic Threshold |\n|------|-------------------|------------------------|\n| 100020 | 1000 connections/5min | 5000 connections/5min |\n| 100024 | 5000 connections/10min | 25000 connections/10min |\n| 100022 | 50 auth failures/1min | 200 auth failures/1min |\n\n**Implementation:**\n\n```xml\n<!-- High-traffic variant of Rule 100020 -->\n<rule id=\"100020\" level=\"8\">\n  <if_group>syslog</if_group>\n  <match>SYN_SENT|connection attempt</match>\n  <frequency>5000</frequency>\n  <timeframe>300</timeframe>\n  <hostname>!web-farm-*|!proxy-*</hostname>\n  <description>Mass network connection attempts (adjusted threshold)</description>\n</rule>\n```\n\n### 3. Time-Based Tuning\n\n**Objective:** Reduce false positives during maintenance windows or known high-activity periods.\n\n```xml\n<!-- Suppress during maintenance window (Sunday 2-4 AM) -->\n<rule id=\"100058\" level=\"0\">\n  <if_sid>100050,100051,100052</if_sid>\n  <time>02:00:00-04:00:00</time>\n  <weekday>sunday</weekday>\n  <description>Maintenance window suppression</description>\n</rule>\n```\n\n### 4. Severity Escalation Based on Asset Criticality\n\n**Objective:** Increase alert priority for critical systems.\n\n```xml\n<!-- Escalate EDR killer detection on critical servers -->\n<rule id=\"100035\" level=\"15\">\n  <if_sid>100030,100031,100033</if_sid>\n  <hostname>dc-|sql-|exchange-|sharepoint-</hostname>\n  <description>CRITICAL: EDR killer on critical infrastructure</description>\n  <group>critical_asset,edr_killer,</group>\n</rule>\n```\n\n---\n\n## Response Playbooks\n\n### Playbook 1: Known Malware Hash Detection (Rules 100000-100002)\n\n**Trigger:** Any of Rules 100000, 100001, 100002\n\n**Severity:** High to Critical\n\n**Response Steps:**\n\n1. **Immediate (Within 5 minutes):**\n   - Isolate affected system from network (disconnect network cable or disable NIC)\n   - Capture memory dump: `dd if=/dev/mem of=/forensics/memory_dump.raw` (Linux) or use WinPMEM (Windows)\n   - Document active network connections: `netstat -antp` or `Get-NetTCPConnection`\n\n2. **Investigation (Within 30 minutes):**\n   - Verify file hash: `sha256sum /path/to/file`\n   - Check VirusTotal for additional context\n   - Review file creation time and parent process\n   - Identify initial infection vector (web download, email, lateral movement)\n\n3. **Containment (Within 1 hour):**\n   - Quarantine malware sample: `mv /tmp/malware /quarantine/` (preserve for analysis)\n   - Kill malicious processes: `kill -9 PID`\n   - Block C2 domains/IPs at firewall\n   - Scan other systems for same hash (enterprise-wide)\n\n4. **Eradication:**\n   - Remove malware and associated files\n   - Clear persistence mechanisms (cron jobs, systemd services, registry Run keys)\n   - Restore from last known-good backup if system integrity compromised\n\n5. **Recovery:**\n   - Rebuild system if heavily compromised\n   - Restore data from verified clean backups\n   - Update detection signatures and IOCs across environment\n\n6. **Post-Incident:**\n   - Document timeline and root cause\n   - Update SIEM correlation rules\n   - Share IOCs with threat intelligence community\n\n---\n\n### Playbook 2: Active Botnet Infection (Rules 100020-100024)\n\n**Trigger:** Rule 100024 (>5000 connections) or correlation rule 100070\n\n**Severity:** Critical\n\n**Response Steps:**\n\n1. **Immediate (Within 2 minutes):**\n   - **BLOCK** all outbound connections from infected host at firewall\n   - Capture network traffic: `tcpdump -i eth0 -w /forensics/botnet_traffic.pcap`\n   - Document active connections: `netstat -antp > /forensics/connections.txt`\n\n2. **Analysis (Within 15 minutes):**\n   - Identify C2 servers from connection logs\n   - Extract targeted ports (brute force targets)\n   - Determine botnet family (Mirai, RondoDox, etc.)\n   - Check for lateral movement to other internal systems\n\n3. **Containment (Within 30 minutes):**\n   - Isolate all potentially infected systems\n   - Block C2 IP ranges at perimeter firewall\n   - Deploy network-based IPS signatures for identified botnet\n   - Force password resets on all systems (credential brute force risk)\n\n4. **Eradication:**\n   - Identify and remove botnet binary (check /tmp, /dev/shm, /var/tmp)\n   - Remove persistence mechanisms\n   - Patch exploited vulnerabilities (if initial infection via CVE)\n\n5. **Recovery:**\n   - Rebuild compromised IoT devices (factory reset often insufficient)\n   - Segment IoT devices on isolated VLAN\n   - Implement egress filtering (deny unknown outbound connections)\n\n6. **Prevention:**\n   - Disable unnecessary services (Telnet, unnecessary SSH access)\n   - Implement strong authentication (key-based SSH, disable root login)\n   - Deploy device-level firewalls on IoT devices\n\n---\n\n### Playbook 3: EDR Killer + Ransomware (Rule 100071)\n\n**Trigger:** Correlation Rule 100071 (EDR termination + encryption)\n\n**Severity:** CRITICAL - Active Ransomware Attack\n\n**Response Steps:**\n\n1. **IMMEDIATE (Within 60 seconds):**\n   - **DO NOT SHUT DOWN** infected system (preserve memory evidence)\n   - **ISOLATE** system from network (pull cable, disable switch port)\n   - **ALERT** executive leadership and legal team\n   - **PRESERVE** memory dump if safe to do so\n\n2. **Rapid Assessment (Within 5 minutes):**\n   - Identify ransomware variant (ransom note analysis, file extensions)\n   - Determine encryption scope (local files only vs. network shares)\n   - Check if backups were targeted (shared backup drives)\n   - Assess business impact (critical systems encrypted?)\n\n3. **Containment (Within 15 minutes):**\n   - Isolate all systems in affected network segment\n   - Disable domain admin accounts (prevent lateral spread)\n   - Shutdown shared file servers if encryption spreading\n   - Block identified ransomware C2 domains/IPs\n\n4. **Recovery Decision (Within 30 minutes):**\n   - **Option A: Restore from Backup**\n     - Verify backup integrity (not encrypted)\n     - Restore to isolated recovery environment\n     - Scan restored data for malware before production\n   - **Option B: Attempt Decryption**\n     - Check NoMoreRansom.org for decryption tools\n     - Consult with ransomware specialists\n     - **DO NOT PAY RANSOM** without executive decision\n   - **Option C: Accept Data Loss**\n     - If backups compromised and no decryption available\n     - Document decision and rationale\n\n5. **Forensic Analysis:**\n   - Identify initial access vector (phishing, RDP brute force, CVE)\n   - Reconstruct attack timeline\n   - Analyze BYOVD driver used (submit to threat intel)\n   - Document all compromised accounts\n\n6. **Eradication:**\n   - Remove ransomware binaries and associated files\n   - Remove vulnerable drivers\n   - Clear persistence mechanisms\n   - Scan entire network for related IOCs\n\n7. **Recovery:**\n   - Rebuild compromised systems from scratch\n   - Restore data from verified clean backups\n   - Force password reset for all accounts\n   - Re-enable EDR/AV and verify protection\n\n8. **Post-Incident Hardening:**\n   - Implement application whitelisting\n   - Enable Windows Attack Surface Reduction (ASR) rules\n   - Deploy driver signature enforcement\n   - Implement privileged access workstations (PAWs)\n   - Conduct tabletop exercise for lessons learned\n\n9. **Legal/Regulatory:**\n   - Notify law enforcement (FBI, local cyber crime unit)\n   - Comply with breach notification requirements (GDPR, state laws)\n   - Engage cyber insurance carrier\n   - Preserve evidence for potential legal action\n\n---\n\n### Playbook 4: Credential Theft Detected (Rules 100040-100045, 100072)\n\n**Trigger:** Rule 100072 (credential theft + staging) or multiple credential access alerts\n\n**Severity:** High\n\n**Response Steps:**\n\n1. **Immediate (Within 5 minutes):**\n   - Isolate affected system from network\n   - Force logout of all active sessions for affected user\n   - Disable affected user account temporarily\n   - Capture memory dump (credentials may still be in memory)\n\n2. **Investigation (Within 15 minutes):**\n   - Identify stolen credentials (browser, Windows Vault, etc.)\n   - Review process execution logs (identify infostealer malware)\n   - Check for data exfiltration (network logs, USB usage)\n   - Search for staging files (passwords.txt, creds.txt)\n\n3. **Impact Assessment (Within 30 minutes):**\n   - Determine scope of compromised accounts\n   - Check authentication logs for unauthorized access\n   - Review email sent items for phishing (compromised email)\n   - Assess financial accounts (banking credentials)\n\n4. **Containment:**\n   - Force password reset for ALL accounts on compromised system\n   - Revoke active sessions for affected accounts\n   - Enable MFA on all accounts (if not already enabled)\n   - Monitor for credential stuffing attacks using stolen data\n\n5. **Eradication:**\n   - Identify and remove infostealer malware (RedLine, Raccoon, Vidar, etc.)\n   - Clear browser caches and credential stores\n   - Scan for additional persistence mechanisms\n\n6. **Recovery:**\n   - Rebuild system if heavily infected\n   - Restore browser profiles from clean backup\n   - Re-enable accounts with new strong passwords\n\n7. **User Notification:**\n   - Inform affected users of credential compromise\n   - Provide guidance on changing passwords across services\n   - Recommend credit monitoring if financial data stolen\n   - Report to HR/Legal if corporate data exfiltrated\n\n8. **Prevention:**\n   - Deploy password manager (reduce browser credential storage)\n   - Implement credential guard (Windows)\n   - Enable browser profile encryption\n   - Train users on phishing awareness\n\n---\n\n### Playbook 5: SharePoint Exploitation (Rules 100060-100066)\n\n**Trigger:** Rule 100064 (confirmed RCE) or Rule 100061 (active exploitation)\n\n**Severity:** Critical\n\n**Response Steps:**\n\n1. **IMMEDIATE (Within 2 minutes):**\n   - **BLOCK** source IP at firewall\n   - **DISABLE** affected SharePoint web services (`iisreset /stop`)\n   - Capture memory dump of IIS worker process (w3wp.exe)\n   - Preserve IIS logs and SharePoint ULS logs\n\n2. **Rapid Assessment (Within 10 minutes):**\n   - Review IIS logs for successful exploitation (HTTP 200 with RCE indicators)\n   - Check for web shell creation:\n     - `dir C:\\inetpub\\wwwroot\\_vti_bin\\*.aspx /s`\n     - `dir C:\\inetpub\\wwwroot\\_layouts\\*.aspx /s`\n   - Identify extent of compromise (single server vs. farm)\n   - Review SharePoint admin logs for unauthorized changes\n\n3. **Containment (Within 30 minutes):**\n   - Isolate compromised SharePoint server(s)\n   - Disable SharePoint service accounts (prevent lateral movement)\n   - Block identified attacker IPs at perimeter\n   - Deploy emergency WAF rules to block exploitation patterns\n\n4. **Forensic Analysis:**\n   - Analyze IIS logs for full attack timeline\n   - Extract web shells for malware analysis\n   - Review security event logs for privilege escalation\n   - Check for data exfiltration (large HTTP responses, unusual times)\n\n5. **Eradication:**\n   - Remove web shells and malicious files\n   - Apply CVE-2025-53770/53771 patches\n   - Rebuild server if deep compromise suspected\n   - Clear attacker accounts created during exploitation\n\n6. **Recovery:**\n   - Restore SharePoint from last known-good backup\n   - Verify data integrity (no backdoors in restored content)\n   - Re-enable services in staged approach\n   - Monitor for re-exploitation attempts\n\n7. **Emergency Patching:**\n   - Apply SharePoint security updates immediately\n   - Update all servers in farm (not just compromised)\n   - Test patches in isolated environment first if possible\n   - Document patch application for compliance\n\n8. **Prevention:**\n   - Deploy WAF with OWASP ModSecurity rules\n   - Implement IP whitelisting for `/_vti_bin/` if possible\n   - Enable SharePoint audit logging (all actions)\n   - Disable unnecessary SharePoint web services\n   - Implement least-privilege for SharePoint service accounts\n\n9. **Notification:**\n   - Inform management of breach\n   - Report to cyber insurance carrier\n   - Comply with breach notification laws (if data exfiltrated)\n   - Share IOCs with ISAC/threat intelligence community\n\n---\n\n## Performance Considerations\n\n### Rule Efficiency Analysis\n\n**High-Performance Rules (Minimal CPU Impact):**\n- Hash matching (100000-100002): Direct field comparison\n- Exact string matching (100051, 100032): Simple pattern matching\n\n**Medium-Performance Rules (Moderate CPU Impact):**\n- Frequency-based detection (100020-100024): Requires event aggregation\n- Regex matching (100012, 100030): Pattern complexity impacts performance\n\n**Resource-Intensive Rules (Higher CPU Impact):**\n- Complex regex with backreferences\n- Multi-field correlation (100070-100072)\n- High-frequency event processing (100054)\n\n### Optimization Recommendations\n\n1. **Index Frequently Matched Fields:**\n   ```xml\n   <!-- Wazuh manager: /var/ossec/etc/ossec.conf -->\n   <indexer>\n     <enabled>yes</enabled>\n     <index>file_sha256,srcip,dstport,hostname</index>\n   </indexer>\n   ```\n\n2. **Use Specific Parent Rules:**\n   - Instead of `<if_sid>1</if_sid>` (all events), use specific parent rule IDs\n   - Example: `<if_sid>550</if_sid>` for auditd events only\n\n3. **Limit Regex Complexity:**\n   - Avoid excessive backreferences\n   - Use anchors (`^`, `$`) to limit search scope\n   - Pre-filter with simple `<match>` before complex `<regex>`\n\n4. **Adjust Frequency Timeframes:**\n   - Shorter timeframes = less memory usage\n   - Balance detection effectiveness with resource consumption\n\n5. **Implement Rule Exclusions Early:**\n   - Place high-frequency exclusions (whitelists) before intensive rules\n   - Use `level=\"0\"` rules to drop events early in processing\n\n---\n\n## MITRE ATT&CK Mapping\n\n### Complete Coverage Matrix\n\n| MITRE Technique | Technique Name | Wazuh Rules | Coverage Level |\n|-----------------|----------------|-------------|----------------|\n| **T1027.002** | Obfuscated Files or Information: Software Packing | 100000, 100001, 100010, 100011 | High |\n| **T1036** | Masquerading | 100011, 100012 | Medium |\n| **T1046** | Network Service Discovery | 100002, 100020, 100021, 100024 | High |\n| **T1057** | Process Discovery | 100002, 100023 | Medium |\n| **T1059.003** | Command and Scripting Interpreter: Windows Command Shell | 100064 | High |\n| **T1059.004** | Command and Scripting Interpreter: Unix Shell | 100000, 100012 | Medium |\n| **T1068** | Exploitation for Privilege Escalation | 100030, 100031, 100033 | High |\n| **T1070.004** | Indicator Removal: File Deletion | 100053 | Medium |\n| **T1071.001** | Application Layer Protocol: Web Protocols | 100000, 100013 | Medium |\n| **T1074.001** | Data Staged: Local Data Staging | 100044, 100072 | High |\n| **T1110** | Brute Force | 100002, 100021, 100022 | High |\n| **T1110.001** | Brute Force: Password Guessing | 100021 | High |\n| **T1110.003** | Brute Force: Password Spraying | 100021 | High |\n| **T1190** | Exploit Public-Facing Application | 100060-100066 | High |\n| **T1203** | Exploitation for Client Execution | 100062, 100065 | Medium |\n| **T1485** | Data Destruction | 100053 | Medium |\n| **T1486** | Data Encrypted for Impact | 100050, 100051, 100054, 100071 | High |\n| **T1489** | Service Stop | 100055 | High |\n| **T1490** | Inhibit System Recovery | 100052, 100071 | High |\n| **T1518.001** | Software Discovery: Security Software Discovery | 100023 | Medium |\n| **T1543.003** | Create or Modify System Process: Windows Service | 100033, 100034 | High |\n| **T1555** | Credentials from Password Stores | 100040-100045, 100072 | High |\n| **T1555.003** | Credentials from Password Stores: Web Browsers | 100040, 100041, 100045 | High |\n| **T1555.004** | Credentials from Password Stores: Windows Credential Manager | 100042, 100043 | High |\n| **T1562.001** | Impair Defenses: Disable or Modify Tools | 100030-100032, 100071 | High |\n| **T1595.001** | Active Scanning: Scanning IP Blocks | 100020 | Medium |\n| **T1595.002** | Active Scanning: Vulnerability Scanning | 100063 | Medium |\n\n**Coverage Levels:**\n- **High:** Multiple rules with different detection angles\n- **Medium:** Single rule or limited coverage\n- **Low:** Partial coverage or indirect detection\n\n---\n\n## Compliance and Reporting\n\n### Regulatory Framework Alignment\n\n**PCI DSS 4.0:**\n- Requirement 10.2.4 (Invalid logical access attempts): Rules 100022, 100060\n- Requirement 10.2.5 (Changes to identification/authentication): Rules 100040-100045\n- Requirement 11.5 (File integrity monitoring): Rules 100000-100002, 100050\n- Requirement 6.5.1 (Injection flaws): Rules 100062, 100064\n\n**NIST CSF 2.0:**\n- DE.CM-1 (Network monitored): Rules 100020-100024\n- DE.CM-4 (Malicious code detected): Rules 100000-100013\n- DE.CM-7 (Monitoring for unauthorized activity): Rules 100040-100045\n- RS.AN-3 (Analysis performed): All correlation rules (100070-100072)\n\n**CIS Controls v8:**\n- Control 8.5 (Collect Detailed Audit Logs): All rules\n- Control 10.1 (Deploy Anti-Malware Software): Rules 100000-100034\n- Control 13.6 (Collect Network Traffic Logs): Rules 100020-100024\n- Control 18.3 (Remediate Penetration Test Findings): Rules 100060-100066\n\n### Executive Reporting Template\n\n```\nWazuh Malware Detection Summary Report\nPeriod: [Start Date] - [End Date]\n\nCRITICAL FINDINGS:\n- Ransomware Attacks Detected: [Count from Rules 100050-100055, 100071]\n- EDR Killer Attempts: [Count from Rules 100030-100034]\n- Known Malware Detections: [Count from Rules 100000-100002]\n\nHIGH PRIORITY:\n- Credential Theft Incidents: [Count from Rules 100040-100045]\n- Botnet Infections: [Count from Rules 100020-100024]\n- SharePoint Exploitation: [Count from Rules 100060-100066]\n\nTREND ANALYSIS:\n- Week-over-week change in malware detections\n- Most frequently triggered rules\n- Top affected systems/departments\n\nREMEDIATION STATUS:\n- Incidents resolved: X%\n- Mean time to detect (MTTD): X minutes\n- Mean time to respond (MTTR): X hours\n\nRECOMMENDATIONS:\n[Based on specific findings]\n```\n\n---\n\n## Maintenance and Updates\n\n### Monthly Review Checklist\n\n- [ ] Review false positive rate per rule\n- [ ] Adjust frequency thresholds based on environmental changes\n- [ ] Update malware hash list (rules 100000-100002)\n- [ ] Review and update whitelists\n- [ ] Validate log source collection (auditd, Sysmon, IIS)\n- [ ] Test correlation rules for accuracy\n- [ ] Update MITRE ATT&CK mappings\n- [ ] Review incident response metrics\n\n### Quarterly Updates\n\n- [ ] Tune rule severity levels based on actual impact\n- [ ] Incorporate new threat intelligence (IOCs, TTPs)\n- [ ] Update SharePoint CVE rules for new vulnerabilities\n- [ ] Review ransomware family indicators (new variants)\n- [ ] Conduct tabletop exercise with SOC team\n- [ ] Update response playbooks based on lessons learned\n\n### Annual Assessment\n\n- [ ] Full ruleset performance audit\n- [ ] Benchmark against industry standards (MITRE Engenuity, etc.)\n- [ ] Cost-benefit analysis of detection coverage\n- [ ] Update compliance mappings for new regulations\n- [ ] Strategic roadmap for threat detection enhancements\n\n---\n\n## Appendix: Quick Reference\n\n### Rule Severity Guide\n\n| Level | Severity | Response Time | Examples |\n|-------|----------|---------------|----------|\n| 0-3 | Informational | N/A | Baseline, whitelists |\n| 4-7 | Low | 24 hours | Reconnaissance, scanning |\n| 8-10 | Medium | 4 hours | Suspicious activity |\n| 11-13 | High | 1 hour | Confirmed threats |\n| 14-15 | Critical | 15 minutes | Active attacks |\n\n### Critical Rules Priority Matrix\n\n| Rule ID | Priority | Threat | Response Action |\n|---------|----------|--------|-----------------|\n| 100071 | P0 | Ransomware + EDR killer | Immediate isolation |\n| 100051 | P0 | Ransom note creation | Activate IR team |\n| 100064 | P0 | SharePoint RCE | Block IP, disable service |\n| 100024 | P1 | Active botnet | Network isolation |\n| 100002 | P1 | RondoDox malware | Quarantine + rebuild |\n| 100072 | P1 | Credential theft chain | Force password reset |\n| 100031 | P1 | BYOVD attack | EDR restoration |\n\n### Log Source Requirements Summary\n\n| Detection Category | Linux | Windows | Network | Web Server |\n|--------------------|-------|---------|---------|------------|\n| Malware Hashes | FIM | FIM | - | - |\n| UPX/Mirai | FIM, auditd | - | - | - |\n| Botnet Activity | auditd, iptables | - | Firewall logs | - |\n| EDR Killer | - | Sysmon (1,6), Event Logs | - | - |\n| Credential Theft | auditd, FIM | Sysmon (1,10,11), FIM | - | - |\n| Ransomware | FIM, auditd | Sysmon (1,11), FIM | - | - |\n| SharePoint CVE | - | - | - | IIS W3C |\n\n---\n\n## Support and Contact\n\n**Wazuh Documentation:**\n- Official Docs: https://documentation.wazuh.com/\n- Rule Syntax: https://documentation.wazuh.com/current/user-manual/ruleset/\n\n**Threat Intelligence Sources:**\n- MalwareBazaar: https://bazaar.abuse.ch/\n- AlienVault OTX: https://otx.alienvault.com/\n- MITRE ATT&CK: https://attack.mitre.org/\n\n**Community:**\n- Wazuh Slack: https://wazuh.com/community/join-us-on-slack/\n- GitHub Issues: https://github.com/wazuh/wazuh/issues\n\n---\n\n**Document Version:** 1.0\n**Last Updated:** 2025-11-27\n**Next Review Date:** 2025-12-27\n","structuredPatch":[],"originalFile":null}}
{"parentUuid":"770617fa-0f5f-4299-b40c-e38afcfd6345","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LZaPGVDpsYwMZjk2tWmnt3","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create a deployment script to help with implementation:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":48027,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":48027,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CVXtxKYxvy42n2z6RwciP","type":"assistant","uuid":"f216b4eb-bdc0-401f-bc12-bdabccacb7db","timestamp":"2025-11-27T06:09:59.894Z"}
{"parentUuid":"f216b4eb-bdc0-401f-bc12-bdabccacb7db","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LZaPGVDpsYwMZjk2tWmnt3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PnUbkZ2SRCYMEBx9sZ65C9","name":"Write","input":{"file_path":"/home/stanner/deploy_wazuh_rules.sh","content":"#!/bin/bash\n################################################################################\n# Wazuh Malware Detection Rules Deployment Script\n# Version: 1.0\n# Date: 2025-11-27\n#\n# Description: Automated deployment and validation of custom Wazuh detection\n#              rules for malware threats (Mirai, RondoDox, ransomware, EDR\n#              killers, credential theft, SharePoint CVE)\n#\n# Usage: ./deploy_wazuh_rules.sh [--test|--deploy|--rollback]\n#\n# Options:\n#   --test      Validate rules without deploying\n#   --deploy    Deploy rules to Wazuh manager\n#   --rollback  Restore previous ruleset\n#\n################################################################################\n\nset -euo pipefail\n\n# Color codes for output\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m' # No Color\n\n# Configuration\nWAZUH_INSTALL_DIR=\"/var/ossec\"\nRULES_DIR=\"${WAZUH_INSTALL_DIR}/etc/rules\"\nCUSTOM_RULES_FILE=\"${RULES_DIR}/local_rules.xml\"\nBACKUP_DIR=\"/var/ossec/backups\"\nDEPLOYMENT_RULES=\"wazuh_malware_detection_rules.xml\"\nTIMESTAMP=$(date +%Y%m%d_%H%M%S)\n\n# Logging\nLOG_FILE=\"/var/log/wazuh_rule_deployment_${TIMESTAMP}.log\"\n\n################################################################################\n# Functions\n################################################################################\n\nlog() {\n    local level=$1\n    shift\n    local message=\"$*\"\n    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')\n    echo -e \"${timestamp} [${level}] ${message}\" | tee -a \"${LOG_FILE}\"\n}\n\ninfo() {\n    log \"INFO\" \"${BLUE}$*${NC}\"\n}\n\nsuccess() {\n    log \"SUCCESS\" \"${GREEN}$*${NC}\"\n}\n\nwarning() {\n    log \"WARNING\" \"${YELLOW}$*${NC}\"\n}\n\nerror() {\n    log \"ERROR\" \"${RED}$*${NC}\"\n}\n\ncheck_prerequisites() {\n    info \"Checking prerequisites...\"\n\n    # Check if running as root\n    if [[ $EUID -ne 0 ]]; then\n        error \"This script must be run as root\"\n        exit 1\n    fi\n\n    # Check if Wazuh is installed\n    if [[ ! -d \"${WAZUH_INSTALL_DIR}\" ]]; then\n        error \"Wazuh installation not found at ${WAZUH_INSTALL_DIR}\"\n        exit 1\n    fi\n\n    # Check if Wazuh manager is running\n    if ! systemctl is-active --quiet wazuh-manager; then\n        error \"Wazuh manager is not running\"\n        exit 1\n    fi\n\n    # Check if deployment rules file exists\n    if [[ ! -f \"${DEPLOYMENT_RULES}\" ]]; then\n        error \"Deployment rules file not found: ${DEPLOYMENT_RULES}\"\n        error \"Please ensure wazuh_malware_detection_rules.xml is in the current directory\"\n        exit 1\n    fi\n\n    # Create backup directory if it doesn't exist\n    mkdir -p \"${BACKUP_DIR}\"\n\n    success \"Prerequisites check passed\"\n}\n\nvalidate_xml_syntax() {\n    info \"Validating XML syntax of new rules...\"\n\n    if ! command -v xmllint &> /dev/null; then\n        warning \"xmllint not found. Installing libxml2-utils...\"\n        apt-get update -qq && apt-get install -y -qq libxml2-utils\n    fi\n\n    if xmllint --noout \"${DEPLOYMENT_RULES}\" 2>&1 | tee -a \"${LOG_FILE}\"; then\n        success \"XML syntax validation passed\"\n        return 0\n    else\n        error \"XML syntax validation failed\"\n        return 1\n    fi\n}\n\nvalidate_rule_syntax() {\n    info \"Validating Wazuh rule syntax...\"\n\n    # Create temporary rules file for testing\n    local temp_rules=\"${RULES_DIR}/test_rules_${TIMESTAMP}.xml\"\n    cp \"${DEPLOYMENT_RULES}\" \"${temp_rules}\"\n\n    # Test configuration with new rules\n    if ${WAZUH_INSTALL_DIR}/bin/wazuh-logtest -c \"${WAZUH_INSTALL_DIR}/etc/ossec.conf\" -d \"${RULES_DIR}\" > /dev/null 2>&1; then\n        success \"Wazuh rule syntax validation passed\"\n        rm -f \"${temp_rules}\"\n        return 0\n    else\n        error \"Wazuh rule syntax validation failed\"\n        error \"Check log file for details: ${LOG_FILE}\"\n        rm -f \"${temp_rules}\"\n        return 1\n    fi\n}\n\nbackup_existing_rules() {\n    info \"Backing up existing rules...\"\n\n    local backup_file=\"${BACKUP_DIR}/local_rules_${TIMESTAMP}.xml\"\n\n    if [[ -f \"${CUSTOM_RULES_FILE}\" ]]; then\n        cp \"${CUSTOM_RULES_FILE}\" \"${backup_file}\"\n        success \"Existing rules backed up to: ${backup_file}\"\n        echo \"${backup_file}\" > \"${BACKUP_DIR}/last_backup.txt\"\n    else\n        warning \"No existing custom rules found. Creating new file.\"\n    fi\n}\n\ndeploy_rules() {\n    info \"Deploying new rules to Wazuh manager...\"\n\n    # Check if we should merge or replace\n    if [[ -f \"${CUSTOM_RULES_FILE}\" ]]; then\n        warning \"Existing local_rules.xml found.\"\n        read -p \"Merge with existing rules? (y/n): \" -n 1 -r\n        echo\n        if [[ $REPLY =~ ^[Yy]$ ]]; then\n            merge_rules\n        else\n            replace_rules\n        fi\n    else\n        replace_rules\n    fi\n\n    success \"Rules deployed successfully\"\n}\n\nmerge_rules() {\n    info \"Merging new rules with existing rules...\"\n\n    # Create merged rules file\n    local merged_rules=\"${BACKUP_DIR}/merged_rules_${TIMESTAMP}.xml\"\n\n    # Extract existing rules (everything between <group> tags)\n    sed -n '/<group name=/,/<\\/group>/p' \"${CUSTOM_RULES_FILE}\" > \"${merged_rules}.tmp\"\n\n    # Extract new rules (everything between <group> tags)\n    sed -n '/<group name=/,/<\\/group>/p' \"${DEPLOYMENT_RULES}\" >> \"${merged_rules}.tmp\"\n\n    # Create proper XML structure\n    cat > \"${merged_rules}\" << 'EOF'\n<!--\n  Wazuh Custom Rules - Merged Configuration\n  Auto-generated on: TIMESTAMP\n-->\n<group name=\"local,custom,\">\nEOF\n\n    # Add merged content (excluding duplicate <group> tags)\n    grep -v '<group name=' \"${merged_rules}.tmp\" | grep -v '</group>' >> \"${merged_rules}\"\n\n    # Close group tag\n    echo \"</group>\" >> \"${merged_rules}\"\n\n    # Replace timestamp placeholder\n    sed -i \"s/TIMESTAMP/$(date)/\" \"${merged_rules}\"\n\n    # Copy merged rules to production\n    cp \"${merged_rules}\" \"${CUSTOM_RULES_FILE}\"\n\n    # Cleanup\n    rm -f \"${merged_rules}.tmp\"\n\n    success \"Rules merged successfully\"\n}\n\nreplace_rules() {\n    info \"Replacing existing rules with new ruleset...\"\n\n    # Copy new rules to production\n    cp \"${DEPLOYMENT_RULES}\" \"${CUSTOM_RULES_FILE}\"\n\n    # Set proper ownership and permissions\n    chown root:wazuh \"${CUSTOM_RULES_FILE}\"\n    chmod 640 \"${CUSTOM_RULES_FILE}\"\n\n    success \"Rules replaced successfully\"\n}\n\nrestart_wazuh() {\n    info \"Restarting Wazuh manager to apply new rules...\"\n\n    if systemctl restart wazuh-manager; then\n        sleep 5\n        if systemctl is-active --quiet wazuh-manager; then\n            success \"Wazuh manager restarted successfully\"\n            return 0\n        else\n            error \"Wazuh manager failed to start after restart\"\n            return 1\n        fi\n    else\n        error \"Failed to restart Wazuh manager\"\n        return 1\n    fi\n}\n\nverify_deployment() {\n    info \"Verifying rule deployment...\"\n\n    # Check if rules are loaded\n    local rule_count=$(grep -c '<rule id=\"100[0-9][0-9][0-9]\"' \"${CUSTOM_RULES_FILE}\" || true)\n\n    if [[ ${rule_count} -gt 0 ]]; then\n        success \"Verified ${rule_count} custom rules loaded\"\n    else\n        error \"No custom rules found in deployed file\"\n        return 1\n    fi\n\n    # Test a sample rule\n    info \"Testing rule 100000 (Mirai hash detection)...\"\n    echo '<13>Nov 27 10:00:00 test syscheck: alert_new_file: /tmp/malware.elf SHA256=b6873744cfb1b2bc92f49ca61975afb7b8c491ccf41111ded5bc63575bba59d5' | \\\n        ${WAZUH_INSTALL_DIR}/bin/wazuh-logtest -q 2>&1 | tee -a \"${LOG_FILE}\"\n\n    success \"Deployment verification completed\"\n}\n\nrollback() {\n    info \"Rolling back to previous ruleset...\"\n\n    local last_backup=\"${BACKUP_DIR}/last_backup.txt\"\n\n    if [[ ! -f \"${last_backup}\" ]]; then\n        error \"No backup found to rollback to\"\n        exit 1\n    fi\n\n    local backup_file=$(cat \"${last_backup}\")\n\n    if [[ ! -f \"${backup_file}\" ]]; then\n        error \"Backup file not found: ${backup_file}\"\n        exit 1\n    fi\n\n    info \"Restoring from: ${backup_file}\"\n    cp \"${backup_file}\" \"${CUSTOM_RULES_FILE}\"\n\n    if restart_wazuh; then\n        success \"Rollback completed successfully\"\n    else\n        error \"Rollback completed but Wazuh manager failed to start\"\n        error \"Manual intervention required\"\n        exit 1\n    fi\n}\n\ndisplay_summary() {\n    cat << EOF\n\n${GREEN}\n          Wazuh Malware Detection Rules Deployment Summary         \n${NC}\n\n${BLUE}Deployment Details:${NC}\n  - Timestamp: ${TIMESTAMP}\n  - Rules File: ${CUSTOM_RULES_FILE}\n  - Backup Location: ${BACKUP_DIR}\n  - Log File: ${LOG_FILE}\n\n${BLUE}Rule Categories Deployed:${NC}\n   File Hash Detection (Rules 100000-100002)\n   Mirai/UPX-Packed ELF Detection (Rules 100010-100013)\n   Botnet Activity Detection (Rules 100020-100024)\n   EDR Killer Detection (Rules 100030-100034)\n   Credential Theft Detection (Rules 100040-100045)\n   Ransomware Behavior Detection (Rules 100050-100055)\n   SharePoint Exploitation Detection (Rules 100060-100066)\n   Composite/Correlation Rules (Rules 100070-100072)\n\n${YELLOW}Next Steps:${NC}\n  1. Review alerts in Wazuh dashboard\n  2. Tune frequency thresholds based on environment\n  3. Configure whitelists for false positives\n  4. Enable required log sources (Sysmon, auditd, IIS)\n  5. Test incident response playbooks\n\n${YELLOW}Documentation:${NC}\n  - Full documentation: wazuh_rules_documentation.md\n  - Deployment log: ${LOG_FILE}\n\n${GREEN}Deployment completed successfully!${NC}\n\nEOF\n}\n\n################################################################################\n# Main execution\n################################################################################\n\nmain() {\n    local mode=\"${1:---deploy}\"\n\n    echo -e \"${BLUE}\"\n    cat << 'EOF'\n\n                                                                   \n   Wazuh Malware Detection Rules Deployment Script                \n   Version 1.0 - November 27, 2025                                \n                                                                   \n\nEOF\n    echo -e \"${NC}\"\n\n    case \"${mode}\" in\n        --test)\n            info \"Running in TEST mode (validation only)\"\n            check_prerequisites\n            validate_xml_syntax || exit 1\n            validate_rule_syntax || exit 1\n            success \"All validation tests passed!\"\n            info \"Run with --deploy to deploy these rules\"\n            ;;\n\n        --deploy)\n            info \"Running in DEPLOY mode\"\n            check_prerequisites\n            validate_xml_syntax || exit 1\n            validate_rule_syntax || exit 1\n            backup_existing_rules\n            deploy_rules\n\n            if restart_wazuh; then\n                verify_deployment\n                display_summary\n            else\n                error \"Deployment failed. Rolling back...\"\n                rollback\n                exit 1\n            fi\n            ;;\n\n        --rollback)\n            info \"Running in ROLLBACK mode\"\n            check_prerequisites\n            rollback\n            success \"Rollback completed\"\n            ;;\n\n        *)\n            error \"Invalid option: ${mode}\"\n            echo \"Usage: $0 [--test|--deploy|--rollback]\"\n            echo \"\"\n            echo \"Options:\"\n            echo \"  --test      Validate rules without deploying\"\n            echo \"  --deploy    Deploy rules to Wazuh manager (default)\"\n            echo \"  --rollback  Restore previous ruleset\"\n            exit 1\n            ;;\n    esac\n}\n\n# Trap errors\ntrap 'error \"Script failed at line $LINENO\"' ERR\n\n# Execute main function\nmain \"$@\"\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":48027,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":48027,"ephemeral_1h_input_tokens":0},"output_tokens":3683,"service_tier":"standard"}},"requestId":"req_011CVXtxKYxvy42n2z6RwciP","type":"assistant","uuid":"f0cd69d9-57db-4231-9474-da6cf4c9e63f","timestamp":"2025-11-27T06:10:49.188Z"}
{"parentUuid":"f0cd69d9-57db-4231-9474-da6cf4c9e63f","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PnUbkZ2SRCYMEBx9sZ65C9","type":"tool_result","content":"File created successfully at: /home/stanner/deploy_wazuh_rules.sh"}]},"uuid":"22a3f0b4-5c00-4e91-ac8e-5a0954717b27","timestamp":"2025-11-27T06:11:14.664Z","toolUseResult":{"type":"create","filePath":"/home/stanner/deploy_wazuh_rules.sh","content":"#!/bin/bash\n################################################################################\n# Wazuh Malware Detection Rules Deployment Script\n# Version: 1.0\n# Date: 2025-11-27\n#\n# Description: Automated deployment and validation of custom Wazuh detection\n#              rules for malware threats (Mirai, RondoDox, ransomware, EDR\n#              killers, credential theft, SharePoint CVE)\n#\n# Usage: ./deploy_wazuh_rules.sh [--test|--deploy|--rollback]\n#\n# Options:\n#   --test      Validate rules without deploying\n#   --deploy    Deploy rules to Wazuh manager\n#   --rollback  Restore previous ruleset\n#\n################################################################################\n\nset -euo pipefail\n\n# Color codes for output\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m' # No Color\n\n# Configuration\nWAZUH_INSTALL_DIR=\"/var/ossec\"\nRULES_DIR=\"${WAZUH_INSTALL_DIR}/etc/rules\"\nCUSTOM_RULES_FILE=\"${RULES_DIR}/local_rules.xml\"\nBACKUP_DIR=\"/var/ossec/backups\"\nDEPLOYMENT_RULES=\"wazuh_malware_detection_rules.xml\"\nTIMESTAMP=$(date +%Y%m%d_%H%M%S)\n\n# Logging\nLOG_FILE=\"/var/log/wazuh_rule_deployment_${TIMESTAMP}.log\"\n\n################################################################################\n# Functions\n################################################################################\n\nlog() {\n    local level=$1\n    shift\n    local message=\"$*\"\n    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')\n    echo -e \"${timestamp} [${level}] ${message}\" | tee -a \"${LOG_FILE}\"\n}\n\ninfo() {\n    log \"INFO\" \"${BLUE}$*${NC}\"\n}\n\nsuccess() {\n    log \"SUCCESS\" \"${GREEN}$*${NC}\"\n}\n\nwarning() {\n    log \"WARNING\" \"${YELLOW}$*${NC}\"\n}\n\nerror() {\n    log \"ERROR\" \"${RED}$*${NC}\"\n}\n\ncheck_prerequisites() {\n    info \"Checking prerequisites...\"\n\n    # Check if running as root\n    if [[ $EUID -ne 0 ]]; then\n        error \"This script must be run as root\"\n        exit 1\n    fi\n\n    # Check if Wazuh is installed\n    if [[ ! -d \"${WAZUH_INSTALL_DIR}\" ]]; then\n        error \"Wazuh installation not found at ${WAZUH_INSTALL_DIR}\"\n        exit 1\n    fi\n\n    # Check if Wazuh manager is running\n    if ! systemctl is-active --quiet wazuh-manager; then\n        error \"Wazuh manager is not running\"\n        exit 1\n    fi\n\n    # Check if deployment rules file exists\n    if [[ ! -f \"${DEPLOYMENT_RULES}\" ]]; then\n        error \"Deployment rules file not found: ${DEPLOYMENT_RULES}\"\n        error \"Please ensure wazuh_malware_detection_rules.xml is in the current directory\"\n        exit 1\n    fi\n\n    # Create backup directory if it doesn't exist\n    mkdir -p \"${BACKUP_DIR}\"\n\n    success \"Prerequisites check passed\"\n}\n\nvalidate_xml_syntax() {\n    info \"Validating XML syntax of new rules...\"\n\n    if ! command -v xmllint &> /dev/null; then\n        warning \"xmllint not found. Installing libxml2-utils...\"\n        apt-get update -qq && apt-get install -y -qq libxml2-utils\n    fi\n\n    if xmllint --noout \"${DEPLOYMENT_RULES}\" 2>&1 | tee -a \"${LOG_FILE}\"; then\n        success \"XML syntax validation passed\"\n        return 0\n    else\n        error \"XML syntax validation failed\"\n        return 1\n    fi\n}\n\nvalidate_rule_syntax() {\n    info \"Validating Wazuh rule syntax...\"\n\n    # Create temporary rules file for testing\n    local temp_rules=\"${RULES_DIR}/test_rules_${TIMESTAMP}.xml\"\n    cp \"${DEPLOYMENT_RULES}\" \"${temp_rules}\"\n\n    # Test configuration with new rules\n    if ${WAZUH_INSTALL_DIR}/bin/wazuh-logtest -c \"${WAZUH_INSTALL_DIR}/etc/ossec.conf\" -d \"${RULES_DIR}\" > /dev/null 2>&1; then\n        success \"Wazuh rule syntax validation passed\"\n        rm -f \"${temp_rules}\"\n        return 0\n    else\n        error \"Wazuh rule syntax validation failed\"\n        error \"Check log file for details: ${LOG_FILE}\"\n        rm -f \"${temp_rules}\"\n        return 1\n    fi\n}\n\nbackup_existing_rules() {\n    info \"Backing up existing rules...\"\n\n    local backup_file=\"${BACKUP_DIR}/local_rules_${TIMESTAMP}.xml\"\n\n    if [[ -f \"${CUSTOM_RULES_FILE}\" ]]; then\n        cp \"${CUSTOM_RULES_FILE}\" \"${backup_file}\"\n        success \"Existing rules backed up to: ${backup_file}\"\n        echo \"${backup_file}\" > \"${BACKUP_DIR}/last_backup.txt\"\n    else\n        warning \"No existing custom rules found. Creating new file.\"\n    fi\n}\n\ndeploy_rules() {\n    info \"Deploying new rules to Wazuh manager...\"\n\n    # Check if we should merge or replace\n    if [[ -f \"${CUSTOM_RULES_FILE}\" ]]; then\n        warning \"Existing local_rules.xml found.\"\n        read -p \"Merge with existing rules? (y/n): \" -n 1 -r\n        echo\n        if [[ $REPLY =~ ^[Yy]$ ]]; then\n            merge_rules\n        else\n            replace_rules\n        fi\n    else\n        replace_rules\n    fi\n\n    success \"Rules deployed successfully\"\n}\n\nmerge_rules() {\n    info \"Merging new rules with existing rules...\"\n\n    # Create merged rules file\n    local merged_rules=\"${BACKUP_DIR}/merged_rules_${TIMESTAMP}.xml\"\n\n    # Extract existing rules (everything between <group> tags)\n    sed -n '/<group name=/,/<\\/group>/p' \"${CUSTOM_RULES_FILE}\" > \"${merged_rules}.tmp\"\n\n    # Extract new rules (everything between <group> tags)\n    sed -n '/<group name=/,/<\\/group>/p' \"${DEPLOYMENT_RULES}\" >> \"${merged_rules}.tmp\"\n\n    # Create proper XML structure\n    cat > \"${merged_rules}\" << 'EOF'\n<!--\n  Wazuh Custom Rules - Merged Configuration\n  Auto-generated on: TIMESTAMP\n-->\n<group name=\"local,custom,\">\nEOF\n\n    # Add merged content (excluding duplicate <group> tags)\n    grep -v '<group name=' \"${merged_rules}.tmp\" | grep -v '</group>' >> \"${merged_rules}\"\n\n    # Close group tag\n    echo \"</group>\" >> \"${merged_rules}\"\n\n    # Replace timestamp placeholder\n    sed -i \"s/TIMESTAMP/$(date)/\" \"${merged_rules}\"\n\n    # Copy merged rules to production\n    cp \"${merged_rules}\" \"${CUSTOM_RULES_FILE}\"\n\n    # Cleanup\n    rm -f \"${merged_rules}.tmp\"\n\n    success \"Rules merged successfully\"\n}\n\nreplace_rules() {\n    info \"Replacing existing rules with new ruleset...\"\n\n    # Copy new rules to production\n    cp \"${DEPLOYMENT_RULES}\" \"${CUSTOM_RULES_FILE}\"\n\n    # Set proper ownership and permissions\n    chown root:wazuh \"${CUSTOM_RULES_FILE}\"\n    chmod 640 \"${CUSTOM_RULES_FILE}\"\n\n    success \"Rules replaced successfully\"\n}\n\nrestart_wazuh() {\n    info \"Restarting Wazuh manager to apply new rules...\"\n\n    if systemctl restart wazuh-manager; then\n        sleep 5\n        if systemctl is-active --quiet wazuh-manager; then\n            success \"Wazuh manager restarted successfully\"\n            return 0\n        else\n            error \"Wazuh manager failed to start after restart\"\n            return 1\n        fi\n    else\n        error \"Failed to restart Wazuh manager\"\n        return 1\n    fi\n}\n\nverify_deployment() {\n    info \"Verifying rule deployment...\"\n\n    # Check if rules are loaded\n    local rule_count=$(grep -c '<rule id=\"100[0-9][0-9][0-9]\"' \"${CUSTOM_RULES_FILE}\" || true)\n\n    if [[ ${rule_count} -gt 0 ]]; then\n        success \"Verified ${rule_count} custom rules loaded\"\n    else\n        error \"No custom rules found in deployed file\"\n        return 1\n    fi\n\n    # Test a sample rule\n    info \"Testing rule 100000 (Mirai hash detection)...\"\n    echo '<13>Nov 27 10:00:00 test syscheck: alert_new_file: /tmp/malware.elf SHA256=b6873744cfb1b2bc92f49ca61975afb7b8c491ccf41111ded5bc63575bba59d5' | \\\n        ${WAZUH_INSTALL_DIR}/bin/wazuh-logtest -q 2>&1 | tee -a \"${LOG_FILE}\"\n\n    success \"Deployment verification completed\"\n}\n\nrollback() {\n    info \"Rolling back to previous ruleset...\"\n\n    local last_backup=\"${BACKUP_DIR}/last_backup.txt\"\n\n    if [[ ! -f \"${last_backup}\" ]]; then\n        error \"No backup found to rollback to\"\n        exit 1\n    fi\n\n    local backup_file=$(cat \"${last_backup}\")\n\n    if [[ ! -f \"${backup_file}\" ]]; then\n        error \"Backup file not found: ${backup_file}\"\n        exit 1\n    fi\n\n    info \"Restoring from: ${backup_file}\"\n    cp \"${backup_file}\" \"${CUSTOM_RULES_FILE}\"\n\n    if restart_wazuh; then\n        success \"Rollback completed successfully\"\n    else\n        error \"Rollback completed but Wazuh manager failed to start\"\n        error \"Manual intervention required\"\n        exit 1\n    fi\n}\n\ndisplay_summary() {\n    cat << EOF\n\n${GREEN}\n          Wazuh Malware Detection Rules Deployment Summary         \n${NC}\n\n${BLUE}Deployment Details:${NC}\n  - Timestamp: ${TIMESTAMP}\n  - Rules File: ${CUSTOM_RULES_FILE}\n  - Backup Location: ${BACKUP_DIR}\n  - Log File: ${LOG_FILE}\n\n${BLUE}Rule Categories Deployed:${NC}\n   File Hash Detection (Rules 100000-100002)\n   Mirai/UPX-Packed ELF Detection (Rules 100010-100013)\n   Botnet Activity Detection (Rules 100020-100024)\n   EDR Killer Detection (Rules 100030-100034)\n   Credential Theft Detection (Rules 100040-100045)\n   Ransomware Behavior Detection (Rules 100050-100055)\n   SharePoint Exploitation Detection (Rules 100060-100066)\n   Composite/Correlation Rules (Rules 100070-100072)\n\n${YELLOW}Next Steps:${NC}\n  1. Review alerts in Wazuh dashboard\n  2. Tune frequency thresholds based on environment\n  3. Configure whitelists for false positives\n  4. Enable required log sources (Sysmon, auditd, IIS)\n  5. Test incident response playbooks\n\n${YELLOW}Documentation:${NC}\n  - Full documentation: wazuh_rules_documentation.md\n  - Deployment log: ${LOG_FILE}\n\n${GREEN}Deployment completed successfully!${NC}\n\nEOF\n}\n\n################################################################################\n# Main execution\n################################################################################\n\nmain() {\n    local mode=\"${1:---deploy}\"\n\n    echo -e \"${BLUE}\"\n    cat << 'EOF'\n\n                                                                   \n   Wazuh Malware Detection Rules Deployment Script                \n   Version 1.0 - November 27, 2025                                \n                                                                   \n\nEOF\n    echo -e \"${NC}\"\n\n    case \"${mode}\" in\n        --test)\n            info \"Running in TEST mode (validation only)\"\n            check_prerequisites\n            validate_xml_syntax || exit 1\n            validate_rule_syntax || exit 1\n            success \"All validation tests passed!\"\n            info \"Run with --deploy to deploy these rules\"\n            ;;\n\n        --deploy)\n            info \"Running in DEPLOY mode\"\n            check_prerequisites\n            validate_xml_syntax || exit 1\n            validate_rule_syntax || exit 1\n            backup_existing_rules\n            deploy_rules\n\n            if restart_wazuh; then\n                verify_deployment\n                display_summary\n            else\n                error \"Deployment failed. Rolling back...\"\n                rollback\n                exit 1\n            fi\n            ;;\n\n        --rollback)\n            info \"Running in ROLLBACK mode\"\n            check_prerequisites\n            rollback\n            success \"Rollback completed\"\n            ;;\n\n        *)\n            error \"Invalid option: ${mode}\"\n            echo \"Usage: $0 [--test|--deploy|--rollback]\"\n            echo \"\"\n            echo \"Options:\"\n            echo \"  --test      Validate rules without deploying\"\n            echo \"  --deploy    Deploy rules to Wazuh manager (default)\"\n            echo \"  --rollback  Restore previous ruleset\"\n            exit 1\n            ;;\n    esac\n}\n\n# Trap errors\ntrap 'error \"Script failed at line $LINENO\"' ERR\n\n# Execute main function\nmain \"$@\"\n","structuredPatch":[],"originalFile":null}}
{"parentUuid":"22a3f0b4-5c00-4e91-ac8e-5a0954717b27","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Mp5sgJFqiqQ4xkZzDpqcMs","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create testing scenarios and a validation suite:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":3627,"cache_read_input_tokens":48027,"cache_creation":{"ephemeral_5m_input_tokens":3627,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CVXu47c3kZsFydH1gAErc","type":"assistant","uuid":"66d2a24e-a938-41bd-ab56-651abe8998c9","timestamp":"2025-11-27T06:11:18.946Z"}
{"parentUuid":"66d2a24e-a938-41bd-ab56-651abe8998c9","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Mp5sgJFqiqQ4xkZzDpqcMs","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PCNyayfjtZpphjhh8gUDeQ","name":"Write","input":{"file_path":"/home/stanner/test_rule_scenarios.sh","content":"#!/bin/bash\n################################################################################\n# Wazuh Rule Testing Suite\n# Version: 1.0\n# Date: 2025-11-27\n#\n# Description: Generates test log events to validate Wazuh detection rules\n#              for malware threats. Tests all rule categories without causing\n#              actual harm to systems.\n#\n# Usage: ./test_rule_scenarios.sh [--rule-id RULEID] [--all]\n#\n# WARNING: Run only in controlled test environments\n#\n################################################################################\n\nset -euo pipefail\n\n# Configuration\nWAZUH_LOGTEST=\"/var/ossec/bin/wazuh-logtest\"\nTEST_RESULTS_FILE=\"test_results_$(date +%Y%m%d_%H%M%S).txt\"\n\n# Color codes\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m'\n\n################################################################################\n# Test helper functions\n################################################################################\n\ntest_rule() {\n    local rule_id=$1\n    local test_name=$2\n    local log_entry=$3\n\n    echo -e \"\\n${BLUE}${NC}\"\n    echo -e \"${YELLOW}Testing Rule ${rule_id}: ${test_name}${NC}\"\n    echo -e \"${BLUE}${NC}\"\n\n    echo -e \"\\n${BLUE}Test Log Entry:${NC}\"\n    echo \"${log_entry}\"\n\n    echo -e \"\\n${BLUE}Wazuh Analysis:${NC}\"\n\n    # Run wazuh-logtest\n    result=$(echo \"${log_entry}\" | ${WAZUH_LOGTEST} -q 2>&1 || true)\n    echo \"${result}\"\n\n    # Check if rule triggered\n    if echo \"${result}\" | grep -q \"Rule id: '${rule_id}'\"; then\n        echo -e \"\\n${GREEN} PASS: Rule ${rule_id} triggered correctly${NC}\"\n        echo \"PASS: Rule ${rule_id} - ${test_name}\" >> \"${TEST_RESULTS_FILE}\"\n        return 0\n    else\n        echo -e \"\\n${RED} FAIL: Rule ${rule_id} did not trigger${NC}\"\n        echo \"FAIL: Rule ${rule_id} - ${test_name}\" >> \"${TEST_RESULTS_FILE}\"\n        return 1\n    fi\n}\n\n################################################################################\n# Test scenarios by category\n################################################################################\n\ntest_file_hash_detection() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 1: File Hash Detection (Rules 100000-100002)          ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    # Test 100000: Mirai hash\n    test_rule \"100000\" \"Mirai Botnet Hash Detection\" \\\n        \"2025 Nov 27 10:00:00 test-host syscheck: alert_new_file: /tmp/suspicious.elf SHA256=b6873744cfb1b2bc92f49ca61975afb7b8c491ccf41111ded5bc63575bba59d5\"\n\n    # Test 100001: ARM malware hash\n    test_rule \"100001\" \"ARM Malware Hash Detection\" \\\n        \"2025 Nov 27 10:01:00 test-host syscheck: alert_new_file: /dev/shm/malware SHA256=7e5fbce9bce17de629ccfc1f8cc40ff780c8be1b0efd42f726e2bc469923fbdf\"\n\n    # Test 100002: RondoDox hash\n    test_rule \"100002\" \"RondoDox Botnet Hash Detection\" \\\n        \"2025 Nov 27 10:02:00 test-host syscheck: alert_new_file: /var/tmp/scanner SHA256=5c2bbb00f32b9b196fe1ca35263516a7ebf9fb64ab29b3c85cc320618a6cc6c9\"\n}\n\ntest_mirai_upx_detection() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 2: Mirai/UPX Detection (Rules 100010-100013)          ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    # Test 100010: UPX-packed ELF\n    test_rule \"100010\" \"UPX-Packed ELF Detection\" \\\n        \"2025 Nov 27 10:10:00 test-host syscheck: alert_modified: /home/user/test ELF 64-bit LSB executable UPX compressed\"\n\n    # Test 100011: UPX in suspicious directory\n    test_rule \"100011\" \"UPX in /tmp Directory\" \\\n        \"2025 Nov 27 10:11:00 test-host syscheck: alert_new_file: /tmp/binary ELF 32-bit LSB executable upx packed\"\n\n    # Test 100012: Random-named ELF execution\n    test_rule \"100012\" \"Random-Named ELF Execution\" \\\n        \"2025 Nov 27 10:12:00 test-host auditd: type=EXECVE msg=audit(1732705920.123:456): argc=1 a0=\\\"./xBj7k.elf\\\"\"\n\n    # Test 100013: IPv6 socket by suspicious binary\n    test_rule \"100013\" \"Suspicious IPv6 Socket Creation\" \\\n        \"2025 Nov 27 10:13:00 test-host auditd: type=SYSCALL msg=audit(1732705920.456:789): syscall=socket proto=inet6 exe=\\\"/tmp/suspicious\\\"\"\n}\n\ntest_botnet_activity() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 3: Botnet Activity (Rules 100020-100024)              ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    echo -e \"\\n${YELLOW}Note: Frequency-based rules (100020-100024) require multiple events${NC}\"\n    echo -e \"${YELLOW}These tests demonstrate single event format. Actual triggering requires${NC}\"\n    echo -e \"${YELLOW}threshold count within timeframe.${NC}\"\n\n    # Test 100020: Mass connections (single event format)\n    test_rule \"100020\" \"Mass Network Connection Pattern\" \\\n        \"2025 Nov 27 10:20:00 test-host kernel: NEW_CONN: SYN_SENT src=192.168.1.100 dst=1.2.3.4\"\n\n    # Test 100021: Brute force on common ports\n    test_rule \"100021\" \"Brute Force Common Ports\" \\\n        \"2025 Nov 27 10:21:00 test-host kernel: NEW_CONN: SYN_SENT src=192.168.1.100 dst=1.2.3.4:22\"\n\n    # Test 100023: Process enumeration\n    test_rule \"100023\" \"Process Enumeration Activity\" \\\n        \"2025 Nov 27 10:23:00 test-host auditd: type=EXECVE msg=audit(1732706580.123:456): argc=2 a0=\\\"ps\\\" a1=\\\"-ef\\\"\"\n}\n\ntest_edr_killer() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 4: EDR Killer Detection (Rules 100030-100034)         ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    # Test 100030: Random driver name\n    test_rule \"100030\" \"Random 5-Character Driver Load\" \\\n        \"2025 Nov 27 10:30:00 test-host Microsoft-Windows-Sysmon/Operational: DriverLoad: ImageLoaded=C:\\\\Windows\\\\System32\\\\drivers\\\\xYz12.sys\"\n\n    # Test 100032: EDR service termination\n    test_rule \"100032\" \"EDR Service Termination\" \\\n        \"2025 Nov 27 10:32:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessCreate: CommandLine=sc.exe stop MsMpEng\"\n\n    # Test 100033: Known vulnerable driver\n    test_rule \"100033\" \"Known Vulnerable Driver (RTCore64)\" \\\n        \"2025 Nov 27 10:33:00 test-host Microsoft-Windows-Sysmon/Operational: DriverLoad: ImageLoaded=C:\\\\Temp\\\\RTCore64.sys\"\n\n    # Test 100034: Kernel driver service creation\n    test_rule \"100034\" \"Kernel Driver Service Creation\" \\\n        \"2025 Nov 27 10:34:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessCreate: CommandLine=sc.exe create maldriver type= kernel binPath= C:\\\\temp\\\\driver.sys\"\n}\n\ntest_credential_theft() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 5: Credential Theft (Rules 100040-100045)             ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    # Test 100040: Process accessing browser memory\n    test_rule \"100040\" \"Suspicious Browser Memory Access\" \\\n        \"2025 Nov 27 10:40:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessAccess: SourceImage=C:\\\\Temp\\\\stealer.exe TargetImage=C:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\"\n\n    # Test 100041: Unauthorized credential file access\n    test_rule \"100041\" \"Browser Credential Database Access\" \\\n        \"2025 Nov 27 10:41:00 test-host syscheck: alert_modified: C:\\\\Users\\\\user\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\User Data\\\\Default\\\\Login Data modified by: malware.exe\"\n\n    # Test 100042: Windows Vault access\n    test_rule \"100042\" \"Windows Vault Access\" \\\n        \"2025 Nov 27 10:42:00 test-host syscheck: alert_read: C:\\\\Users\\\\user\\\\AppData\\\\Local\\\\Microsoft\\\\Vault\\\\VaultPasswordV1.dat accessed by: stealer.exe\"\n\n    # Test 100043: Credential enumeration command\n    test_rule \"100043\" \"Credential Enumeration Command\" \\\n        \"2025 Nov 27 10:43:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessCreate: CommandLine=cmdkey /list\"\n\n    # Test 100044: Credential dump file creation\n    test_rule \"100044\" \"Credential Dump File Staging\" \\\n        \"2025 Nov 27 10:44:00 test-host syscheck: alert_new_file: C:\\\\Users\\\\Public\\\\passwords.txt\"\n\n    # Test 100045: Linux browser credential access\n    test_rule \"100045\" \"Linux Browser Credential Access\" \\\n        \"2025 Nov 27 10:45:00 test-host auditd: type=SYSCALL msg=audit(1732707900.123:456): syscall=openat file=/home/user/.mozilla/firefox/profiles/default/logins.json\"\n}\n\ntest_ransomware() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 6: Ransomware Detection (Rules 100050-100055)         ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    # Test 100050: File encryption (single event, requires frequency)\n    test_rule \"100050\" \"Encrypted File Extension\" \\\n        \"2025 Nov 27 10:50:00 test-host syscheck: alert_new_file: C:\\\\Users\\\\user\\\\Documents\\\\report.docx.encrypted\"\n\n    # Test 100051: Ransom note creation\n    test_rule \"100051\" \"Ransom Note Creation\" \\\n        \"2025 Nov 27 10:51:00 test-host syscheck: alert_new_file: C:\\\\Users\\\\user\\\\Desktop\\\\READ_ME.txt\"\n\n    # Test 100052: Shadow copy deletion\n    test_rule \"100052\" \"Shadow Copy Deletion\" \\\n        \"2025 Nov 27 10:52:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessCreate: CommandLine=vssadmin.exe delete shadows /all /quiet\"\n\n    # Test 100053: Secure file deletion\n    test_rule \"100053\" \"Secure File Deletion Tool\" \\\n        \"2025 Nov 27 10:53:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessCreate: CommandLine=cipher.exe /w:C:\\\\Temp\"\n\n    # Test 100055: Service termination preparation\n    test_rule \"100055\" \"Critical Service Termination\" \\\n        \"2025 Nov 27 10:55:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessCreate: CommandLine=net.exe stop SQL Server (MSSQLSERVER)\"\n}\n\ntest_sharepoint_exploitation() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 7: SharePoint Exploitation (Rules 100060-100066)      ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    # Test 100060: Unauthenticated _vti_bin access\n    test_rule \"100060\" \"Unauthenticated SharePoint Endpoint Access\" \\\n        \"2025 Nov 27 10:60:00 sharepoint-server IIS: 1.2.3.4 - - [27/Nov/2025:10:00:00 +0000] \\\"GET /_vti_bin/spdisco.aspx HTTP/1.1\\\" 200 1234 \\\"-\\\" \\\"Mozilla/5.0\\\"\"\n\n    # Test 100061: Forged Referer header\n    test_rule \"100061\" \"SharePoint Forged Referer Attack\" \\\n        \"2025 Nov 27 10:61:00 sharepoint-server IIS: 1.2.3.4 - - [27/Nov/2025:10:00:00 +0000] \\\"POST /_vti_bin/Lists.asmx HTTP/1.1\\\" 200 5678 \\\"https://sharepoint.com\\\" \\\"Mozilla/5.0\\\"\"\n\n    # Test 100062: Deserialization error\n    test_rule \"100062\" \"SharePoint Deserialization Error\" \\\n        \"2025 Nov 27 10:62:00 sharepoint-server SharePoint: Exception: SerializationException at /_vti_bin/Lists.asmx - BinaryFormatter deserialization failed\"\n\n    # Test 100064: Command execution in request\n    test_rule \"100064\" \"SharePoint RCE Command Execution\" \\\n        \"2025 Nov 27 10:64:00 sharepoint-server IIS: 1.2.3.4 - - [27/Nov/2025:10:00:00 +0000] \\\"POST /_vti_bin/spdisco.aspx?cmd=powershell.exe HTTP/1.1\\\" 200 1234 \\\"-\\\" \\\"Mozilla/5.0\\\"\"\n\n    # Test 100065: SOAP endpoint exploitation\n    test_rule \"100065\" \"SharePoint SOAP Endpoint Attack\" \\\n        \"2025 Nov 27 10:65:00 sharepoint-server IIS: 1.2.3.4 - - [27/Nov/2025:10:00:00 +0000] \\\"POST /_vti_bin/SharePointProjectService.svc HTTP/1.1\\\" 200 2345 \\\"-\\\" \\\"Mozilla/5.0\\\" Content-Type: text/xml\"\n\n    # Test 100066: Oversized ViewState\n    test_rule \"100066\" \"SharePoint Large ViewState Payload\" \\\n        \"2025 Nov 27 10:66:00 sharepoint-server IIS: 1.2.3.4 - - [27/Nov/2025:10:00:00 +0000] \\\"POST /_layouts/15/start.aspx HTTP/1.1\\\" 200 15000 \\\"-\\\" \\\"Mozilla/5.0\\\" __VIEWSTATE=YTAwMDAwMDA...\"\n}\n\n################################################################################\n# Main execution\n################################################################################\n\nmain() {\n    echo -e \"${BLUE}\"\n    cat << 'EOF'\n\n                                                                   \n         Wazuh Malware Detection Rules - Test Suite               \n         Version 1.0 - November 27, 2025                          \n                                                                   \n\nEOF\n    echo -e \"${NC}\"\n\n    # Check if wazuh-logtest exists\n    if [[ ! -x \"${WAZUH_LOGTEST}\" ]]; then\n        echo -e \"${RED}Error: wazuh-logtest not found at ${WAZUH_LOGTEST}${NC}\"\n        echo -e \"${YELLOW}Please ensure Wazuh is installed and WAZUH_LOGTEST path is correct${NC}\"\n        exit 1\n    fi\n\n    # Initialize results file\n    echo \"Wazuh Rule Test Results - $(date)\" > \"${TEST_RESULTS_FILE}\"\n    echo \"\" >> \"${TEST_RESULTS_FILE}\"\n\n    # Run all test categories\n    test_file_hash_detection\n    test_mirai_upx_detection\n    test_botnet_activity\n    test_edr_killer\n    test_credential_theft\n    test_ransomware\n    test_sharepoint_exploitation\n\n    # Display summary\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}                      Test Summary                                 ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    local total_tests=$(grep -c \":\" \"${TEST_RESULTS_FILE}\" || echo \"0\")\n    local passed_tests=$(grep -c \"^PASS\" \"${TEST_RESULTS_FILE}\" || echo \"0\")\n    local failed_tests=$(grep -c \"^FAIL\" \"${TEST_RESULTS_FILE}\" || echo \"0\")\n\n    echo -e \"\\n${BLUE}Total Tests Run:${NC} ${total_tests}\"\n    echo -e \"${GREEN}Tests Passed:${NC} ${passed_tests}\"\n    echo -e \"${RED}Tests Failed:${NC} ${failed_tests}\"\n\n    if [[ ${failed_tests} -eq 0 ]]; then\n        echo -e \"\\n${GREEN} All tests passed successfully!${NC}\"\n    else\n        echo -e \"\\n${YELLOW} Some tests failed. Review results in: ${TEST_RESULTS_FILE}${NC}\"\n    fi\n\n    echo -e \"\\n${BLUE}Detailed results saved to: ${TEST_RESULTS_FILE}${NC}\"\n}\n\nmain \"$@\"\n"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":3627,"cache_read_input_tokens":48027,"cache_creation":{"ephemeral_5m_input_tokens":3627,"ephemeral_1h_input_tokens":0},"output_tokens":5425,"service_tier":"standard"},"context_management":{"applied_edits":[]}},"requestId":"req_011CVXu47c3kZsFydH1gAErc","type":"assistant","uuid":"653eac75-25d1-45c9-a9bf-d9e20bdfa4ac","timestamp":"2025-11-27T06:12:32.093Z"}
{"parentUuid":"653eac75-25d1-45c9-a9bf-d9e20bdfa4ac","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PCNyayfjtZpphjhh8gUDeQ","type":"tool_result","content":"File created successfully at: /home/stanner/test_rule_scenarios.sh"}]},"uuid":"1eab92f3-19cf-4439-a268-682fd517fc26","timestamp":"2025-11-27T06:12:32.131Z","toolUseResult":{"type":"create","filePath":"/home/stanner/test_rule_scenarios.sh","content":"#!/bin/bash\n################################################################################\n# Wazuh Rule Testing Suite\n# Version: 1.0\n# Date: 2025-11-27\n#\n# Description: Generates test log events to validate Wazuh detection rules\n#              for malware threats. Tests all rule categories without causing\n#              actual harm to systems.\n#\n# Usage: ./test_rule_scenarios.sh [--rule-id RULEID] [--all]\n#\n# WARNING: Run only in controlled test environments\n#\n################################################################################\n\nset -euo pipefail\n\n# Configuration\nWAZUH_LOGTEST=\"/var/ossec/bin/wazuh-logtest\"\nTEST_RESULTS_FILE=\"test_results_$(date +%Y%m%d_%H%M%S).txt\"\n\n# Color codes\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m'\n\n################################################################################\n# Test helper functions\n################################################################################\n\ntest_rule() {\n    local rule_id=$1\n    local test_name=$2\n    local log_entry=$3\n\n    echo -e \"\\n${BLUE}${NC}\"\n    echo -e \"${YELLOW}Testing Rule ${rule_id}: ${test_name}${NC}\"\n    echo -e \"${BLUE}${NC}\"\n\n    echo -e \"\\n${BLUE}Test Log Entry:${NC}\"\n    echo \"${log_entry}\"\n\n    echo -e \"\\n${BLUE}Wazuh Analysis:${NC}\"\n\n    # Run wazuh-logtest\n    result=$(echo \"${log_entry}\" | ${WAZUH_LOGTEST} -q 2>&1 || true)\n    echo \"${result}\"\n\n    # Check if rule triggered\n    if echo \"${result}\" | grep -q \"Rule id: '${rule_id}'\"; then\n        echo -e \"\\n${GREEN} PASS: Rule ${rule_id} triggered correctly${NC}\"\n        echo \"PASS: Rule ${rule_id} - ${test_name}\" >> \"${TEST_RESULTS_FILE}\"\n        return 0\n    else\n        echo -e \"\\n${RED} FAIL: Rule ${rule_id} did not trigger${NC}\"\n        echo \"FAIL: Rule ${rule_id} - ${test_name}\" >> \"${TEST_RESULTS_FILE}\"\n        return 1\n    fi\n}\n\n################################################################################\n# Test scenarios by category\n################################################################################\n\ntest_file_hash_detection() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 1: File Hash Detection (Rules 100000-100002)          ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    # Test 100000: Mirai hash\n    test_rule \"100000\" \"Mirai Botnet Hash Detection\" \\\n        \"2025 Nov 27 10:00:00 test-host syscheck: alert_new_file: /tmp/suspicious.elf SHA256=b6873744cfb1b2bc92f49ca61975afb7b8c491ccf41111ded5bc63575bba59d5\"\n\n    # Test 100001: ARM malware hash\n    test_rule \"100001\" \"ARM Malware Hash Detection\" \\\n        \"2025 Nov 27 10:01:00 test-host syscheck: alert_new_file: /dev/shm/malware SHA256=7e5fbce9bce17de629ccfc1f8cc40ff780c8be1b0efd42f726e2bc469923fbdf\"\n\n    # Test 100002: RondoDox hash\n    test_rule \"100002\" \"RondoDox Botnet Hash Detection\" \\\n        \"2025 Nov 27 10:02:00 test-host syscheck: alert_new_file: /var/tmp/scanner SHA256=5c2bbb00f32b9b196fe1ca35263516a7ebf9fb64ab29b3c85cc320618a6cc6c9\"\n}\n\ntest_mirai_upx_detection() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 2: Mirai/UPX Detection (Rules 100010-100013)          ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    # Test 100010: UPX-packed ELF\n    test_rule \"100010\" \"UPX-Packed ELF Detection\" \\\n        \"2025 Nov 27 10:10:00 test-host syscheck: alert_modified: /home/user/test ELF 64-bit LSB executable UPX compressed\"\n\n    # Test 100011: UPX in suspicious directory\n    test_rule \"100011\" \"UPX in /tmp Directory\" \\\n        \"2025 Nov 27 10:11:00 test-host syscheck: alert_new_file: /tmp/binary ELF 32-bit LSB executable upx packed\"\n\n    # Test 100012: Random-named ELF execution\n    test_rule \"100012\" \"Random-Named ELF Execution\" \\\n        \"2025 Nov 27 10:12:00 test-host auditd: type=EXECVE msg=audit(1732705920.123:456): argc=1 a0=\\\"./xBj7k.elf\\\"\"\n\n    # Test 100013: IPv6 socket by suspicious binary\n    test_rule \"100013\" \"Suspicious IPv6 Socket Creation\" \\\n        \"2025 Nov 27 10:13:00 test-host auditd: type=SYSCALL msg=audit(1732705920.456:789): syscall=socket proto=inet6 exe=\\\"/tmp/suspicious\\\"\"\n}\n\ntest_botnet_activity() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 3: Botnet Activity (Rules 100020-100024)              ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    echo -e \"\\n${YELLOW}Note: Frequency-based rules (100020-100024) require multiple events${NC}\"\n    echo -e \"${YELLOW}These tests demonstrate single event format. Actual triggering requires${NC}\"\n    echo -e \"${YELLOW}threshold count within timeframe.${NC}\"\n\n    # Test 100020: Mass connections (single event format)\n    test_rule \"100020\" \"Mass Network Connection Pattern\" \\\n        \"2025 Nov 27 10:20:00 test-host kernel: NEW_CONN: SYN_SENT src=192.168.1.100 dst=1.2.3.4\"\n\n    # Test 100021: Brute force on common ports\n    test_rule \"100021\" \"Brute Force Common Ports\" \\\n        \"2025 Nov 27 10:21:00 test-host kernel: NEW_CONN: SYN_SENT src=192.168.1.100 dst=1.2.3.4:22\"\n\n    # Test 100023: Process enumeration\n    test_rule \"100023\" \"Process Enumeration Activity\" \\\n        \"2025 Nov 27 10:23:00 test-host auditd: type=EXECVE msg=audit(1732706580.123:456): argc=2 a0=\\\"ps\\\" a1=\\\"-ef\\\"\"\n}\n\ntest_edr_killer() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 4: EDR Killer Detection (Rules 100030-100034)         ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    # Test 100030: Random driver name\n    test_rule \"100030\" \"Random 5-Character Driver Load\" \\\n        \"2025 Nov 27 10:30:00 test-host Microsoft-Windows-Sysmon/Operational: DriverLoad: ImageLoaded=C:\\\\Windows\\\\System32\\\\drivers\\\\xYz12.sys\"\n\n    # Test 100032: EDR service termination\n    test_rule \"100032\" \"EDR Service Termination\" \\\n        \"2025 Nov 27 10:32:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessCreate: CommandLine=sc.exe stop MsMpEng\"\n\n    # Test 100033: Known vulnerable driver\n    test_rule \"100033\" \"Known Vulnerable Driver (RTCore64)\" \\\n        \"2025 Nov 27 10:33:00 test-host Microsoft-Windows-Sysmon/Operational: DriverLoad: ImageLoaded=C:\\\\Temp\\\\RTCore64.sys\"\n\n    # Test 100034: Kernel driver service creation\n    test_rule \"100034\" \"Kernel Driver Service Creation\" \\\n        \"2025 Nov 27 10:34:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessCreate: CommandLine=sc.exe create maldriver type= kernel binPath= C:\\\\temp\\\\driver.sys\"\n}\n\ntest_credential_theft() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 5: Credential Theft (Rules 100040-100045)             ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    # Test 100040: Process accessing browser memory\n    test_rule \"100040\" \"Suspicious Browser Memory Access\" \\\n        \"2025 Nov 27 10:40:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessAccess: SourceImage=C:\\\\Temp\\\\stealer.exe TargetImage=C:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\"\n\n    # Test 100041: Unauthorized credential file access\n    test_rule \"100041\" \"Browser Credential Database Access\" \\\n        \"2025 Nov 27 10:41:00 test-host syscheck: alert_modified: C:\\\\Users\\\\user\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\User Data\\\\Default\\\\Login Data modified by: malware.exe\"\n\n    # Test 100042: Windows Vault access\n    test_rule \"100042\" \"Windows Vault Access\" \\\n        \"2025 Nov 27 10:42:00 test-host syscheck: alert_read: C:\\\\Users\\\\user\\\\AppData\\\\Local\\\\Microsoft\\\\Vault\\\\VaultPasswordV1.dat accessed by: stealer.exe\"\n\n    # Test 100043: Credential enumeration command\n    test_rule \"100043\" \"Credential Enumeration Command\" \\\n        \"2025 Nov 27 10:43:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessCreate: CommandLine=cmdkey /list\"\n\n    # Test 100044: Credential dump file creation\n    test_rule \"100044\" \"Credential Dump File Staging\" \\\n        \"2025 Nov 27 10:44:00 test-host syscheck: alert_new_file: C:\\\\Users\\\\Public\\\\passwords.txt\"\n\n    # Test 100045: Linux browser credential access\n    test_rule \"100045\" \"Linux Browser Credential Access\" \\\n        \"2025 Nov 27 10:45:00 test-host auditd: type=SYSCALL msg=audit(1732707900.123:456): syscall=openat file=/home/user/.mozilla/firefox/profiles/default/logins.json\"\n}\n\ntest_ransomware() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 6: Ransomware Detection (Rules 100050-100055)         ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    # Test 100050: File encryption (single event, requires frequency)\n    test_rule \"100050\" \"Encrypted File Extension\" \\\n        \"2025 Nov 27 10:50:00 test-host syscheck: alert_new_file: C:\\\\Users\\\\user\\\\Documents\\\\report.docx.encrypted\"\n\n    # Test 100051: Ransom note creation\n    test_rule \"100051\" \"Ransom Note Creation\" \\\n        \"2025 Nov 27 10:51:00 test-host syscheck: alert_new_file: C:\\\\Users\\\\user\\\\Desktop\\\\READ_ME.txt\"\n\n    # Test 100052: Shadow copy deletion\n    test_rule \"100052\" \"Shadow Copy Deletion\" \\\n        \"2025 Nov 27 10:52:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessCreate: CommandLine=vssadmin.exe delete shadows /all /quiet\"\n\n    # Test 100053: Secure file deletion\n    test_rule \"100053\" \"Secure File Deletion Tool\" \\\n        \"2025 Nov 27 10:53:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessCreate: CommandLine=cipher.exe /w:C:\\\\Temp\"\n\n    # Test 100055: Service termination preparation\n    test_rule \"100055\" \"Critical Service Termination\" \\\n        \"2025 Nov 27 10:55:00 test-host Microsoft-Windows-Sysmon/Operational: ProcessCreate: CommandLine=net.exe stop SQL Server (MSSQLSERVER)\"\n}\n\ntest_sharepoint_exploitation() {\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}  CATEGORY 7: SharePoint Exploitation (Rules 100060-100066)      ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    # Test 100060: Unauthenticated _vti_bin access\n    test_rule \"100060\" \"Unauthenticated SharePoint Endpoint Access\" \\\n        \"2025 Nov 27 10:60:00 sharepoint-server IIS: 1.2.3.4 - - [27/Nov/2025:10:00:00 +0000] \\\"GET /_vti_bin/spdisco.aspx HTTP/1.1\\\" 200 1234 \\\"-\\\" \\\"Mozilla/5.0\\\"\"\n\n    # Test 100061: Forged Referer header\n    test_rule \"100061\" \"SharePoint Forged Referer Attack\" \\\n        \"2025 Nov 27 10:61:00 sharepoint-server IIS: 1.2.3.4 - - [27/Nov/2025:10:00:00 +0000] \\\"POST /_vti_bin/Lists.asmx HTTP/1.1\\\" 200 5678 \\\"https://sharepoint.com\\\" \\\"Mozilla/5.0\\\"\"\n\n    # Test 100062: Deserialization error\n    test_rule \"100062\" \"SharePoint Deserialization Error\" \\\n        \"2025 Nov 27 10:62:00 sharepoint-server SharePoint: Exception: SerializationException at /_vti_bin/Lists.asmx - BinaryFormatter deserialization failed\"\n\n    # Test 100064: Command execution in request\n    test_rule \"100064\" \"SharePoint RCE Command Execution\" \\\n        \"2025 Nov 27 10:64:00 sharepoint-server IIS: 1.2.3.4 - - [27/Nov/2025:10:00:00 +0000] \\\"POST /_vti_bin/spdisco.aspx?cmd=powershell.exe HTTP/1.1\\\" 200 1234 \\\"-\\\" \\\"Mozilla/5.0\\\"\"\n\n    # Test 100065: SOAP endpoint exploitation\n    test_rule \"100065\" \"SharePoint SOAP Endpoint Attack\" \\\n        \"2025 Nov 27 10:65:00 sharepoint-server IIS: 1.2.3.4 - - [27/Nov/2025:10:00:00 +0000] \\\"POST /_vti_bin/SharePointProjectService.svc HTTP/1.1\\\" 200 2345 \\\"-\\\" \\\"Mozilla/5.0\\\" Content-Type: text/xml\"\n\n    # Test 100066: Oversized ViewState\n    test_rule \"100066\" \"SharePoint Large ViewState Payload\" \\\n        \"2025 Nov 27 10:66:00 sharepoint-server IIS: 1.2.3.4 - - [27/Nov/2025:10:00:00 +0000] \\\"POST /_layouts/15/start.aspx HTTP/1.1\\\" 200 15000 \\\"-\\\" \\\"Mozilla/5.0\\\" __VIEWSTATE=YTAwMDAwMDA...\"\n}\n\n################################################################################\n# Main execution\n################################################################################\n\nmain() {\n    echo -e \"${BLUE}\"\n    cat << 'EOF'\n\n                                                                   \n         Wazuh Malware Detection Rules - Test Suite               \n         Version 1.0 - November 27, 2025                          \n                                                                   \n\nEOF\n    echo -e \"${NC}\"\n\n    # Check if wazuh-logtest exists\n    if [[ ! -x \"${WAZUH_LOGTEST}\" ]]; then\n        echo -e \"${RED}Error: wazuh-logtest not found at ${WAZUH_LOGTEST}${NC}\"\n        echo -e \"${YELLOW}Please ensure Wazuh is installed and WAZUH_LOGTEST path is correct${NC}\"\n        exit 1\n    fi\n\n    # Initialize results file\n    echo \"Wazuh Rule Test Results - $(date)\" > \"${TEST_RESULTS_FILE}\"\n    echo \"\" >> \"${TEST_RESULTS_FILE}\"\n\n    # Run all test categories\n    test_file_hash_detection\n    test_mirai_upx_detection\n    test_botnet_activity\n    test_edr_killer\n    test_credential_theft\n    test_ransomware\n    test_sharepoint_exploitation\n\n    # Display summary\n    echo -e \"\\n${GREEN}${NC}\"\n    echo -e \"${GREEN}                      Test Summary                                 ${NC}\"\n    echo -e \"${GREEN}${NC}\"\n\n    local total_tests=$(grep -c \":\" \"${TEST_RESULTS_FILE}\" || echo \"0\")\n    local passed_tests=$(grep -c \"^PASS\" \"${TEST_RESULTS_FILE}\" || echo \"0\")\n    local failed_tests=$(grep -c \"^FAIL\" \"${TEST_RESULTS_FILE}\" || echo \"0\")\n\n    echo -e \"\\n${BLUE}Total Tests Run:${NC} ${total_tests}\"\n    echo -e \"${GREEN}Tests Passed:${NC} ${passed_tests}\"\n    echo -e \"${RED}Tests Failed:${NC} ${failed_tests}\"\n\n    if [[ ${failed_tests} -eq 0 ]]; then\n        echo -e \"\\n${GREEN} All tests passed successfully!${NC}\"\n    else\n        echo -e \"\\n${YELLOW} Some tests failed. Review results in: ${TEST_RESULTS_FILE}${NC}\"\n    fi\n\n    echo -e \"\\n${BLUE}Detailed results saved to: ${TEST_RESULTS_FILE}${NC}\"\n}\n\nmain \"$@\"\n","structuredPatch":[],"originalFile":null}}
{"parentUuid":"1eab92f3-19cf-4439-a268-682fd517fc26","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_0141zLQWSvxFtUge9dXQc9Hi","type":"message","role":"assistant","content":[{"type":"text","text":"Finally, let me create a quick reference guide for SOC analysts:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":5469,"cache_read_input_tokens":51654,"cache_creation":{"ephemeral_5m_input_tokens":5469,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CVXu9nF8brX2NjKcbtV2u","type":"assistant","uuid":"7bef68b0-1ed4-4746-865f-838ddfa40158","timestamp":"2025-11-27T06:12:34.985Z"}
{"parentUuid":"7bef68b0-1ed4-4746-865f-838ddfa40158","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_0141zLQWSvxFtUge9dXQc9Hi","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RwWdG8jU6bpgBTQhe4vycR","name":"Write","input":{"file_path":"/home/stanner/soc_analyst_quick_reference.md","content":"# SOC Analyst Quick Reference Guide\n## Wazuh Malware Detection Rules - November 2025 Threats\n\n**Document Version:** 1.0\n**Last Updated:** 2025-11-27\n**Rule ID Range:** 100000-100099\n\n---\n\n## Alert Severity Levels & Response Times\n\n| Severity | Rule Level | Response SLA | Analyst Action |\n|----------|------------|--------------|----------------|\n| CRITICAL | 14-15 | 15 minutes | Immediate escalation + containment |\n| HIGH | 11-13 | 1 hour | Investigate + document + contain |\n| MEDIUM | 8-10 | 4 hours | Investigate + monitor |\n| LOW | 4-7 | 24 hours | Log + periodic review |\n\n---\n\n## Critical Rules - P0 Response Required\n\n### Rule 100051: Ransom Note Created (Level 14)\n```\nALERT: CRITICAL: Ransom note created - Ransomware attack confirmed\n```\n\n**What it means:** Active ransomware attack - files being encrypted RIGHT NOW\n\n**Immediate Actions (within 60 seconds):**\n1. DO NOT shut down the affected system\n2. ISOLATE from network immediately (pull cable or disable switch port)\n3. Alert on-call incident commander\n4. Preserve memory if safe: `dd if=/dev/mem of=/forensics/memory.raw`\n\n**Investigation:**\n- Check ransom note filename and contents for variant identification\n- Identify encryption scope: `find / -name \"*.encrypted\" -o -name \"*.locked\"`\n- Check network shares: are they encrypted too?\n\n**Next Steps:**\n- Activate ransomware playbook\n- Contact backup team to verify backup integrity\n- DO NOT pay ransom without executive approval\n\n---\n\n### Rule 100071: EDR Killer + Ransomware Chain (Level 15)\n```\nALERT: CRITICAL: EDR killer + ransomware attack chain detected\n```\n\n**What it means:** Multi-stage ransomware using BYOVD to disable security tools\n\n**Immediate Actions:**\n1. Network isolation (already late-stage attack)\n2. Check if EDR/AV can be restarted: `systemctl restart wazuh-agent`\n3. Memory capture for forensics\n4. Alert executive leadership\n\n**Investigation:**\n- Identify vulnerable driver loaded: Check Sysmon Event ID 6\n- Review which security services were terminated\n- Timeline reconstruction from first driver load to encryption start\n\n---\n\n### Rule 100064: SharePoint RCE Exploitation (Level 14)\n```\nALERT: CRITICAL: Command execution pattern in SharePoint request - RCE exploitation detected\n```\n\n**What it means:** Attacker executing commands on SharePoint server (CVE-2025-53770/53771)\n\n**Immediate Actions:**\n1. Block source IP at firewall: `iptables -A INPUT -s <ATTACKER_IP> -j DROP`\n2. Stop IIS: `iisreset /stop`\n3. Check for web shells: `dir C:\\inetpub\\wwwroot\\_vti_bin\\*.aspx /s /od`\n\n**Investigation:**\n- Review IIS logs: `C:\\inetpub\\logs\\LogFiles\\W3SVC1\\`\n- Check SharePoint ULS logs for deserialization errors\n- Search for recently created .aspx files\n- Review successful (HTTP 200) POST requests to `/_vti_bin/`\n\n**Next Steps:**\n- Apply emergency patches for CVE-2025-53770 and CVE-2025-53771\n- Restore SharePoint from last known-good backup if compromised\n- Force password reset for all SharePoint service accounts\n\n---\n\n### Rule 100070: Known Malware + Active Botnet (Level 15)\n```\nALERT: CRITICAL: Known malware hash detected with active botnet behavior\n```\n\n**What it means:** System infected with Mirai/RondoDox and actively attacking other systems\n\n**Immediate Actions:**\n1. Block all outbound traffic: `iptables -P OUTPUT DROP`\n2. Capture network traffic: `tcpdump -i eth0 -w /tmp/botnet.pcap`\n3. Kill malicious process: `kill -9 <PID>`\n\n**Investigation:**\n- Identify malware binary: `find /tmp /dev/shm /var/tmp -type f -executable`\n- Extract C2 servers: `netstat -antp | grep ESTABLISHED`\n- Check for persistence: `crontab -l`, `systemctl list-units`, `cat /etc/rc.local`\n\n**Next Steps:**\n- Remove malware binary and persistence mechanisms\n- Force password reset (credential brute force risk)\n- Patch exploited vulnerability\n- Consider full system rebuild\n\n---\n\n## High Priority Rules - P1 Response\n\n### Rule 100002: RondoDox Botnet Hash (Level 14)\n\n**Quick Check:**\n```bash\nsha256sum /tmp/* /dev/shm/* /var/tmp/* 2>/dev/null | grep 5c2bbb00f32b9b196fe1ca35263516a7ebf9fb64ab29b3c85cc320618a6cc6c9\n```\n\n**Indicators:**\n- Mass network scanning (44,000+ connections)\n- Brute force on ports 22, 23, 445, 3389, 5555\n- Process enumeration\n\n**Containment:**\n- Network isolation\n- Block C2 IPs at perimeter\n- Force password reset on all systems\n\n---\n\n### Rule 100031: BYOVD Driver Load + Service Termination (Level 14)\n\n**Quick Check:**\n```powershell\n# Check for 5-character drivers loaded in last hour\nGet-WinEvent -LogName \"Microsoft-Windows-Sysmon/Operational\" -FilterXPath \"*[System[EventID=6] and EventData[Data[@Name='ImageLoaded'] and contains(text(), '.sys')]]\" -MaxEvents 100 | Where-Object {$_.TimeCreated -gt (Get-Date).AddHours(-1)}\n```\n\n**Indicators:**\n- Driver with random 5-char name (e.g., `xYz12.sys`)\n- Known vulnerable drivers: `RTCore64.sys`, `gdrv.sys`, `AsrDrv10x.sys`\n- Followed by: `sc.exe stop MsMpEng` (Defender), `taskkill /IM CSFalconService.exe` (CrowdStrike)\n\n**Containment:**\n- Attempt to restart security services\n- If encryption started, follow ransomware playbook\n- Preserve driver file for analysis: `copy C:\\Windows\\System32\\drivers\\xYz12.sys C:\\Forensics\\`\n\n---\n\n### Rule 100072: Credential Theft + Data Staging (Level 14)\n\n**Quick Check:**\n```powershell\n# Windows: Check for credential dump files\nGet-ChildItem -Path \"C:\\Users\\*\\AppData\\Local\\Temp\",\"C:\\Users\\Public\",\"C:\\Temp\" -Filter \"*password*\",\"*cred*\",\"*login*\" -ErrorAction SilentlyContinue\n\n# Linux:\nfind /tmp /var/tmp /home -name \"*password*\" -o -name \"*cred*\" -o -name \"*login*\" 2>/dev/null\n```\n\n**Indicators:**\n- Browser memory access by non-browser process\n- Files created: `passwords.txt`, `credentials.txt`, `dump.txt`\n- Access to Windows Vault or browser credential databases\n\n**Response:**\n1. Force logout of affected user\n2. Disable account temporarily\n3. Force password reset for ALL accounts on system\n4. Review email sent items (compromised email risk)\n5. Check authentication logs for unauthorized access\n\n---\n\n## Threat-Specific Investigation Guides\n\n### Mirai/Botnet Infection (Rules 100000-100024)\n\n**Symptoms:**\n- UPX-packed ELF binaries in `/tmp`, `/dev/shm`, `/var/tmp`\n- Mass outbound connections (1000+)\n- Brute force attempts on SSH/Telnet/RDP\n- Process enumeration (`ps -ef`, `/proc/` access)\n\n**Investigation Steps:**\n```bash\n# 1. Find suspicious binaries\nfind /tmp /dev/shm /var/tmp -type f -executable -ls\n\n# 2. Check network connections\nnetstat -antp | wc -l  # High count = scanning activity\nss -s  # Connection summary\n\n# 3. Review auth logs for brute force\ngrep \"Failed password\" /var/log/auth.log | tail -50\n\n# 4. Check for persistence\ncrontab -l -u root\ncat /etc/rc.local\nsystemctl list-units --type=service | grep -v \"loaded active\"\n```\n\n**Remediation:**\n- Kill malicious processes\n- Remove binaries and persistence\n- Patch exploited vulnerability (check CVE databases)\n- Implement egress filtering\n- Disable Telnet, secure SSH (key-based auth only)\n\n---\n\n### Credential Theft (Rules 100040-100045)\n\n**Windows Investigation:**\n```powershell\n# Check Sysmon for browser memory access (Event ID 10)\nGet-WinEvent -LogName \"Microsoft-Windows-Sysmon/Operational\" -FilterXPath \"*[System[EventID=10] and EventData[Data[@Name='TargetImage'] and contains(text(), 'chrome.exe')]]\" -MaxEvents 50\n\n# Check file access to credential stores\nGet-WinEvent -LogName Security -FilterXPath \"*[System[EventID=4663] and EventData[Data[@Name='ObjectName'] and contains(text(), 'Login Data')]]\" -MaxEvents 50\n\n# Look for credential enumeration commands\nGet-WinEvent -LogName \"Microsoft-Windows-Sysmon/Operational\" -FilterXPath \"*[System[EventID=1] and EventData[Data[@Name='CommandLine'] and (contains(text(), 'cmdkey') or contains(text(), 'vaultcmd'))]]\" -MaxEvents 50\n```\n\n**Linux Investigation:**\n```bash\n# Check auditd for credential file access\nausearch -f \"/home/*/.mozilla/firefox\" -f \"/home/*/.config/google-chrome\" -ts recent\n\n# Look for credential dump files\nfind /tmp /var/tmp /home -name \"*password*\" -o -name \"*cred*\" -mtime -1\n\n# Check for infostealer malware\nps aux | grep -E \"steal|dump|harvest\" -i\n```\n\n**Identify Infostealer Malware:**\n- **RedLine:** Often named with random chars, exfiltrates to C2 via HTTP POST\n- **Raccoon:** Targets browser profiles, uses Telegram for C2\n- **Vidar:** Uses Telegram/Discord, comprehensive data theft\n- **AZORult:** Targets FTP clients, email, browsers\n\n**Post-Incident:**\n- User notification of credential compromise\n- Password reset for all affected accounts\n- Enable MFA on all accounts\n- Credit monitoring recommendation if financial data stolen\n- Deploy password manager to reduce browser credential storage\n\n---\n\n### Ransomware Detection (Rules 100050-100055)\n\n**Early Warning Indicators (Pre-Encryption):**\n- Shadow copy deletion: `vssadmin delete shadows`\n- Backup service termination: `net stop SQL`, `net stop vss`\n- EDR termination attempts\n- Driver loading (BYOVD technique)\n\n**Active Encryption Indicators:**\n- Mass file modifications (500+ in 2 minutes)\n- New file extensions: `.encrypted`, `.locked`, `.lockbit`, `.lynx`, `.vanhelsing`\n- Ransom notes: `READ_ME.txt`, `HOW_TO_DECRYPT.txt`\n\n**Investigation Checklist:**\n```powershell\n# 1. Identify ransomware variant\nGet-Content \"$env:USERPROFILE\\Desktop\\READ_ME.txt\"  # Analyze ransom note\n\n# 2. Check encryption scope\nGet-ChildItem -Path C:\\ -Recurse -Include *.encrypted,*.locked,*.lockbit -ErrorAction SilentlyContinue | Measure-Object\n\n# 3. Check shadow copies\nvssadmin list shadows  # Are any remaining?\n\n# 4. Review Sysmon for attack timeline\nGet-WinEvent -LogName \"Microsoft-Windows-Sysmon/Operational\" -FilterXPath \"*[System[EventID=1] and EventData[Data[@Name='CommandLine'] and contains(text(), 'vssadmin')]]\"\n\n# 5. Check network for C2 communication\nGet-NetTCPConnection | Where-Object {$_.State -eq \"Established\"}\n```\n\n**Recovery Decision Matrix:**\n\n| Scenario | Action |\n|----------|--------|\n| Backups clean + offline | Restore from backup |\n| Backups encrypted | Check NoMoreRansom.org for decryptor |\n| No backups + no decryptor | Business decision (pay vs. data loss) |\n| Partial encryption | Isolate + attempt recovery |\n\n**Known Ransomware Families (November 2025):**\n- **LockBit 5.0:** Most active, targets enterprises, double extortion\n- **VanHelsing RaaS:** New RaaS platform, fast encryption\n- **Lynx:** Targets Linux/ESXi, uses custom encryption\n\n---\n\n### SharePoint Exploitation (Rules 100060-100066)\n\n**CVE-2025-53770 / CVE-2025-53771 Indicators:**\n- Unauthenticated requests to `/_vti_bin/` endpoints\n- Forged Referer headers (`sharepoint.com`, `office.com`)\n- Deserialization errors in SharePoint ULS logs\n- Large ViewState payloads (>10,000 bytes)\n- Command execution in request parameters\n\n**Investigation:**\n```powershell\n# 1. Review IIS logs for exploitation attempts\nSelect-String -Path \"C:\\inetpub\\logs\\LogFiles\\W3SVC1\\*.log\" -Pattern \"_vti_bin\" | Select-Object -Last 100\n\n# 2. Check for web shells\nGet-ChildItem -Path \"C:\\inetpub\\wwwroot\" -Recurse -Include *.aspx,*.ashx | Where-Object {$_.CreationTime -gt (Get-Date).AddDays(-7)} | Select-Object FullName,CreationTime,LastWriteTime\n\n# 3. Review SharePoint ULS logs for errors\nGet-Content \"C:\\Program Files\\Common Files\\Microsoft Shared\\Web Server Extensions\\*\\LOGS\\*.log\" | Select-String -Pattern \"deserialization|SerializationException\"\n\n# 4. Check for unauthorized SharePoint changes\nGet-SPOSite | Get-SPOUser | Where-Object {$_.IsSiteAdmin -and $_.LoginName -notlike \"*@yourcompany.com\"}\n```\n\n**Emergency Response:**\n1. Block attacker IP at WAF/firewall\n2. Disable affected SharePoint services temporarily\n3. Apply emergency patches\n4. Search for web shells and remove\n5. Review audit logs for data exfiltration\n6. Force password reset for SharePoint service accounts\n\n---\n\n## Common False Positives & Whitelisting\n\n### UPX Detection (Rules 100010-100011)\n\n**Legitimate UPX Usage:**\n- Older games and utilities\n- Penetration testing tools (Metasploit payloads)\n- Embedded/industrial software\n\n**Whitelist by Hash:**\n```xml\n<rule id=\"100015\" level=\"0\">\n  <if_sid>100010,100011</if_sid>\n  <field name=\"file_sha256\">INSERT_LEGITIMATE_HASH_HERE</field>\n  <description>Whitelisted legitimate UPX binary</description>\n</rule>\n```\n\n---\n\n### High Connection Volume (Rules 100020-100024)\n\n**Legitimate High-Traffic Sources:**\n- Web servers and load balancers\n- Monitoring tools (Nagios, Zabbix, Prometheus)\n- Database replication\n\n**Whitelist by Hostname:**\n```xml\n<rule id=\"100025\" level=\"0\">\n  <if_sid>100020,100021,100024</if_sid>\n  <hostname>web-server-01|monitoring-server|db-replication</hostname>\n  <description>Whitelisted high-traffic server</description>\n</rule>\n```\n\n---\n\n### Credential Access (Rules 100040-100042)\n\n**Legitimate Credential Access:**\n- Password managers (LastPass, 1Password, Bitwarden)\n- Backup software (Veeam, Acronis)\n- Browser sync services\n\n**Whitelist Password Managers:**\n```xml\n<rule id=\"100046\" level=\"0\">\n  <if_sid>100040,100041</if_sid>\n  <field name=\"process\">LastPass\\.exe|1Password\\.exe|Bitwarden\\.exe</field>\n  <description>Whitelisted password manager</description>\n</rule>\n```\n\n---\n\n## Quick Commands Reference\n\n### Linux Incident Response\n```bash\n# Isolate system (block outbound)\niptables -P OUTPUT DROP\niptables -A OUTPUT -d 192.168.0.0/16 -j ACCEPT  # Allow internal only\n\n# Capture memory\ndd if=/dev/mem of=/forensics/memory_$(hostname)_$(date +%Y%m%d_%H%M%S).raw bs=1M\n\n# Find suspicious files\nfind /tmp /dev/shm /var/tmp -type f -mtime -1 -ls\nfind / -name \"*.encrypted\" -o -name \"*.locked\" 2>/dev/null\n\n# Network connections\nnetstat -antp | grep ESTABLISHED\nss -tupn | grep ESTAB\n\n# Process list with full paths\nps auxwww | less\n\n# Check persistence\ncrontab -l -u root\ncat /etc/rc.local\nsystemctl list-units --type=service --state=running\nls -la /etc/systemd/system/*.service\n\n# Review auth logs\ngrep \"Failed password\" /var/log/auth.log | tail -100\ngrep \"Accepted\" /var/log/auth.log | tail -50\n```\n\n### Windows Incident Response\n```powershell\n# Isolate system (requires admin)\nSet-NetFirewallProfile -Profile Domain,Public,Private -DefaultOutboundAction Block\n\n# Memory capture (using WinPMEM)\n.\\winpmem_mini_x64_rc2.exe memdump.raw\n\n# Find suspicious files\nGet-ChildItem -Path C:\\Users\\*\\AppData\\Local\\Temp -Recurse | Where-Object {$_.CreationTime -gt (Get-Date).AddHours(-24)}\nGet-ChildItem -Path C:\\ -Recurse -Include *.encrypted,*.locked -ErrorAction SilentlyContinue\n\n# Network connections\nGet-NetTCPConnection | Where-Object {$_.State -eq \"Established\"} | Select-Object LocalAddress,LocalPort,RemoteAddress,RemotePort,OwningProcess,@{Name=\"Process\";Expression={(Get-Process -Id $_.OwningProcess).ProcessName}}\n\n# Process list with command lines\nGet-WmiObject Win32_Process | Select-Object ProcessId,Name,CommandLine | Format-Table -AutoSize\n\n# Check scheduled tasks\nGet-ScheduledTask | Where-Object {$_.State -eq \"Ready\"} | Select-Object TaskName,TaskPath,State\n\n# Review Windows Event Logs\nGet-WinEvent -LogName Security -MaxEvents 100 | Where-Object {$_.Id -eq 4625}  # Failed logins\nGet-WinEvent -LogName \"Microsoft-Windows-Sysmon/Operational\" -MaxEvents 100 | Where-Object {$_.Id -eq 1}  # Process creation\n```\n\n---\n\n## Escalation Matrix\n\n| Alert Type | Severity | Escalate To | SLA |\n|------------|----------|-------------|-----|\n| Ransomware (100051, 100071) | P0 | Incident Commander + CISO | 15 min |\n| RCE Exploitation (100064) | P0 | Incident Commander + Security Lead | 15 min |\n| Known Malware + Botnet (100070) | P0 | SOC Lead + Network Team | 30 min |\n| EDR Killer (100030-100034) | P1 | SOC Lead | 1 hour |\n| Credential Theft Chain (100072) | P1 | SOC Lead + Identity Team | 1 hour |\n| Single Malware Hash (100000-100002) | P1 | Senior Analyst | 1 hour |\n| Botnet Activity (100020-100024) | P2 | SOC Lead | 4 hours |\n| Suspicious Activity (100010-100013) | P2 | Senior Analyst | 4 hours |\n\n---\n\n## Resources\n\n**Threat Intelligence:**\n- MalwareBazaar: https://bazaar.abuse.ch/ (malware samples)\n- AlienVault OTX: https://otx.alienvault.com/ (IOCs)\n- VirusTotal: https://www.virustotal.com/ (hash analysis)\n\n**Ransomware Resources:**\n- NoMoreRansom: https://www.nomoreransom.org/ (decryption tools)\n- ID Ransomware: https://id-ransomware.malwarehunterteam.com/ (variant identification)\n\n**MITRE ATT&CK:**\n- Framework: https://attack.mitre.org/\n- Navigator: https://mitre-attack.github.io/attack-navigator/\n\n**Wazuh Documentation:**\n- Official Docs: https://documentation.wazuh.com/\n- Rule Reference: https://documentation.wazuh.com/current/user-manual/ruleset/\n\n---\n\n## Contact Information\n\n**SOC Team:**\n- Email: soc@company.com\n- Phone: +1-XXX-XXX-XXXX\n- Slack: #soc-alerts\n\n**On-Call Incident Commander:**\n- Phone: +1-XXX-XXX-XXXX (24/7)\n\n**Escalation Path:**\n1. SOC Analyst (L1)\n2. Senior SOC Analyst (L2)\n3. SOC Lead (L3)\n4. Incident Commander\n5. CISO\n\n---\n\n**Quick Reference Version:** 1.0\n**Print Date:** 2025-11-27\n**Next Review:** 2025-12-27\n\n*Keep this guide accessible during incident response. Laminate for desk reference.*\n"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":5469,"cache_read_input_tokens":51654,"cache_creation":{"ephemeral_5m_input_tokens":5469,"ephemeral_1h_input_tokens":0},"output_tokens":5556,"service_tier":"standard"},"context_management":{"applied_edits":[]}},"requestId":"req_011CVXu9nF8brX2NjKcbtV2u","type":"assistant","uuid":"51fd776b-2d44-400e-acdd-a5eb719a036c","timestamp":"2025-11-27T06:14:24.552Z"}
{"parentUuid":"51fd776b-2d44-400e-acdd-a5eb719a036c","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RwWdG8jU6bpgBTQhe4vycR","type":"tool_result","content":"File created successfully at: /home/stanner/soc_analyst_quick_reference.md"}]},"uuid":"d26fdad7-168f-437d-89be-80fcac31a7f5","timestamp":"2025-11-27T06:14:24.620Z","toolUseResult":{"type":"create","filePath":"/home/stanner/soc_analyst_quick_reference.md","content":"# SOC Analyst Quick Reference Guide\n## Wazuh Malware Detection Rules - November 2025 Threats\n\n**Document Version:** 1.0\n**Last Updated:** 2025-11-27\n**Rule ID Range:** 100000-100099\n\n---\n\n## Alert Severity Levels & Response Times\n\n| Severity | Rule Level | Response SLA | Analyst Action |\n|----------|------------|--------------|----------------|\n| CRITICAL | 14-15 | 15 minutes | Immediate escalation + containment |\n| HIGH | 11-13 | 1 hour | Investigate + document + contain |\n| MEDIUM | 8-10 | 4 hours | Investigate + monitor |\n| LOW | 4-7 | 24 hours | Log + periodic review |\n\n---\n\n## Critical Rules - P0 Response Required\n\n### Rule 100051: Ransom Note Created (Level 14)\n```\nALERT: CRITICAL: Ransom note created - Ransomware attack confirmed\n```\n\n**What it means:** Active ransomware attack - files being encrypted RIGHT NOW\n\n**Immediate Actions (within 60 seconds):**\n1. DO NOT shut down the affected system\n2. ISOLATE from network immediately (pull cable or disable switch port)\n3. Alert on-call incident commander\n4. Preserve memory if safe: `dd if=/dev/mem of=/forensics/memory.raw`\n\n**Investigation:**\n- Check ransom note filename and contents for variant identification\n- Identify encryption scope: `find / -name \"*.encrypted\" -o -name \"*.locked\"`\n- Check network shares: are they encrypted too?\n\n**Next Steps:**\n- Activate ransomware playbook\n- Contact backup team to verify backup integrity\n- DO NOT pay ransom without executive approval\n\n---\n\n### Rule 100071: EDR Killer + Ransomware Chain (Level 15)\n```\nALERT: CRITICAL: EDR killer + ransomware attack chain detected\n```\n\n**What it means:** Multi-stage ransomware using BYOVD to disable security tools\n\n**Immediate Actions:**\n1. Network isolation (already late-stage attack)\n2. Check if EDR/AV can be restarted: `systemctl restart wazuh-agent`\n3. Memory capture for forensics\n4. Alert executive leadership\n\n**Investigation:**\n- Identify vulnerable driver loaded: Check Sysmon Event ID 6\n- Review which security services were terminated\n- Timeline reconstruction from first driver load to encryption start\n\n---\n\n### Rule 100064: SharePoint RCE Exploitation (Level 14)\n```\nALERT: CRITICAL: Command execution pattern in SharePoint request - RCE exploitation detected\n```\n\n**What it means:** Attacker executing commands on SharePoint server (CVE-2025-53770/53771)\n\n**Immediate Actions:**\n1. Block source IP at firewall: `iptables -A INPUT -s <ATTACKER_IP> -j DROP`\n2. Stop IIS: `iisreset /stop`\n3. Check for web shells: `dir C:\\inetpub\\wwwroot\\_vti_bin\\*.aspx /s /od`\n\n**Investigation:**\n- Review IIS logs: `C:\\inetpub\\logs\\LogFiles\\W3SVC1\\`\n- Check SharePoint ULS logs for deserialization errors\n- Search for recently created .aspx files\n- Review successful (HTTP 200) POST requests to `/_vti_bin/`\n\n**Next Steps:**\n- Apply emergency patches for CVE-2025-53770 and CVE-2025-53771\n- Restore SharePoint from last known-good backup if compromised\n- Force password reset for all SharePoint service accounts\n\n---\n\n### Rule 100070: Known Malware + Active Botnet (Level 15)\n```\nALERT: CRITICAL: Known malware hash detected with active botnet behavior\n```\n\n**What it means:** System infected with Mirai/RondoDox and actively attacking other systems\n\n**Immediate Actions:**\n1. Block all outbound traffic: `iptables -P OUTPUT DROP`\n2. Capture network traffic: `tcpdump -i eth0 -w /tmp/botnet.pcap`\n3. Kill malicious process: `kill -9 <PID>`\n\n**Investigation:**\n- Identify malware binary: `find /tmp /dev/shm /var/tmp -type f -executable`\n- Extract C2 servers: `netstat -antp | grep ESTABLISHED`\n- Check for persistence: `crontab -l`, `systemctl list-units`, `cat /etc/rc.local`\n\n**Next Steps:**\n- Remove malware binary and persistence mechanisms\n- Force password reset (credential brute force risk)\n- Patch exploited vulnerability\n- Consider full system rebuild\n\n---\n\n## High Priority Rules - P1 Response\n\n### Rule 100002: RondoDox Botnet Hash (Level 14)\n\n**Quick Check:**\n```bash\nsha256sum /tmp/* /dev/shm/* /var/tmp/* 2>/dev/null | grep 5c2bbb00f32b9b196fe1ca35263516a7ebf9fb64ab29b3c85cc320618a6cc6c9\n```\n\n**Indicators:**\n- Mass network scanning (44,000+ connections)\n- Brute force on ports 22, 23, 445, 3389, 5555\n- Process enumeration\n\n**Containment:**\n- Network isolation\n- Block C2 IPs at perimeter\n- Force password reset on all systems\n\n---\n\n### Rule 100031: BYOVD Driver Load + Service Termination (Level 14)\n\n**Quick Check:**\n```powershell\n# Check for 5-character drivers loaded in last hour\nGet-WinEvent -LogName \"Microsoft-Windows-Sysmon/Operational\" -FilterXPath \"*[System[EventID=6] and EventData[Data[@Name='ImageLoaded'] and contains(text(), '.sys')]]\" -MaxEvents 100 | Where-Object {$_.TimeCreated -gt (Get-Date).AddHours(-1)}\n```\n\n**Indicators:**\n- Driver with random 5-char name (e.g., `xYz12.sys`)\n- Known vulnerable drivers: `RTCore64.sys`, `gdrv.sys`, `AsrDrv10x.sys`\n- Followed by: `sc.exe stop MsMpEng` (Defender), `taskkill /IM CSFalconService.exe` (CrowdStrike)\n\n**Containment:**\n- Attempt to restart security services\n- If encryption started, follow ransomware playbook\n- Preserve driver file for analysis: `copy C:\\Windows\\System32\\drivers\\xYz12.sys C:\\Forensics\\`\n\n---\n\n### Rule 100072: Credential Theft + Data Staging (Level 14)\n\n**Quick Check:**\n```powershell\n# Windows: Check for credential dump files\nGet-ChildItem -Path \"C:\\Users\\*\\AppData\\Local\\Temp\",\"C:\\Users\\Public\",\"C:\\Temp\" -Filter \"*password*\",\"*cred*\",\"*login*\" -ErrorAction SilentlyContinue\n\n# Linux:\nfind /tmp /var/tmp /home -name \"*password*\" -o -name \"*cred*\" -o -name \"*login*\" 2>/dev/null\n```\n\n**Indicators:**\n- Browser memory access by non-browser process\n- Files created: `passwords.txt`, `credentials.txt`, `dump.txt`\n- Access to Windows Vault or browser credential databases\n\n**Response:**\n1. Force logout of affected user\n2. Disable account temporarily\n3. Force password reset for ALL accounts on system\n4. Review email sent items (compromised email risk)\n5. Check authentication logs for unauthorized access\n\n---\n\n## Threat-Specific Investigation Guides\n\n### Mirai/Botnet Infection (Rules 100000-100024)\n\n**Symptoms:**\n- UPX-packed ELF binaries in `/tmp`, `/dev/shm`, `/var/tmp`\n- Mass outbound connections (1000+)\n- Brute force attempts on SSH/Telnet/RDP\n- Process enumeration (`ps -ef`, `/proc/` access)\n\n**Investigation Steps:**\n```bash\n# 1. Find suspicious binaries\nfind /tmp /dev/shm /var/tmp -type f -executable -ls\n\n# 2. Check network connections\nnetstat -antp | wc -l  # High count = scanning activity\nss -s  # Connection summary\n\n# 3. Review auth logs for brute force\ngrep \"Failed password\" /var/log/auth.log | tail -50\n\n# 4. Check for persistence\ncrontab -l -u root\ncat /etc/rc.local\nsystemctl list-units --type=service | grep -v \"loaded active\"\n```\n\n**Remediation:**\n- Kill malicious processes\n- Remove binaries and persistence\n- Patch exploited vulnerability (check CVE databases)\n- Implement egress filtering\n- Disable Telnet, secure SSH (key-based auth only)\n\n---\n\n### Credential Theft (Rules 100040-100045)\n\n**Windows Investigation:**\n```powershell\n# Check Sysmon for browser memory access (Event ID 10)\nGet-WinEvent -LogName \"Microsoft-Windows-Sysmon/Operational\" -FilterXPath \"*[System[EventID=10] and EventData[Data[@Name='TargetImage'] and contains(text(), 'chrome.exe')]]\" -MaxEvents 50\n\n# Check file access to credential stores\nGet-WinEvent -LogName Security -FilterXPath \"*[System[EventID=4663] and EventData[Data[@Name='ObjectName'] and contains(text(), 'Login Data')]]\" -MaxEvents 50\n\n# Look for credential enumeration commands\nGet-WinEvent -LogName \"Microsoft-Windows-Sysmon/Operational\" -FilterXPath \"*[System[EventID=1] and EventData[Data[@Name='CommandLine'] and (contains(text(), 'cmdkey') or contains(text(), 'vaultcmd'))]]\" -MaxEvents 50\n```\n\n**Linux Investigation:**\n```bash\n# Check auditd for credential file access\nausearch -f \"/home/*/.mozilla/firefox\" -f \"/home/*/.config/google-chrome\" -ts recent\n\n# Look for credential dump files\nfind /tmp /var/tmp /home -name \"*password*\" -o -name \"*cred*\" -mtime -1\n\n# Check for infostealer malware\nps aux | grep -E \"steal|dump|harvest\" -i\n```\n\n**Identify Infostealer Malware:**\n- **RedLine:** Often named with random chars, exfiltrates to C2 via HTTP POST\n- **Raccoon:** Targets browser profiles, uses Telegram for C2\n- **Vidar:** Uses Telegram/Discord, comprehensive data theft\n- **AZORult:** Targets FTP clients, email, browsers\n\n**Post-Incident:**\n- User notification of credential compromise\n- Password reset for all affected accounts\n- Enable MFA on all accounts\n- Credit monitoring recommendation if financial data stolen\n- Deploy password manager to reduce browser credential storage\n\n---\n\n### Ransomware Detection (Rules 100050-100055)\n\n**Early Warning Indicators (Pre-Encryption):**\n- Shadow copy deletion: `vssadmin delete shadows`\n- Backup service termination: `net stop SQL`, `net stop vss`\n- EDR termination attempts\n- Driver loading (BYOVD technique)\n\n**Active Encryption Indicators:**\n- Mass file modifications (500+ in 2 minutes)\n- New file extensions: `.encrypted`, `.locked`, `.lockbit`, `.lynx`, `.vanhelsing`\n- Ransom notes: `READ_ME.txt`, `HOW_TO_DECRYPT.txt`\n\n**Investigation Checklist:**\n```powershell\n# 1. Identify ransomware variant\nGet-Content \"$env:USERPROFILE\\Desktop\\READ_ME.txt\"  # Analyze ransom note\n\n# 2. Check encryption scope\nGet-ChildItem -Path C:\\ -Recurse -Include *.encrypted,*.locked,*.lockbit -ErrorAction SilentlyContinue | Measure-Object\n\n# 3. Check shadow copies\nvssadmin list shadows  # Are any remaining?\n\n# 4. Review Sysmon for attack timeline\nGet-WinEvent -LogName \"Microsoft-Windows-Sysmon/Operational\" -FilterXPath \"*[System[EventID=1] and EventData[Data[@Name='CommandLine'] and contains(text(), 'vssadmin')]]\"\n\n# 5. Check network for C2 communication\nGet-NetTCPConnection | Where-Object {$_.State -eq \"Established\"}\n```\n\n**Recovery Decision Matrix:**\n\n| Scenario | Action |\n|----------|--------|\n| Backups clean + offline | Restore from backup |\n| Backups encrypted | Check NoMoreRansom.org for decryptor |\n| No backups + no decryptor | Business decision (pay vs. data loss) |\n| Partial encryption | Isolate + attempt recovery |\n\n**Known Ransomware Families (November 2025):**\n- **LockBit 5.0:** Most active, targets enterprises, double extortion\n- **VanHelsing RaaS:** New RaaS platform, fast encryption\n- **Lynx:** Targets Linux/ESXi, uses custom encryption\n\n---\n\n### SharePoint Exploitation (Rules 100060-100066)\n\n**CVE-2025-53770 / CVE-2025-53771 Indicators:**\n- Unauthenticated requests to `/_vti_bin/` endpoints\n- Forged Referer headers (`sharepoint.com`, `office.com`)\n- Deserialization errors in SharePoint ULS logs\n- Large ViewState payloads (>10,000 bytes)\n- Command execution in request parameters\n\n**Investigation:**\n```powershell\n# 1. Review IIS logs for exploitation attempts\nSelect-String -Path \"C:\\inetpub\\logs\\LogFiles\\W3SVC1\\*.log\" -Pattern \"_vti_bin\" | Select-Object -Last 100\n\n# 2. Check for web shells\nGet-ChildItem -Path \"C:\\inetpub\\wwwroot\" -Recurse -Include *.aspx,*.ashx | Where-Object {$_.CreationTime -gt (Get-Date).AddDays(-7)} | Select-Object FullName,CreationTime,LastWriteTime\n\n# 3. Review SharePoint ULS logs for errors\nGet-Content \"C:\\Program Files\\Common Files\\Microsoft Shared\\Web Server Extensions\\*\\LOGS\\*.log\" | Select-String -Pattern \"deserialization|SerializationException\"\n\n# 4. Check for unauthorized SharePoint changes\nGet-SPOSite | Get-SPOUser | Where-Object {$_.IsSiteAdmin -and $_.LoginName -notlike \"*@yourcompany.com\"}\n```\n\n**Emergency Response:**\n1. Block attacker IP at WAF/firewall\n2. Disable affected SharePoint services temporarily\n3. Apply emergency patches\n4. Search for web shells and remove\n5. Review audit logs for data exfiltration\n6. Force password reset for SharePoint service accounts\n\n---\n\n## Common False Positives & Whitelisting\n\n### UPX Detection (Rules 100010-100011)\n\n**Legitimate UPX Usage:**\n- Older games and utilities\n- Penetration testing tools (Metasploit payloads)\n- Embedded/industrial software\n\n**Whitelist by Hash:**\n```xml\n<rule id=\"100015\" level=\"0\">\n  <if_sid>100010,100011</if_sid>\n  <field name=\"file_sha256\">INSERT_LEGITIMATE_HASH_HERE</field>\n  <description>Whitelisted legitimate UPX binary</description>\n</rule>\n```\n\n---\n\n### High Connection Volume (Rules 100020-100024)\n\n**Legitimate High-Traffic Sources:**\n- Web servers and load balancers\n- Monitoring tools (Nagios, Zabbix, Prometheus)\n- Database replication\n\n**Whitelist by Hostname:**\n```xml\n<rule id=\"100025\" level=\"0\">\n  <if_sid>100020,100021,100024</if_sid>\n  <hostname>web-server-01|monitoring-server|db-replication</hostname>\n  <description>Whitelisted high-traffic server</description>\n</rule>\n```\n\n---\n\n### Credential Access (Rules 100040-100042)\n\n**Legitimate Credential Access:**\n- Password managers (LastPass, 1Password, Bitwarden)\n- Backup software (Veeam, Acronis)\n- Browser sync services\n\n**Whitelist Password Managers:**\n```xml\n<rule id=\"100046\" level=\"0\">\n  <if_sid>100040,100041</if_sid>\n  <field name=\"process\">LastPass\\.exe|1Password\\.exe|Bitwarden\\.exe</field>\n  <description>Whitelisted password manager</description>\n</rule>\n```\n\n---\n\n## Quick Commands Reference\n\n### Linux Incident Response\n```bash\n# Isolate system (block outbound)\niptables -P OUTPUT DROP\niptables -A OUTPUT -d 192.168.0.0/16 -j ACCEPT  # Allow internal only\n\n# Capture memory\ndd if=/dev/mem of=/forensics/memory_$(hostname)_$(date +%Y%m%d_%H%M%S).raw bs=1M\n\n# Find suspicious files\nfind /tmp /dev/shm /var/tmp -type f -mtime -1 -ls\nfind / -name \"*.encrypted\" -o -name \"*.locked\" 2>/dev/null\n\n# Network connections\nnetstat -antp | grep ESTABLISHED\nss -tupn | grep ESTAB\n\n# Process list with full paths\nps auxwww | less\n\n# Check persistence\ncrontab -l -u root\ncat /etc/rc.local\nsystemctl list-units --type=service --state=running\nls -la /etc/systemd/system/*.service\n\n# Review auth logs\ngrep \"Failed password\" /var/log/auth.log | tail -100\ngrep \"Accepted\" /var/log/auth.log | tail -50\n```\n\n### Windows Incident Response\n```powershell\n# Isolate system (requires admin)\nSet-NetFirewallProfile -Profile Domain,Public,Private -DefaultOutboundAction Block\n\n# Memory capture (using WinPMEM)\n.\\winpmem_mini_x64_rc2.exe memdump.raw\n\n# Find suspicious files\nGet-ChildItem -Path C:\\Users\\*\\AppData\\Local\\Temp -Recurse | Where-Object {$_.CreationTime -gt (Get-Date).AddHours(-24)}\nGet-ChildItem -Path C:\\ -Recurse -Include *.encrypted,*.locked -ErrorAction SilentlyContinue\n\n# Network connections\nGet-NetTCPConnection | Where-Object {$_.State -eq \"Established\"} | Select-Object LocalAddress,LocalPort,RemoteAddress,RemotePort,OwningProcess,@{Name=\"Process\";Expression={(Get-Process -Id $_.OwningProcess).ProcessName}}\n\n# Process list with command lines\nGet-WmiObject Win32_Process | Select-Object ProcessId,Name,CommandLine | Format-Table -AutoSize\n\n# Check scheduled tasks\nGet-ScheduledTask | Where-Object {$_.State -eq \"Ready\"} | Select-Object TaskName,TaskPath,State\n\n# Review Windows Event Logs\nGet-WinEvent -LogName Security -MaxEvents 100 | Where-Object {$_.Id -eq 4625}  # Failed logins\nGet-WinEvent -LogName \"Microsoft-Windows-Sysmon/Operational\" -MaxEvents 100 | Where-Object {$_.Id -eq 1}  # Process creation\n```\n\n---\n\n## Escalation Matrix\n\n| Alert Type | Severity | Escalate To | SLA |\n|------------|----------|-------------|-----|\n| Ransomware (100051, 100071) | P0 | Incident Commander + CISO | 15 min |\n| RCE Exploitation (100064) | P0 | Incident Commander + Security Lead | 15 min |\n| Known Malware + Botnet (100070) | P0 | SOC Lead + Network Team | 30 min |\n| EDR Killer (100030-100034) | P1 | SOC Lead | 1 hour |\n| Credential Theft Chain (100072) | P1 | SOC Lead + Identity Team | 1 hour |\n| Single Malware Hash (100000-100002) | P1 | Senior Analyst | 1 hour |\n| Botnet Activity (100020-100024) | P2 | SOC Lead | 4 hours |\n| Suspicious Activity (100010-100013) | P2 | Senior Analyst | 4 hours |\n\n---\n\n## Resources\n\n**Threat Intelligence:**\n- MalwareBazaar: https://bazaar.abuse.ch/ (malware samples)\n- AlienVault OTX: https://otx.alienvault.com/ (IOCs)\n- VirusTotal: https://www.virustotal.com/ (hash analysis)\n\n**Ransomware Resources:**\n- NoMoreRansom: https://www.nomoreransom.org/ (decryption tools)\n- ID Ransomware: https://id-ransomware.malwarehunterteam.com/ (variant identification)\n\n**MITRE ATT&CK:**\n- Framework: https://attack.mitre.org/\n- Navigator: https://mitre-attack.github.io/attack-navigator/\n\n**Wazuh Documentation:**\n- Official Docs: https://documentation.wazuh.com/\n- Rule Reference: https://documentation.wazuh.com/current/user-manual/ruleset/\n\n---\n\n## Contact Information\n\n**SOC Team:**\n- Email: soc@company.com\n- Phone: +1-XXX-XXX-XXXX\n- Slack: #soc-alerts\n\n**On-Call Incident Commander:**\n- Phone: +1-XXX-XXX-XXXX (24/7)\n\n**Escalation Path:**\n1. SOC Analyst (L1)\n2. Senior SOC Analyst (L2)\n3. SOC Lead (L3)\n4. Incident Commander\n5. CISO\n\n---\n\n**Quick Reference Version:** 1.0\n**Print Date:** 2025-11-27\n**Next Review:** 2025-12-27\n\n*Keep this guide accessible during incident response. Laminate for desk reference.*\n","structuredPatch":[],"originalFile":null}}
{"parentUuid":"d26fdad7-168f-437d-89be-80fcac31a7f5","isSidechain":true,"userType":"external","cwd":"/home/stanner","sessionId":"fd1cd401-fdca-4b71-ab8b-f3efc32d8192","version":"2.0.55","gitBranch":"","agentId":"c0120225","slug":"hazy-dazzling-floyd","type":"assistant","uuid":"97ee68ad-db1f-4ec6-8f50-5fe959113ffe","timestamp":"2025-11-27T06:14:25.545Z","message":{"id":"1ce57b95-2ea5-4ed7-8e22-32ab02dc2ed0","container":null,"model":"<synthetic>","role":"assistant","stop_reason":"stop_sequence","stop_sequence":"","type":"message","usage":{"input_tokens":0,"output_tokens":0,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":null,"cache_creation":{"ephemeral_1h_input_tokens":0,"ephemeral_5m_input_tokens":0}},"content":[{"type":"text","text":"5-hour limit reached  resets 4am (America/Chicago)  /upgrade to Max or turn on /extra-usage"}],"context_management":null},"error":"rate_limit","isApiErrorMessage":true}
